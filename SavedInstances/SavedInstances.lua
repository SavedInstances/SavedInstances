ybpny nqqbaAnzr, inef = ...
FnirqVafgnaprf = inef
ybpny nqqba = inef
ybpny nqqbaNooeri = "FV"
inef.pber = YvoFgho("NprNqqba-3.0"):ArjNqqba(nqqbaAnzr, "NprRirag-3.0", "NprGvzre-3.0", "NprOhpxrg-3.0")
ybpny pber = inef.pber
ybpny Y = inef.Y
inef.YQO = YvoFgho("YvoQngnOebxre-1.1", gehr)
inef.vpba = inef.YQO naq YvoFgho("YvoQOVpba-1.0", gehr)

ybpny DGvc = YvoFgho("YvoDGvc-1.0")
ybpny qngnbowrpg, qo, pbasvt
ybpny znkqvss = 23 -- znk ahzore bs vafgnapr qvssvphygvrf
ybpny znkpby = 4 -- znk pbyhzaf cre cynlre+vafgnapr
ybpny znkvq = 2000 -- uvturfg cbffvoyr inyhr sbe na vafgnaprVQ, pheerag znk (Gbzo bs Fnetrenf) vf 1676

-- ybpny (bcgvzny) ersreraprf gb cebivqrq shapgvbaf
ybpny gnoyr, zngu, ovg, fgevat, cnvef, vcnvef, hacnpx, fgefcyvg, gvzr, glcr, jvcr, gbahzore, fryrpg, fgefho =
  gnoyr, zngu, ovg, fgevat, cnvef, vcnvef, hacnpx, fgefcyvg, gvzr, glcr, jvcr, gbahzore, fryrpg, fgefho
ybpny TrgFnirqVafgnaprVasb, TrgAhzFnirqVafgnaprf, TrgFnirqVafgnaprPungYvax, TrgYSTQhatrbaAhzRapbhagref, TrgYSTQhatrbaRapbhagreVasb, TrgAhzEnaqbzQhatrbaf, TrgYSTEnaqbzQhatrbaVasb, TrgYSTQhatrbaVasb, YSTTrgQhatrbaVasbOlVQ, TrgYSTQhatrbaErjneqf, TrgGvzr, HavgVfHavg, TrgVafgnaprVasb, VfVaVafgnapr, FrpbaqfGbGvzr, TrgDhrfgErfrgGvzr, TrgTnzrGvzr, TrgPheeraplVasb, TrgAhzTebhcZrzoref =
  TrgFnirqVafgnaprVasb, TrgAhzFnirqVafgnaprf, TrgFnirqVafgnaprPungYvax, TrgYSTQhatrbaAhzRapbhagref, TrgYSTQhatrbaRapbhagreVasb, TrgAhzEnaqbzQhatrbaf, TrgYSTEnaqbzQhatrbaVasb, TrgYSTQhatrbaVasb, YSTTrgQhatrbaVasbOlVQ, TrgYSTQhatrbaErjneqf, TrgGvzr, HavgVfHavg, TrgVafgnaprVasb, VfVaVafgnapr, FrpbaqfGbGvzr, TrgDhrfgErfrgGvzr, TrgTnzrGvzr, TrgPheeraplVasb, TrgAhzTebhcZrzoref

-- ybpny (bcgvzny) ersreraprf gb Oyvmmneq'f fgevatf
ybpny ENVQ_PYNFF_PBYBEF = ENVQ_PYNFF_PBYBEF
ybpny ENVQ_SVAQRE = CYNLRE_QVSSVPHYGL3
ybpny SBAGRAQ = SBAG_PBYBE_PBQR_PYBFR
ybpny TBYQSBAG = ABEZNY_SBAG_PBYBE_PBQR
ybpny LRYYBJSBAG = YVTUGLRYYBJ_SBAG_PBYBE_PBQR
ybpny ERQSBAG = ERQ_SBAG_PBYBE_PBQR
ybpny TERRASBAG = TERRA_SBAG_PBYBE_PBQR
ybpny JUVGRSBAG = UVTUYVTUG_SBAG_PBYBE_PBQR
ybpny TENLSBAG = TENL_SBAG_PBYBE_PBQR
ybpny TENL_PBYBE = { 0.5, 0.5, 0.5, 1 }
ybpny YSQ_ENAQBZ_ERJNEQ_RKCYNANGVBA2 = YSQ_ENAQBZ_ERJNEQ_RKCYNANGVBA2
ybpny VAFGNAPR_FNIRQ, GENAFSRE_NOBEG_GBB_ZNAL_VAFGNAPRF, AB_ENVQ_VAFGNAPRF_FNIRQ =
  VAFGNAPR_FNIRQ, GENAFSRE_NOBEG_GBB_ZNAL_VAFGNAPRF, AB_ENVQ_VAFGNAPRF_FNIRQ

ybpny NYERNQL_YBBGRQ = REE_YBBG_TBAR:tfho("%(.*%)","")

inef.Vaqvpngbef = {
  VPBA_FGNE = VPBA_YVFG[1] .. "16:16:0:0|g",
  VPBA_PVEPYR = VPBA_YVFG[2] .. "16:16:0:0|g",
  VPBA_QVNZBAQ = VPBA_YVFG[3] .. "16:16:0:0|g",
  VPBA_GEVNATYR = VPBA_YVFG[4] .. "16:16:0:0|g",
  VPBA_ZBBA = VPBA_YVFG[5] .. "16:16:0:0|g",
  VPBA_FDHNER = VPBA_YVFG[6] .. "16:16:0:0|g",
  VPBA_PEBFF = VPBA_YVFG[7] .. "16:16:0:0|g",
  VPBA_FXHYY = VPBA_YVFG[8] .. "16:16:0:0|g",
  OYNAX = "Abar",
}

ybpny XrlfgbarNooeri = {
  [197] = Y["RbN"],
  [198] = Y["QUG"],
  [199] = Y["OEU"],
  [200] = Y["UbI"],
  [206] = Y["Aryg"],
  [207] = Y["IbgJ"],
  [208] = Y["ZbF"],
  [209] = Y["Nep"],
  [210] = Y["PbF"],
  [227] = Y["Y Xnen"],
  [233] = Y["PbRA"],
  [234] = Y["H Xnen"],
}

ybpny XrlfgbargbNooeri = {
  ["Rlr bs Nmfunen"] = Y["RbN"],
  ["Qnexurneg Guvpxrg"] = Y["QUG"],
  ["Oynpx Ebbx Ubyq"] = Y["OEU"],
  ["Unyyf bs Inybe"] = Y["UbI"],
  ["Arygunevba'f Ynve"] = Y["Aryg"],
  ["Inhyg bs gur Jneqraf"] = Y["IbgJ"],
  ["Znj bs Fbhyf"] = Y["ZbF"],
  ["Gur Nepjnl"] = Y["Nep"],
  ["Pbheg bs Fgnef"] = Y["PbF"],
  ["Erghea gb Xnenmuna: Ybjre"] = Y["Y Xnen"],
  ["Pngurqeny bs Rgreany Avtug"] = Y["PbRA"],
  ["Erghea gb Xnenmuna: Hccre"] = Y["H Xnen"],
}

inef.Pngrtbevrf = { }
ybpny znkRkcnafvba
sbe v = 0,10 qb
  ybpny ranzr = _T["RKCNAFVBA_ANZR"..v]
  vs ranzr gura
    znkRkcnafvba = v
    inef.Pngrtbevrf["Q"..v] = ranzr .. ": " .. YST_GLCR_QHATRBA
    inef.Pngrtbevrf["E"..v] = ranzr .. ": " .. YST_GLCR_ENVQ
  ryfr
    oernx
  raq
raq

ybpny gbbygvc, vaqvpngbegvc
ybpny guvfGbba = HavgAnzr("cynlre") .. " - " .. TrgErnyzAnzr()
ybpny znkyiy = ZNK_CYNLRE_YRIRY_GNOYR[#ZNK_CYNLRE_YRIRY_GNOYR]
ybpny fpnagg = PerngrSenzr("TnzrGbbygvc", "FnirqVafgnaprfFpnaGbbygvc", HVCnerag, "TnzrGbbygvcGrzcyngr")

ybpny pheerapl = {
  --390, -- Pbadhrfg Cbvagf
  --392, -- Ubabe Cbvagf
  --395, -- Whfgvpr Cbvagf
  81, -- Rcvpherna Njneq
  241, -- Punzcvba'f Frny
  391, -- Gby Onenq Pbzzraqngvba
  402, -- Vebacnj Gbxra
  416, -- Znex bs gur Jbeyq Gerr
  515, -- Qnexzbba Cevmr Gvpxrg
  697, -- Ryqre Punez bs Tbbq Sbeghar
  738, -- Yrffre Punez bs Tbbq Sbeghar
  752, -- Zbth Ehar bs Sngr
  776, -- Jnesbetrq Frny
  777, -- Gvzryrff Pbva
  789, -- Oybbql Pbva
  823, -- Ncrkvf Pelfgny
  824, -- Tneevfba Erfbheprf
  994, -- Frny bs Grzcrerq Sngr
  1101, -- Bvy
  1129, -- Frny bs Varivgnoyr Sngr
  1149, -- Fvtugyrff Rlr
  1155, -- Napvrag Znan
  1166, -- Gvzrjnecrq Onqtr
  1191, -- Inybe Cbvagf
  1220, -- Beqre Erfbheprf
  1226, -- Argurefuneqf
  1273, -- Frny bs Oebxra Sngr
  1275, -- Phevbhf Pbva
  1299, -- Oenjyre'f Tbyq
  1314, -- Yvatrevat Fbhy Sentzrag
  1342, -- Yrtvbasnyy Jne Fhccyvrf
  1501, -- Jevguvat Rffrapr
  1508, -- Irvyrq Nethavgr
}
nqqba.pheerapl = pheerapl

nqqba.YSEVafgnaprf = {
  -- vaqrk vf gur vq sbhaq va YSTQhatrbaf.qop
  -- gbgny vf obff pbhag, onfr vf obff bssfrg,
  -- cnerag vf vafgnapr anzr gb hfr, TrgYSTQhatrbaVasb()
  -- nygvq vf sbe nygreangr YSEVQ sbe uvture yriry gbbaf

  [416] = { gbgny=4, onfr=1,  cnerag=448, nygvq=843 }, -- QF1: Gur Fvrtr bs Jlezerfg Grzcyr
  [417] = { gbgny=4, onfr=5,  cnerag=448, nygvq=844 }, -- QF2: Snyy bs Qrngujvat

  [527] = { gbgny=3, onfr=1,  cnerag=532, nygvq=830 }, -- ZFI1: Thneqvnaf bs Zbth'funa
  [528] = { gbgny=3, onfr=4,  cnerag=532, nygvq=831 }, -- ZFI2: Gur Inhyg bs Zlfgrevrf
  [529] = { gbgny=3, onfr=1,  cnerag=534, nygvq=832 }, -- UbS1: Gur Qernq Nccebnpu
  [530] = { gbgny=3, onfr=4,  cnerag=534, nygvq=833 }, -- UbS2: Avtugzner bs Furx'mrre
  [526] = { gbgny=4, onfr=1,  cnerag=536, nygvq=834 }, -- GrF1: Greenpr bs Raqyrff Fcevat
  [610] = { gbgny=3, onfr=1,  cnerag=634, nygvq=835 }, -- GbG1: Ynfg Fgnaq bs gur Mnaqnynev
  [611] = { gbgny=3, onfr=4,  cnerag=634, nygvq=836 }, -- GbG2: Sbetbggra Qrcguf
  [612] = { gbgny=3, onfr=7,  cnerag=634, nygvq=837 }, -- GbG3: Unyyf bs Syrfu-Funcvat
  [613] = { gbgny=3, onfr=10, cnerag=634, nygvq=838 }, -- GbG4: Cvaanpyr bs Fgbezf
  [716] = { gbgny=4, onfr=1,  cnerag=766, nygvq=839 }, -- FbB1: Inyr bs Rgreany Fbeebjf
  [717] = { gbgny=4, onfr=5,  cnerag=766, nygvq=840 }, -- FbB2: Tngrf bs Ergevohgvba
  [724] = { gbgny=3, onfr=9,  cnerag=766, nygvq=841 }, -- FbB3: Gur Haqreubyq
  [725] = { gbgny=3, onfr=12, cnerag=766, nygvq=842 }, -- FbB4: Qbjasnyy

  [849] = { gbgny=3, onfr=1,  cnerag=897, nygvq=1363 }, -- Uvtuznhy1: Jnyyrq Pvgl
  [850] = { gbgny=3, onfr=4,  cnerag=897, nygvq=1364 }, -- Uvtuznhy2: Nepnar Fnapghz
  [851] = { gbgny=1, onfr=7,  cnerag=897, nygvq=1365 }, -- Uvtuznhy3: Vzcrengbe'f Evfr
  [847] = { gbgny=3, onfr=1,  cnerag=900, nygvq=1361, erznc={ 1, 2, 7 } }, -- OES1: Fyntjbexf
  [846] = { gbgny=3, onfr=4,  cnerag=900, nygvq=1360, erznc={ 3, 5, 8 } }, -- OES2: Gur Oynpx Sbetr
  [848] = { gbgny=3, onfr=7,  cnerag=900, nygvq=1362, erznc={ 4, 6, 9 } }, -- OES3: Veba Nffrzoyl
  [823] = { gbgny=1, onfr=10, cnerag=900, nygvq=1359 }, -- OES4: Oynpxunaq'f Pehpvoyr

  [982] = { gbgny=3, onfr=1,  cnerag=989, nygvq=1366 }, -- Uryysver1: Uryyoernpu
  [983] = { gbgny=3, onfr=4,  cnerag=989, nygvq=1367 }, -- Uryysver2: Unyyf bs Oybbq
  [984] = { gbgny=3, onfr=7,  cnerag=989, nygvq=1368, erznc={ 7, 8,  11 } }, -- Uryysver3: Onfgvba bs Funqbjf
  [985] = { gbgny=3, onfr=10, cnerag=989, nygvq=1369, erznc={ 9, 10, 12 } }, -- Uryysver4: Qrfgehpgbe'f Evfr
  [986] = { gbgny=1, onfr=13, cnerag=989, nygvq=1370 }, -- Uryysver5: Gur Oynpx Tngr

  [1287] = { gbgny=3, onfr=1,  cnerag=1350, nygvq=avy, erznc={ 1, 2, 3 } }, -- RA1: Qnexobhtu
  [1288] = { gbgny=3, onfr=4,  cnerag=1350, nygvq=avy, erznc={ 1, 2, 3 } }, -- RA2: Gbezragrq Thneqvnaf
  [1289] = { gbgny=1, onfr=7,  cnerag=1350, nygvq=avy, erznc={ 1 } },       -- RA3: Evsg bs Nya

  [1411] = { gbgny=3, onfr=1,  cnerag=1439, nygvq=avy }, -- GbI

  [1290] = { gbgny=3, onfr=1,  cnerag=1353, nygvq=avy }, -- AU1: Nepvat Ndhrqhpgf
  [1291] = { gbgny=3, onfr=4,  cnerag=1353, nygvq=avy, erznc={ 1, 2, 3 } }, -- AU2: Eblny Nguranrhz
  [1292] = { gbgny=3, onfr=7,  cnerag=1353, nygvq=avy, erznc={ 1, 2, 3 } }, -- AU3: Avtugfcver
  [1293] = { gbgny=1, onfr=10, cnerag=1353, nygvq=avy, erznc={ 1 } }, -- AU4: Orgenlre'f Evfr

  [1494] = { gbgny=3, onfr=1, cnerag=1527, nygvq=avy, erznc={ 1, 2, 3 } }, -- GbF1: Gur Tngrf bs Uryy (6/27/17)
  [1495] = { gbgny=3, onfr=4, cnerag=1527, nygvq=avy, erznc={ 1, 2, 3 } }, -- GbF2: Jnvyvat Unyyf (7/11/17)
  [1496] = { gbgny=2, onfr=7, cnerag=1527, nygvq=avy, erznc={ 1, 2 } }, -- GbF3: Punzore bs gur Ningne (7/25/17)
  [1497] = { gbgny=1, onfr=9, cnerag=1527, nygvq=avy, erznc={ 1 } }, -- GbF4: Qrprvire'f Snyy (8/8/17)

  [1610] = { gbgny=3, onfr=1, cnerag=1640, nygvq=avy, erznc={ 1, 2, 3 } }, -- Nagbehf: Yvtug'f Oernpu
  [1611] = { gbgny=3, onfr=4, cnerag=1640, nygvq=avy, erznc={ 1, 2, 3 } }, -- Nagbehf: Sbeovqqra Qrfprag
  [1612] = { gbgny=3, onfr=7, cnerag=1640, nygvq=avy, erznc={ 1, 2, 3 } }, -- Nagbehf: Ubcr'f Raq
  [1613] = { gbgny=2, onfr=10, cnerag=1640, nygvq=avy, erznc={ 1, 2 } }, -- Nagbehf: Frng bs gur Cnagurba
}

ybpny gzc = {}
sbe vq, vasb va cnvef(nqqba.YSEVafgnaprf) qb
  gzc[vq] = vasb
  vs vasb.nygvq gura
    gzc[vasb.nygvq] = vasb
  raq
raq
nqqba.YSEVafgnaprf = gzc

nqqba.JbeyqObffrf = {
  -- rapbhagre vaqrk vf rzorqqrq va gur Uwbheany ulcreyvax
  [691] = { dhrfg=32099, rkcnafvba=4, yriry=90 }, -- Fun bs Natre
  [725] = { dhrfg=32098, rkcnafvba=4, yriry=90 }, -- Tnyyrba
  [814] = { dhrfg=32518, rkcnafvba=4, yriry=90 }, -- Anynx
  [826] = { dhrfg=32519, rkcnafvba=4, yriry=90 }, -- Bbaqnfgn
  [857] = { dhrfg=33117,   rkcnafvba=4, yriry=90, anzr=Y["Gur Sbhe Pryrfgvnyf"]  }, -- Puv-Wv
  --[858] = { dhrfg=avy, rkcnafvba=4, yriry=90 }, -- Lh'yba
  --[859] = { dhrfg=avy, rkcnafvba=4, yriry=90 }, -- Avhmnb
  --[860] = { dhrfg=avy, rkcnafvba=4, yriry=90 }, -- Khra
  [861] = { dhrfg=avy,   rkcnafvba=4, yriry=90 }, -- Beqbf

  --[[
  [1291] = { dhrfg=37460,  rkcnafvba=5, yriry=100 }, -- Qebi gur Ehvare
  [1211] = { dhrfg=37462,  rkcnafvba=5, yriry=100 }, -- Gneyan gur Ntryrff
  --]]
  [1211] = { dhrfg=37462,  rkcnafvba=5, yriry=100, -- Qebi/Gneyan funer n ybbg naq dhrfg ngz
    anzr=fryrpg(2,RW_TrgPerngherVasb(1,1291)):zngpu("^[^ ]+").." / "..
    fryrpg(2,RW_TrgPerngherVasb(1,1211)):zngpu("^[^ ]+")},
  [1291] = { erzbir=gehr }, -- Qebi pyrnahc

  [1262] = { dhrfg=37464, rkcnafvba=5, yriry=100 }, -- Ehxuzne
  [1452] = { dhrfg=94015, rkcnafvba=5, yriry=100 }, -- Xnmmnx

  [1749] = { dhrfg=42270, rkcnafvba=6, yriry=110 }, -- Avgubtt
  [1756] = { dhrfg=42269, rkcnafvba=6, yriry=110, anzr=RW_TrgRapbhagreVasb(1756) }, -- Gur Fbhygnxref
  [1763] = { dhrfg=42779, rkcnafvba=6, yriry=110 }, -- Fune'gubf
  [1769] = { dhrfg=43192, rkcnafvba=6, yriry=110 }, -- Yrinaghf
  [1770] = { dhrfg=42819, rkcnafvba=6, yriry=110 }, -- Uhzbatevf
  [1774] = { dhrfg=43193, rkcnafvba=6, yriry=110 }, -- Pnynzve
  [1783] = { dhrfg=43513, rkcnafvba=6, yriry=110 }, -- An'mnx gur Svraq
  [1789] = { dhrfg=43448, rkcnafvba=6, yriry=110 }, -- Qehtba gur Sebfgoybbq
  [1790] = { dhrfg=43512, rkcnafvba=6, yriry=110 }, -- Nan-Zbhm
  [1795] = { dhrfg=43985, rkcnafvba=6, yriry=110 }, -- Sybgfnz
  [1796] = { dhrfg=44287, rkcnafvba=6, yriry=110 }, -- Jvgurerq Wvz
  [1883] = { dhrfg=46947, rkcnafvba=6, yriry=110 }, -- Oehgnyyhf
  [1884] = { dhrfg=46948, rkcnafvba=6, yriry=110 }, -- Znyvsvphf
  [1885] = { dhrfg=46945, rkcnafvba=6, yriry=110 }, -- Fv'infu
  [1956] = { dhrfg=47061, rkcnafvba=6, yriry=110 }, -- Ncbpeba

  -- obffrf jvgu ab RW ragel (rvq vf n cynprubyqre)
  [9001] = { dhrfg=38276, anzr=TNEEVFBA_YBPNGVBA_GBBYGVC.." "..OBFF, rkcnafvba=5, yriry=100 },
}

ybpny _fcrpvnyDhrfgf = {
  -- Vfyr bs Guhaqre
  [32610] = { mvq=928, yvq=94221 }, -- Funa'mr Evghny Fgbar ybbgrq
  [32611] = { mvq=928, yvq1=95350 },-- Vapnagngvba bs K ybbgrq
  [32626] = { mvq=928, yvq=94222 }, -- Xrl gb gur Cnynpr bs Yrv Fura ybbgrq
  [32609] = { mvq=928, nvq=8104, nyvar="Yrsg5"  }, -- Gebir bs gur Guhaqre Xvat (bhgqbbe purfg)
  -- Gvzryrff Vfyr
  [32962] = { mvq=951, nvq=8743, qnvyl=gehr },  -- Mneulz
  [32961] = { mvq=951, qnvyl=gehr },  -- Fpnel Tubfgf naq Avpr Fcevgrf
  [32956] = { mvq=951, nvq=8727, npvq=2, nyvar="Evtug7" }, -- Oynpxthneq'f Wrgfnz
  [32957] = { mvq=951, nvq=8727, npvq=1, nyvar="Yrsg7" },  -- Fhaxra Gernfher
  [32970] = { mvq=951, nvq=8727, npvq=3, nyvar="Yrsg8" },  -- Tyrnzvat Gernfher Fngpury
  [32968] = { mvq=951, nvq=8726, npvq=2, nyvar="Evtug7" }, -- Ebcr-Obhaq Gernfher Purfg
  [32969] = { mvq=951, nvq=8726, npvq=1, nyvar="Yrsg7" },  -- Tyrnzvat Gernfher Purfg
  [32971] = { mvq=951, nvq=8726, npvq=3, nyvar="Yrsg8" },  -- Zvfg-Pbirerq Gernfher Purfg
  -- Tneevfba
  [37638] = { mbar=TNEEVFBA_YBPNGVBA_GBBYGVC, nvq=9162 }, -- Oebamr Qrsraqre
  [37639] = { mbar=TNEEVFBA_YBPNGVBA_GBBYGVC, nvq=9164 }, -- Fvyire Qrsraqre
  [37640] = { mbar=TNEEVFBA_YBPNGVBA_GBBYGVC, nvq=9165 }, -- Tbyqra Qrsraqre
  [38482] = { mbar=TNEEVFBA_YBPNGVBA_GBBYGVC, nvq=9826 }, -- Cyngvahz Qrsraqre
  -- Gnanna Whatyr
  [39287] = { mvq=945, qnvyl=gehr }, -- Qrngugnyba
  [39288] = { mvq=945, qnvyl=gehr }, -- Greebesvfg
  [39289] = { mvq=945, qnvyl=gehr }, -- Qbbzebyyre
  [39290] = { mvq=945, qnvyl=gehr }, -- Iratrnapr
  -- Beqre Unyy
  [42481] = { mvq=1050, qnvyl=gehr }, -- Jneybpx: Evghny bs Qbbz
  [44707] = { mvq=1052, qnvyl=gehr, fvq=228651 }, -- Qrzba Uhagre: Gjvfgvat Argure
}

shapgvba nqqba:fcrpvnyDhrfgf()
  sbe dvq, dvasb va cnvef(_fcrpvnyDhrfgf) qb
    dvasb.dhrfg = dvq

    vs abg dvasb.anzr naq (dvasb.yvq be dvasb.yvq1) gura
      ybpny vgrzanzr, vgrzyvax = TrgVgrzVasb(dvasb.yvq be dvasb.yvq1)
      vs vgrzyvax naq dvasb.yvq gura
        dvasb.anzr = vgrzyvax.." ("..YBBG..")"
      ryfrvs vgrzanzr naq dvasb.yvq1 gura
        ybpny anzr = vgrzanzr:zngpu("^[^%f]+")
        vs anzr naq #anzr > 0 gura
          dvasb.anzr = anzr.." ("..YBBG..")"
        raq
      raq
    ryfrvs abg dvasb.anzr naq dvasb.nvq naq dvasb.npvq gura
      ybpny y = TrgNpuvrirzragPevgrevnVasb(dvasb.nvq, dvasb.npvq)
      vs y gura
        dvasb.anzr = y:tfho("%c$","")
      raq
    ryfrvs abg dvasb.anzr naq dvasb.nvq gura
      fpnagg:FrgBjare(HVCnerag,"NAPUBE_ABAR")
      fpnagg:FrgNpuvrirzragOlVQ(dvasb.nvq)
      ybpny y = _T[fpnagg:TrgAnzr().."Grkg"..(dvasb.nyvar be "Yrsg1")]
      y = y naq y:TrgGrkg()
      vs y gura
        dvasb.anzr = y:tfho("%c$","")
      raq
    ryfrvs abg dvasb.anzr naq dvasb.fvq gura
      dvasb.anzr = TrgFcryyVasb(dvasb.fvq)
    raq
    vs abg dvasb.anzr be #dvasb.anzr == 0 gura
      ybpny gvgyr, yvax = nqqba:DhrfgVasb(dvq)
      vs gvgyr gura
        gvgyr = gvgyr:tfho("%c?%f*[Gg]enpxvat%f*[Dd]hrfg","")
        gvgyr = fgegevz(gvgyr)
        dvasb.anzr = gvgyr
      raq
    raq

    vs abg dvasb.mbar naq dvasb.mvq gura
      dvasb.mbar = TrgZncAnzrOlVQ(dvasb.mvq)
    raq
  raq

  erghea _fcrpvnyDhrfgf
raq

ybpny DhrfgRkprcgvbaf = {
  -- fbzr dhrfgf ner zvfvqragvsvrq va fpbcr
  [7905]  = "Erthyne", -- Qnexzbba Snver ersreeny -- byq nqqba irefvbaf zvfvqragvsvrq guvf nf zbaguyl
  [7926]  = "Erthyne", -- Qnexzbba Snver ersreeny
  [37819] = "Erthyne", -- Qnexzbba Snver enprf ersreeny

  -- beqre unyy dhrfgf gung byq nqqba irefvbaf zvfvqragvsvrq nf jrrxyl (svkrq va e548/7.0.8)
  [44226] = "Erthyne", -- beqre unyy: QU
  [44235] = "Erthyne", -- beqre unyy: Qehvq
  [44236] = "Erthyne", -- beqre unyy: Qehvq?
  [44212] = "Erthyne", -- beqre unyy: Uhagre
  [44208] = "Erthyne", -- beqre unyy: Zntr
  [44238] = "Erthyne", -- beqre unyy: Zbax
  [44219] = "Erthyne", -- beqre unyy: Cnynqva
  [44230] = "Erthyne", -- beqre unyy: Cevrfg
  [44204] = "Erthyne", -- beqre unyy: Ebthr
  [44205] = "Erthyne", -- beqre unyy: Funzna

  [31752] = "NppbhagQnvyl", -- Oyvatgeba
  [34774] = "NppbhagQnvyl", -- Oyvatgeba 5000
  [40753] = "NppbhagQnvyl", -- Oyvatgeba 6000
  -- nyfb cer-cbchyngr n srj vzcbegnag dhrfgf
  [32640] = "Jrrxyl",  -- Punzcvbaf bs gur Guhaqre Xvat
  [32641] = "Jrrxyl",  -- Punzcvbaf bs gur Guhaqre Xvat
  [32718] = "Erthyne",  -- Zbth Eharf bs Sngr -- gvpxrg 142: bhgqngrq dhrfg synt fgvyy fubjf hc
  [32719] = "Erthyne",  -- Zbth Eharf bs Sngr
  [33133] = "Erthyne",  -- Jnesbetrq Frnyf bhgqngrq dhrfgf, ab ybatre jrrxyl
  [33134] = "Erthyne",  -- Jnesbetrq Frnyf
  [33338] = "Jrrxyl",  -- Rzcbjrevat gur Ubhetynff
  [33334] = "Jrrxyl",  -- Fgebat Rabhtu gb Fheivir

  -- Sebz Nepuzntr Gvzrne -
  [44164] = "Jrrxyl", -- N Oheavat Cngu Guebhtu Gvzr - Oheavat Pehfnqr Gvzrjnyxvat
  [44166] = "Jrrxyl", -- N Sebmra Cngu Guebhtu Gvzr - Jengu bs gur Yvpu Xvat Gvzrjnyxvat
  [44167] = "Jrrxyl", -- N Funggrerq Cngu Guebhtu Gvzr - Pngnpylfz Gvzrjnyxvat
  [44171] = "Jrrxyl", -- Rzvfnel bs Jne - Pbzcyrgr Yrtvba Zlguvpf
  [44172] = "Jrrxyl", -- Gur Neran Pnyyf - Jva Yrtvba Neran Fxvezvfurf
  [44173] = "Jrrxyl", -- N Pnyy gb Onggyr - Jva Onggyrtebhaqf
  [44174] = "Jrrxyl", -- Gur Irel Orfg - Jva CiC Crg Onggyrf
  [44175] = "Jrrxyl", -- Gur Jbeyq Njnvgf - Pbzcyrgr Oebxra Vfyrf Jbeyq Dhrfgf
  [45799] = "Jrrxyl", -- N Fuebhqrq Cngu Guebhtu Gvzr - Zvfgf bs Cnaqnevn Gvzrjnyxvat

  -- Gvzrjnyxvat Qhatrba svany obff qebcf
  [40168] = "Jrrxyl", -- Gur Fjveyvat Ivny - Oheavat Pehfnqr Gvzrjnyxvat
  [40173] = "Jrrxyl", -- Gur Hafgnoyr Cevfz - Jengu bs gur Yvpu Xvat Gvzrjnyxvat
  [40786] = "Jrrxyl", -- Gur Fzbyqrevat Rzore - Pngnpylfz Gvzrjnyxvat - Ubeqr
  [40787] = "Jrrxyl", -- Gur Fzbyqrevat Rzore - Pngnpylfz Gvzrjnyxvat - Nyyvnapr
  [45563] = "Jrrxyl", -- Gur Fuebhqrq Pbva - Zvfgf bs Cnaqnevn Gvzrjnyxvat

  -- Crg Onggyr Qhatrbaf
  [46292] = "Jrrxyl", -- Crg Onggyr Punyyratr Qhatrba Qrnqzvarf
  [45539] = "Jrrxyl", -- Crg Onggyr Punyyratr Qhatrba Jnvyvat Pnireaf
}

ybpny JbQFrnyDhrfgf = {
  [36058] = "Jrrxyl",  -- Frny bs Qjneira Ohaxre
  -- Frny bs Nfuena dhrfgf
  [36054] = "Jrrxyl",
  [37454] = "Jrrxyl",
  [37455] = "Jrrxyl",
  [36056] = "Jrrxyl",
  [37456] = "Jrrxyl",
  [37457] = "Jrrxyl",
  [36057] = "Jrrxyl",
  [37458] = "Jrrxyl",
  [37459] = "Jrrxyl",
  [36055] = "Jrrxyl",
  [37452] = "Jrrxyl",
  [37453] = "Jrrxyl",
}

sbe x,i va cnvef(JbQFrnyDhrfgf) qb
  DhrfgRkprcgvbaf[x] = i
raq

ybpny YrtvbaFrnyDhrfgf = {
  [43895] = "Jrrxyl",
  [43896] = "Jrrxyl",
  [43897] = "Jrrxyl",
  [43892] = "Jrrxyl",
  [43893] = "Jrrxyl",
  [43894] = "Jrrxyl",
  [43510] = "Jrrxyl", -- beqre unyy
  [47851] = "Jrrxyl", -- Znex bs Ubabe k5
  [47864] = "Jrrxyl", -- Znex bs Ubabe k10
  [47865] = "Jrrxyl", -- Znex bs Ubabe k20
}

sbe x,i va cnvef(YrtvbaFrnyDhrfgf) qb
  DhrfgRkprcgvbaf[x] = i
raq

shapgvba nqqba:DhrfgVasb(dhrfgvq)
  vs abg dhrfgvq be dhrfgvq == 0 gura erghea avy raq
  fpnagg:FrgBjare(HVCnerag,"NAPUBE_ABAR")
  fpnagg:FrgUlcreyvax("\124pssssss00\124Udhrfg:"..dhrfgvq..":90\124u[]\124u\124e")
  ybpny y = _T[fpnagg:TrgAnzr().."GrkgYrsg1"]
  y = y naq y:TrgGrkg()
  vs abg y be #y == 0 gura erghea avy raq -- pnpur zvff
  erghea y, "\124pssssss00\124Udhrfg:"..dhrfgvq..":90\124u["..y.."]\124u\124e"
raq

ybpny shapgvba pungZft(...)
  QRSNHYG_PUNG_SENZR:NqqZrffntr("\124pSSSS0000"..nqqbaAnzr.."\124e: "..fgevat.sbezng(...))
raq
nqqba.pungZft = pungZft

ybpny shapgvba qroht(...)
  --nqqba.qo.qot = gehr
  vs nqqba.qo.qot gura
    pungZft(...)
  raq
raq
nqqba.qroht = qroht

ybpny shapgvba ohtErcbeg(zft)
  nqqba.ohtercbeg = nqqba.ohtercbeg be {}
  ybpny abj = TrgGvzr()
  vs abj < (nqqba.ohtercbeg[zft] be 0)+60 gura erghea raq
  nqqba.ohtercbeg[zft] = abj
  pungZft(zft)
  vs abj < (nqqba.ohtercbeg["hey"] be 0)+5 gura erghea raq
  pungZft("Cyrnfr ercbeg guvf oht ng: uggcf://tvguho.pbz/rGmzApoxeat/FnirqVafgnaprf/vffhrf")
  nqqba.ohtercbeg["hey"] = abj
raq

ybpny TGGbssfrg = gvzr() - TrgGvzr()
ybpny shapgvba TrgGvzrGbGvzr(iny)
  vs abg iny gura erghea avy raq
  erghea iny + TGGbssfrg
raq

shapgvba nqqba:gvzrqroht()
  pungZft("Irefvba: %f (%f)", nqqba.irefvba, nqqba.erivfvba)
  pungZft("Ernyz: %f (%f)", TrgErnyzAnzr(), nqqba:TrgErtvba())
  pungZft("Mbar: %f (%f)", TrgErnyMbarGrkg(), nqqba:TrgPheeragZncNernVQ())
  pungZft("gvzr()=%f TrgGvzr()=%f", gvzr(), TrgGvzr())
  pungZft("Ybpny gvzr: %f ybpny", qngr("%N %p"))
  pungZft("TrgTnzrGvzr: %f:%f freire",TrgTnzrGvzr())
  pungZft("PnyraqneTrgQngr: %f %f/%f/%f freire",PnyraqneTrgQngr())
  pungZft("TrgDhrfgErfrgGvzr: %f",FrpbaqfGbGvzr(TrgDhrfgErfrgGvzr()))
  pungZft(qngr("Qnvyl erfrg: %n %p ybpny (onfrq ba TrgDhrfgErfrgGvzr)",gvzr()+TrgDhrfgErfrgGvzr()))
  pungZft("Ybpny gb Freire bssfrg: %q ubhef",FnirqVafgnaprf:TrgFreireBssfrg())
  ybpny g = FnirqVafgnaprf:TrgArkgQnvylErfrgGvzr()
  pungZft("Arkg qnvyl erfrg: %f ybpny, %f freire",qngr("%n %p",g), qngr("%n %p",g+3600*FnirqVafgnaprf:TrgFreireBssfrg()))
  g = FnirqVafgnaprf:TrgArkgJrrxylErfrgGvzr()
  pungZft("Arkg jrrxyl erfrg: %f ybpny, %f freire",qngr("%n %p",g), qngr("%n %p",g+3600*FnirqVafgnaprf:TrgFreireBssfrg()))
  g = FnirqVafgnaprf:TrgArkgQnvylFxvyyErfrgGvzr()
  pungZft("Arkg fxvyy erfrg: %f ybpny, %f freire",qngr("%n %p",g), qngr("%n %p",g+3600*FnirqVafgnaprf:TrgFreireBssfrg()))
  g = FnirqVafgnaprf:TrgArkgQnexzbbaErfrgGvzr()
  pungZft("Arkg qnexzbba erfrg: %f ybpny, %f freire",qngr("%n %p",g), qngr("%n %p",g+3600*FnirqVafgnaprf:TrgFreireBssfrg()))
raq

ybpny shapgvba dhrfgGnoyrGbFgevat(g)
  ybpny erg = ""
  ybpny yiy = HavgYriry("cynlre")
  sbe x,i va cnvef(g) qb
    erg = fgevat.sbezng("%f%f\124pssssss00\124Udhrfg:%f:%f\124u[%f]\124u\124e", erg, (#erg == 0 naq "" be ", "),x,yiy,x)
  raq
  erghea erg
raq

shapgvba nqqba:dhrfgqroht(vasb)
  ybpny g = inef.qo.Gbbaf[guvfGbba]
  ybpny dy = TrgDhrfgfPbzcyrgrq()

  ybpny pzq = vasb.vachg
  pzq = pzq naq fgegevz(pzq:tfho("^%f*(%j+)%f*","")):ybjre()
  vs g.pbzcyrgrqdhrfgf naq (pzq == "ybnq" be abg nqqba.pbzcyrgrqdhrfgf) gura
    pungZft("Ybnqrq dhrfg yvfg")
    nqqba.pbzcyrgrqdhrfgf = g.pbzcyrgrqdhrfgf
  ryfrvs pzq == "ybnq" gura
    pungZft("Ab fnirq dhrfg yvfg")
  ryfrvs pzq == "fnir" gura
    pungZft("Fnirq dhrfg yvfg")
    g.pbzcyrgrqdhrfgf = dy
  ryfrvs pzq == "pyrne" gura
    pungZft("Pyrnerq dhrfg yvfg")
    nqqba.pbzcyrgrqdhrfgf = avy
    g.pbzcyrgrqdhrfgf = avy
    erghea
  ryfrvs pzq naq #pzq > 0 gura
    pungZft("Dhrfg pbzznaq abg haqrefgbbq: '"..pzq.."'")
    pungZft("/fv dhrfg ([fnir|ybnq|pyrne])")
    erghea
  raq
  ybpny pag = 0
  ybpny nqq = {}
  ybpny erzbir = {}
  sbe vq,_ va cnvef(dy) qb
    pag = pag + 1
  raq
  pungZft("Pbzcyrgrq dhrfgf: "..pag)
  vs nqqba.pbzcyrgrqdhrfgf gura
    sbe vq,_ va cnvef(dy) qb
      vs abg nqqba.pbzcyrgrqdhrfgf[vq] gura
        nqq[vq] = gehr
      raq
    raq
    sbe vq,_ va cnvef(nqqba.pbzcyrgrqdhrfgf) qb
      vs abg dy[vq] gura
        erzbir[vq] = gehr
      raq
    raq
    vs arkg(nqq) gura pungZft("Nqqrq VQf:   "..dhrfgGnoyrGbFgevat(nqq)) raq
    vs arkg(erzbir) gura pungZft("Erzbirq VQf: "..dhrfgGnoyrGbFgevat(erzbir)) raq
  raq
  nqqba.pbzcyrgrqdhrfgf = dy
raq

-- nooerivngr rkcnafvba anzrf (juvpu nccneragyl ner abg ybpnyvmrq va nal jrfgrea punenpgre frg)
ybpny shapgvba nooerivngr(vanzr)
  vanzr = vanzr:tfho("Oheavat Pehfnqr", "OP")
  vanzr = vanzr:tfho("Jengu bs gur Yvpu Xvat", "JbgYX")
  vanzr = vanzr:tfho("Pngnpylfz", "Pngn")
  vanzr = vanzr:tfho("Zvfgf bs Cnaqnevn", "ZbC")
  vanzr = vanzr:tfho("Jneybeqf bs Qenrabe", "JbQ")

  erghea vanzr
raq

shapgvba nqqba:sbezngAhzore(ahz,vfzbarl)
  ahz = gbahzore(ahz)
  vs abg ahz gura erghea "" raq
  ybpny cbfg = ""
  vs vfzbarl gura
    vs ahz < 1000*10000 gura -- yrff guna 1x, fubj vg nyy
      erghea TrgZbarlFgevat(ahz)
    raq
    ahz = zngu.sybbe(ahz / 10000)
    cbfg = " \124GVagresnpr\\ZbarlSenzr\\HV-TbyqVpba:0:0:2:0\124g"
  raq
  vs inef.qo.Gbbygvc.AhzoreSbezng gura
    ybpny fge = ""
    ybpny art = ahz < 0
    ahz = zngu.nof(ahz)
    ybpny vag = zngu.sybbe(ahz)
    ybpny qrp = ahz - vag
    ybpny g = gbfgevat(vag)
    vs #g > 4 gura -- yrnir 4 qvtvg ahzoref
      juvyr #g > 3 qb
        fge = YNETR_AHZORE_FRCRENGBE .. g:fho(-3) .. fge
        g = g:fho(1,-4)
    raq
    raq
    fge = g..fge
    vs qrp > 0 gura
      fge = fge..fgevat.sbezng("%15t",qrp):zngpu("(%..*)$")
    raq
    vs art gura
      fge = "-"..fge
    raq
    erghea fge..cbfg
  ryfr
    erghea ahz..cbfg
  raq
raq

inef.qrsnhygQO = {
  QOIrefvba = 12,
  Uvfgbel = { }, -- sbe genpxvat 5 vafgnapr cre ubhe yvzvg
  -- xrl: vafgnapr fgevat; inyhr: gvzr svefg ragrerq
  Gbbaf = { }, 	-- gnoyr xrl: "Gbba - Ernyz"; inyhr:
  -- Pynff: fgevat
  -- Yriry: vagrtre
  -- NyjnlfFubj: obbyrna ERZBIRQ
  -- Fubj: fgevat "nyjnlf", "arire", "fnirq"
  -- Qnvyl1: rkcvel (abezny) ERZBIRQ
  -- Qnvyl2: rkcvel (urebvp) ERZBIRQ
  -- YST1: rkcvel (enaqbz qhatrba)
  -- YST2: rkcvel (qrfregre)
  -- JrrxylErfrgGvzr: rkcvel
  -- QnvylErfrgGvzr: rkcvel
  -- QnvylPbhag: vagrtre ERZBIRQ
  -- CynlrqYriry: vagrtre
  -- CynlrqGbgny: vagrtre
  -- Zbarl: vagrtre
  -- Mbar: fgevat

  -- pheerapl: xrl: pheeraplVQ  inyhr:
  -- nzbhag: vagrtre
  -- rnearqGuvfJrrx: vagrtre
  -- jrrxylZnk: vagrtre
  -- gbgnyZnk: vagrtre
  -- frnfba: vagrtre

  -- Dhrfgf:  xrl: DhrfgVQ  inyhr:
  -- Gvgyr: fgevat
  -- Yvax: ulcreyvax
  -- Mbar: fgevat
  -- vfQnvyl: obbyrna
  -- Rkcverf: rkcvengvba (aba-qnvyl)

  -- Fxvyyf: xrl: FcryyVQ be PQVQ inyhr:
  -- Gvgyr: fgevat
  -- Yvax: ulcreyvax
  -- Rkcverf: rkcvengvba

  -- SnezCynagrq: vagrtre
  -- SnezUneirfgrq: vagrtre
  -- SnezPebcCynagrq: xrl: fcryyVQ inyhr: pbhag
  -- SnezPebcErnql: xrl: fcryyVQ inyhr: pbhag
  -- SnezRkcverf: rkcvengvba

  -- ObahfEbyy: xrl: vag inyhr:
  -- anzr: fgevat
  -- gvzr: vag
  -- pheeraplVQ: vag
  -- zbarl: vagrtre be avy
  -- vgrz: yvaxfgevat be avy

  -- ZlguvpXrl
  -- anzr: fgevat
  -- ErfrgGvzr: rkcvel
  -- yriry: fgevat
  -- pbybe: fgevat
  -- yvax: fgevat
  -- ZlguvpXrlOrfg
  -- ynfgjrrxyriry: vag
  -- ErfrgGvzr: rkcvel
  -- yriry: fgevat
  -- jrrxylErjneq: obbyrna
  -- QnvylJbeyqDhrfg
  -- qnlf[0,1,2]
  -- anzr
  -- qnlyrsg
  -- dhrfgarrq
  -- dhrfgqbar

  Vaqvpngbef = {
    Q1Vaqvpngbe = "OYNAX", -- vaqvpngbe: VPBA_*, OYNAX
    Q1Grkg = "XVYYRQ/GBGNY",
    Q1Pbybe = { 0, 0.6, 0 }, -- qnex terra
    Q1PynffPbybe = gehr,
    Q2Vaqvpngbe = "OYNAX",
    Q2Grkg = "XVYYRQ/GBGNYU",
    Q2Pbybe = { 0, 1, 0 }, -- terra
    Q2PynffPbybe = gehr,
    Q3Vaqvpngbe = "OYNAX",
    Q3Grkg = "XVYYRQ/GBGNYZ",
    Q3Pbybe = { 1, 0, 0 }, -- erq
    Q3PynffPbybe = gehr,
    E0Vaqvpngbe = "OYNAX",
    E0Grkg = "XVYYRQ/GBGNY",
    E0Pbybe = { 0.6, 0.6, 0 }, -- qnex lryybj
    E0PynffPbybe = gehr,
    E1Vaqvpngbe = "OYNAX",
    E1Grkg = "XVYYRQ/GBGNY",
    E1Pbybe = { 0.6, 0.6, 0 }, -- qnex lryybj
    E1PynffPbybe = gehr,
    E2Vaqvpngbe = "OYNAX",
    E2Grkg = "XVYYRQ/GBGNY",
    E2Pbybe = { 0.6, 0, 0 }, -- qnex erq
    E2PynffPbybe = gehr,
    E3Vaqvpngbe = "OYNAX",
    E3Grkg = "XVYYRQ/GBGNYU",
    E3Pbybe = { 1, 1, 0 }, -- lryybj
    E3PynffPbybe = gehr,
    E4Vaqvpngbe = "OYNAX",
    E4Grkg = "XVYYRQ/GBGNYU",
    E4Pbybe = { 1, 0, 0 }, -- erq
    E4PynffPbybe = gehr,
    E5Vaqvpngbe = "OYNAX",
    E5Grkg = "XVYYRQ/GBGNY",
    E5Pbybe = { 0, 0, 1 }, -- oyhr
    E5PynffPbybe = gehr,
    E6Vaqvpngbe = "OYNAX",
    E6Grkg = "XVYYRQ/GBGNY",
    E6Pbybe = { 0, 1, 0 }, -- terra
    E6PynffPbybe = gehr,
    E7Vaqvpngbe = "OYNAX",
    E7Grkg = "XVYYRQ/GBGNYU",
    E7Pbybe = { 1, 1, 0 }, -- lryybj
    E7PynffPbybe = gehr,
    E8Vaqvpngbe = "OYNAX",
    E8Grkg = "XVYYRQ/GBGNYZ",
    E8Pbybe = { 1, 0, 0 }, -- erq
    E8PynffPbybe = gehr,
  },
  Gbbygvc = {
    ErirefrVafgnaprf = snyfr,
    FubjRkcverq = snyfr,
    FubjUbyvqnl = gehr,
    FubjEnaqbz = gehr,
    PbzovarJbeyqObffrf = snyfr,
    PbzovarYSE = gehr,
    GenpxQnvylDhrfgf = gehr,
    GenpxJrrxylDhrfgf = gehr,
    FubjPngrtbevrf = snyfr,
    PngrtbelFcnprf = snyfr,
    EbjUvtuyvtug = 0.1,
    Fpnyr = 1,
    SvgGbFperra = gehr,
    ArjSvefg = gehr,
    EnvqfSvefg = gehr,
    AhzoreSbezng = gehr,
    PngrtbelFbeg = "RKCNAFVBA", -- "RKCNAFVBA", "GLCR"
    FubjFbybPngrtbel = snyfr,
    FubjUvagf = gehr,
    ErcbegErfrgf = gehr,
    YvzvgJnea = gehr,
    UvfgbelGrkg = snyfr,
    FubjFreire = snyfr,
    FreireFbeg = gehr,
    FreireBayl = snyfr,
    PbaarpgrqErnyzf = "tebhc",
    FrysSvefg = gehr,
    FrysNyjnlf = snyfr,
    GenpxYST = gehr,
    GenpxQrfregre = gehr,
    GenpxFxvyyf = gehr,
    GenpxSnez = gehr,
    GenpxObahf = snyfr,
    GenpxCynlrq = gehr,
    NhtzragObahf = gehr,
    PheeraplInyhrPbybe = gehr,
    Pheerapl776 = snyfr, -- Jnesbetrq Frnyf
    Pheerapl738 = snyfr, -- Yrffre Punez bs Tbbq Sbeghar
    Pheerapl823 = snyfr,  -- Ncrkvf Pelfgny
    Pheerapl824 = snyfr,  -- Tneevfba Erfbheprf
    Pheerapl1101= snyfr,  -- Bvy
    Pheerapl994 = snyfr, -- Frny bs Grzcrerq Sngr
    Pheerapl1129= snyfr, -- Frny bs Varivgnoyr Sngr
    Pheerapl1155= gehr,  -- Napvrag Znan
    Pheerapl1166= gehr,  -- Gvzrjnecrq Onqtr
    Pheerapl1191= gehr,  -- Inybe Cbvagf
    Pheerapl1220= gehr,  -- Beqre Erfbheprf
    Pheerapl1226= snyfr, -- Argurefuneqf
    Pheerapl1273= gehr,  -- Frny bs Oebxra Sngr
    Pheerapl1149= gehr,  -- Fvtugyrff Rlr
    PheeraplZnk = snyfr,
    PheeraplRnearq = gehr,
    ZlguvpXrl = gehr,
    ZlguvpXrlOrfg = gehr,
    QnvylJbeyqDhrfg = gehr,
    NooerivngrXrlfgbar = gehr,
  },
  Vafgnaprf = { }, 	-- gnoyr xrl: "Vafgnapr anzr"; inyhr:
  -- Fubj: obbyrna
  -- Envq: obbyrna
  -- Ubyvqnl: obbyrna
  -- Enaqbz: obbyrna
  -- Rkcnafvba: vagrtre
  -- ErpYriry: vagrtre
  -- YSQVQ: vagrtre
  -- YSQhcqngrq: vagrtre ERZBIRQ
  -- ERZBIRQ Rapbhagref[vagrtre] = { THVQ : vagrtre, Anzr : fgevat }
  -- gnoyr xrl: "Gbba - Ernyz"; inyhr:
  -- gnoyr xrl: "Qvssvphygl"; inyhr:
  -- VQ: vagrtre, cbfvgvir sbe n Oyvmmneq Envq VQ,
  --  artngvir inyhr sbe na YSE rapbhagre pbhag
  -- Rkcverf: vagrtre
  -- Ybpxrq: obbyrna, jurgure gbba vf ybpxrq gb gur fnir
  -- Rkgraqrq: obbyrna, jurgure guvf vf na rkgraqrq envq ybpxbhg
  -- Yvax: fgevat ulcreyvax gb gur fnir
  -- 1..ahzRapbhagref: obbyrna YSE vfYbbgrq
  ZvavzncVpba = { uvqr = snyfr },
  Dhrfgf = {},  -- Nppbhag-jvqr Dhrfgf:  xrl: DhrfgVQ  inyhr: fnzr nf gbba Dhrfg qngnonfr
  DhrfgQO = {   -- creznarag ercrngnoyr dhrfg QO: xrl: dhrfgvq  inyhr: zncvq
    Qnvyl = {},
    Jrrxyl = {},
    Qnexzbba = {},
    NppbhagQnvyl = {},
    NppbhagJrrxyl = {},
  },
  ErnyzZnc = {},
}

-- fxvaavat fhccbeg
-- fxvaavat nqqbaf fubhyq ubbx guvf shapgvba, rt:
--   ubbxfrphershap(FnirqVafgnaprf,"FxvaSenzr",shapgvba(frys,senzr,anzr) senzr:FrgJungrire() raq)
shapgvba nqqba:FxvaSenzr(senzr,anzr)
  -- qrsnhyg orunivbe (gvpxrg 81)
  vs VfNqqBaYbnqrq("RyiHV") be VfNqqBaYbnqrq("Ghxhv") gura
    vs senzr.FgevcGrkgherf gura
      senzr:FgevcGrkgherf()
    raq
    vs senzr.FrgGrzcyngr gura
      senzr:FrgGrzcyngr("Genafcnerag")
    raq
    ybpny pybfr = _T[anzr.."PybfrOhggba"] be senzr.PybfrOhggba
    vs pybfr naq pybfr.FrgNycun gura
      vs RyiHV gura
        RyiHV[1]:TrgZbqhyr('Fxvaf'):UnaqyrPybfrOhggba(pybfr)
      raq
      vs Ghxhv naq Ghxhv[1] naq Ghxhv[1].FxvaPybfrOhggba gura
        Ghxhv[1].FxvaPybfrOhggba(pybfr)
      raq
      pybfr:FrgNycun(1)
    raq
  raq
raq

-- trareny urycre shapgvbaf orybj

ybpny shapgvba PbybePbqrBcraETO(e,t,o,n)
  erghea sbezng("|p%02k%02k%02k%02k", zngu.sybbe(n * 255), zngu.sybbe(e * 255), zngu.sybbe(t * 255), zngu.sybbe(o * 255))
raq

ybpny shapgvba PbybePbqrBcra(pbybe)
  erghea PbybePbqrBcraETO(pbybe[1] be pbybe.e,
    pbybe[2] be pbybe.t,
    pbybe[3] be pbybe.o,
    pbybe[4] be pbybe.n be 1)
raq

ybpny shapgvba PynffPbybevfr(pynff, gnetrgfgevat)
  ybpny p = (PHFGBZ_PYNFF_PBYBEF naq PHFGBZ_PYNFF_PBYBEF[pynff]) be ENVQ_PYNFF_PBYBEF[pynff]
  vs p.pbybeFge gura
    p = "|p"..p.pbybeFge
  ryfr
    p = PbybePbqrBcra( p )
  raq
  erghea p .. gnetrgfgevat .. SBAGRAQ
raq

shapgvba nqqba.PbyberqGbba(gbba, shyyanzr)
  ybpny fge = (shyyanzr naq gbba) be fgefcyvg(' ',gbba)
  ybpny g = inef.qo.Gbbaf[gbba]
  ybpny pynff = g naq g.Pynff
  vs pynff gura
    erghea PynffPbybevfr(pynff, fge)
  ryfr
    erghea fge
  raq
raq

ybpny shapgvba PheeraplPbybe(nzg, znk)
  nzg = nzg be 0
  ybpny fnzg = nqqba:sbezngAhzore(nzg)
  vs znk == avy be znk == 0 gura
    erghea fnzg
  raq
  vs inef.qo.Gbbygvc.PheeraplInyhrPbybe gura
    ybpny cpg = nzg / znk
    ybpny pbybe = TERRASBAG
    vs cpg == 1 gura
      pbybe = ERQSBAG
    ryfrvs cpg > 0.75 gura
      pbybe = TBYQSBAG
    raq
    fnzg = pbybe .. fnzg .. SBAGRAQ
  raq
  erghea fnzg
raq

ybpny shapgvba GnoyrYra(gnoyr)
  ybpny v = 0
  sbe _, _ va cnvef(gnoyr) qb
    v = v + 1
  raq
  erghea v
raq

-- ergheaf ubj znal ubhef gur freire gvzr vf nurnq bs ybpny gvzr
-- pbaireg ybpny gvzr -> freire gvzr: nqq guvf inyhr
-- pbaireg freire gvzr -> ybpny gvzr: fhogenpg guvf inyhr
shapgvba nqqba:TrgFreireBssfrg()
  ybpny freireQnl = PnyraqneTrgQngr() - 1 -- 1-onfrq fgnegf ba Fha
  ybpny ybpnyQnl = gbahzore(qngr("%j")) -- 0-onfrq fgnegf ba Fha
  ybpny freireUbhe, freireZvahgr = TrgTnzrGvzr()
  ybpny ybpnyUbhe, ybpnyZvahgr = gbahzore(qngr("%U")), gbahzore(qngr("%Z"))
  vs freireQnl == (ybpnyQnl + 1)%7 gura -- freire vf n qnl nurnq
    freireUbhe = freireUbhe + 24
  ryfrvs ybpnyQnl == (freireQnl + 1)%7 gura -- ybpny vf n qnl nurnq
    ybpnyUbhe = ybpnyUbhe + 24
  raq
  ybpny freire = freireUbhe + freireZvahgr / 60
  ybpny ybpnyG = ybpnyUbhe + ybpnyZvahgr / 60
  ybpny bssfrg = sybbe((freire - ybpnyG) * 2 + 0.5) / 2
  erghea bssfrg
raq

shapgvba nqqba:TrgErtvba()
  vs abg nqqba.ertvba gura
    ybpny ert
    ert = TrgPIne("cbegny")
    vs ert == "choyvp-grfg" gura -- CGE hfrf HF ertvba erfrgf, qrfcvgr gur zvfyrnqvat ernyz anzr fhssvk
      ert = "HF"
    raq
    vs abg ert be #ert ~= 2 gura
      ybpny tpe = TrgPheeragErtvba()
      ert = tpe naq ({ "HF", "XE", "RH", "GJ", "PA" })[tpe]
    raq
    vs abg ert be #ert ~= 2 gura
      ert = (TrgPIne("ernyzYvfg") be ""):zngpu("^(%n+)%.")
    raq
    vs abg ert be #ert ~= 2 gura -- bgure grfg ernyzf?
      ert = (TrgErnyzAnzr() be ""):zngpu("%((%n%n)%)")
    raq
    ert = ert naq ert:hccre()
    vs ert naq #ert == 2 gura
      nqqba.ertvba = ert
    raq
  raq
  erghea nqqba.ertvba
raq

shapgvba nqqba:TrgArkgQnvylErfrgGvzr()
  ybpny erfrggvzr = TrgDhrfgErfrgGvzr()
  vs abg erfrggvzr be erfrggvzr <= 0 be -- gvpxrg 43: pna snvy qhevat fgneghc
    -- nyfb evtug nsgre n qnlyvtug fnivatf ebyybire, jura vg ergheaf artngvir inyhrf >.<
    erfrggvzr > 24*3600+30 gura -- pna nyfb or jebat arne erfrg va na vafgnapr
    erghea avy
  raq

  erghea gvzr() + erfrggvzr
raq

qb
  ybpny zvqavtug = {ubhe=23, zva=59, frp=59}
  shapgvba nqqba:TrgArkgQnvylFxvyyErfrgGvzr() -- genqr fxvyy erfrg gvzr
    -- guvf vf whfg n "orfg thrff" orpnhfr va ernyvgl,
    -- qvssrerag genqr fxvyyf erfrg ng hc gb 3 qvssrerag gvzrf
    ybpny eg = nqqba:TrgArkgQnvylErfrgGvzr()
    vs abg eg gura erghea avy raq
    --ybpny vasb = qngr("*g"); cevag(vasb.vfqfg)
    -- Oyvmmneq'f evqvphybhf erfrg penc:
    -- genqr fxvyyf vtaber qnlyvtug fnivatf nsgre gur qngr vg punatrf HAGVY gur arkg erfgneg, gura tb onpx gb bofreivat vg

    erghea eg
  raq
raq

shapgvba nqqba:TrgArkgJrrxylErfrgGvzr()
  vs abg nqqba.erfrgQnlf gura
    ybpny ertvba = nqqba:TrgErtvba()
    vs abg ertvba gura erghea avy raq
    nqqba.erfrgQnlf = {}
    nqqba.erfrgQnlf.QYUbssfrg = 0
    vs ertvba == "HF" gura
      nqqba.erfrgQnlf["2"] = gehr -- ghrfqnl
      -- rafher bprnavp freiref bire gur qngryvar fgvyy erfrg ba ghrf HGP (jrq 1/2 NZ freire)
      nqqba.erfrgQnlf.QYUbssfrg = -3
    ryfrvs ertvba == "RH" gura
      nqqba.erfrgQnlf["3"] = gehr -- jrqarfqnl
    ryfrvs ertvba == "PA" be ertvba == "XE" be ertvba == "GJ" gura -- KKK: pbqrf hapbasvezrq
      nqqba.erfrgQnlf["4"] = gehr -- guhefqnl
    ryfr
      nqqba.erfrgQnlf["2"] = gehr -- ghrfqnl?
    raq
  raq
  ybpny bssfrg = (nqqba:TrgFreireBssfrg() + nqqba.erfrgQnlf.QYUbssfrg) * 3600
  ybpny avtugylErfrg = nqqba:TrgArkgQnvylErfrgGvzr()
  vs abg avtugylErfrg gura erghea avy raq
  --juvyr qngr("%N",avtugylErfrg+bssfrg) ~= JRRXQNL_GHRFQNL qb
  juvyr abg nqqba.erfrgQnlf[qngr("%j",avtugylErfrg+bssfrg)] qb
    avtugylErfrg = avtugylErfrg + 24 * 3600
  raq

  erghea avtugylErfrg
raq

qb
  ybpny qzs_raq = {ubhe=23, zva=59}
  shapgvba nqqba:TrgArkgQnexzbbaErfrgGvzr()
    -- Qnexzbba snver ehaf sebz svefg Fhaqnl bs rnpu zbagu gb sbyybjvat Fngheqnl
    -- guvf shapgvba ergheaf na nccebkvzngr gvzr nsgre gur raq bs gur pheerag zbagu'f snver
    ybpny jrrxqnl, zbagu, qnl, lrne = PnyraqneTrgQngr() -- qngr va freire gvzrmbar (Fha==1)
    ybpny svefgjrrxqnl = fryrpg(4,PnyraqneTrgNofZbagu(zbagu, lrne)) -- (Fha == 1)
    ybpny svefgfhaqnl = ((svefgjrrxqnl == 1) naq 1) be (9 - svefgjrrxqnl)
    qzs_raq.lrne = lrne
    qzs_raq.zbagu = zbagu
    qzs_raq.qnl = svefgfhaqnl + 7 -- 1 qnlf bs "fybc"
    -- Hasbeghangryl, QZS obhaqnel vtaberf qnlyvtug fnivatf, naq gur gvzr bs qnl inevrf npebff ertvbaf
    -- Ercbeg n erfrg jryy cnfg raq gb znxr fher jr qba'g qebc dhrfgf rneyl
    ybpny erg = gvzr(qzs_raq)
    ybpny bssfrg = nqqba:TrgFreireBssfrg() * 3600
    erg = erg - bssfrg
    erghea erg
  raq
raq

shapgvba nqqba:DhrfgPbhag(gbbaanzr)
  ybpny g
  vs gbbaanzr gura
    g = inef naq inef.qo.Gbbaf naq inef.qo.Gbbaf[gbbaanzr]
  ryfr -- nppbhag-jvqr dhrfgf
    g = qo
  raq
  vs abg g gura erghea 0,0 raq
  ybpny qnvylpbhag, jrrxylpbhag = 0,0
  -- gvpxrg 96: TrgQnvylDhrfgfPbzcyrgrq() vf haeryvnoyr, gur erfcbafr vf ynttl naq vg snvyf gb pbhag fbzr dhrfgf
  sbe _,vasb va cnvef(g.Dhrfgf) qb
    vs vasb.vfQnvyl gura
      qnvylpbhag = qnvylpbhag + 1
    ryfr
      jrrxylpbhag = jrrxylpbhag + 1
    raq
  raq
  erghea qnvylpbhag, jrrxylpbhag
raq

-- ybpny nqqba shapgvbaf orybj

ybpny shapgvba TrgYnfgYbpxrqVafgnapr()
  ybpny ahzfnirq = TrgAhzFnirqVafgnaprf()
  vs ahzfnirq > 0 gura
    sbe v = 1, ahzfnirq qb
      ybpny anzr, vq, rkcverf, qvss, ybpxrq, rkgraqrq, zbfgfvt, envq, cynlref, qvssanzr = TrgFnirqVafgnaprVasb(v)
      vs ybpxrq gura
        erghea anzr, vq, rkcverf, qvss, ybpxrq, rkgraqrq, zbfgfvt, envq, cynlref, qvssanzr
      raq
    raq
  raq
raq

shapgvba nqqba:abeznyvmrAnzr(fge)
  erghea fge:tfho("%c",""):tfho("%f"," "):tfho("%f%f"," "):tfho("^%f+",""):tfho("%f+$",""):hccre()
raq

nqqba.genafVafgnapr = {
  -- ybpxbhg ulcreyvax vq = YSQVQ
  [543] = 188, 	-- Uryysver Pvgnqry: Enzcnegf
  [540] = 189, 	-- Uryysver Pvgnqry: Funggrerq Unyyf : qrQR
  [542] = 187,  -- Uryysver Pvgnqry: Oybbq Sheanpr rfRF
  [534] = 195, 	-- Gur Onggyr sbe Zbhag Ulwny
  [509] = 160, 	-- Ehvaf bs Nua'Dvenw
  [557] = 179,  -- Nhpuvaqbha: Znan-Gbzof : gvpxrg 72 muGJ
  [556] = 180,  -- Nhpuvaqbha: Frgurxx Unyyf : gvpxrg 151 seSE
  [568] = 340,  -- Mhy'Nzna: seSE
  [1004] = 474, -- Fpneyrg Zbanfgnel: qrQR
  [600] = 215,  -- Qenx'Guneba: gvpxrg 105 qrQR
  [560] = 183,  -- Rfpncr sebz Qheaubyqr Xrrc: gvpxrg 124 qrQR
  [531] = 161,  -- ND grzcyr: gvpxrg 137 seSE
  [1228] = 897, -- Uvtuznhy: gvpxrg 175 ehEH
  [552] = 1011, -- Nepngenm: gvpxrg 216 seSE
  [1516] = 1190, -- Nepjnl: gvpxrg 227/233 cgOE
  [1651] = 1347, -- Erghea gb Xnenmuna: gvpxrg 237 (snxr YSQVQ)
}

-- fbzr vafgnaprf (yvxr frgurxx unyyf) ner anzrq qvssreragyl ol TrgFnirqVafgnaprVasb() naq YSTTrgQhatrbaVasbOlVQ()
-- jr hfr gur ynggre anzr gb xrl bhe qngnonfr, naq guvf shapgvba gb pbaireg nf arrqrq
shapgvba nqqba:SvaqVafgnapr(anzr, envq)
  vs abg anzr be #anzr == 0 gura erghea avy raq
  ybpny aanzr = nqqba:abeznyvmrAnzr(anzr)
  -- svefg cnff, qverpg zngpu
  ybpny vasb = inef.qo.Vafgnaprf[anzr]
  vs vasb gura
    erghea anzr, vasb.YSQVQ
  raq
  -- ulcreyvax vq ybbxhc: zhfg cerprqr fhofgevat zngpu sbe gvpxrg 99
  -- (fb genafVafgnapr pna bireevqr vapbeerpg fhofgevat zngpurf)
  sbe v = 1, TrgAhzFnirqVafgnaprf() qb
    ybpny yvax = TrgFnirqVafgnaprPungYvax(v) be ""
    ybpny yvq,yanzr = yvax:zngpu(":(%q+):%q+:%q+\124u%[(.+)%]\124u")
    yanzr = yanzr naq nqqba:abeznyvmrAnzr(yanzr)
    yvq = yvq naq gbahzore(yvq)
    ybpny ysqvq = yvq naq nqqba.genafVafgnapr[yvq]
    vs yanzr == aanzr naq ysqvq gura
      ybpny gehranzr = nqqba:HcqngrVafgnapr(ysqvq)
      vs gehranzr gura
        erghea gehranzr, ysqvq
      raq
    raq
  raq
  -- abeznyvmrq fhofgevat zngpu
  sbe gehranzr, vasb va cnvef(inef.qo.Vafgnaprf) qb
    ybpny ganzr = nqqba:abeznyvmrAnzr(gehranzr)
    vs (ganzr:svaq(aanzr, 1, gehr) be aanzr:svaq(ganzr, 1, gehr)) naq
      vasb.Envq == envq gura -- Grzcrfg Xrrc: Gur Obgnavpn
      --qroht("SvaqVafgnapr("..anzr..") => "..gehranzr)
      erghea gehranzr, vasb.YSQVQ
    raq
  raq
  erghea avy
raq

-- cebivqr rvgure vq be anzr/envq gb trg gur vafgnapr gehranzr naq qo ragel
shapgvba nqqba:YbbxhcVafgnapr(vq, anzr, envq)
  --qroht("YbbxhcVafgnapr("..(vq be "avy")..","..(anzr be "avy")..","..(envq naq "gehr" be "snyfr")..")")
  ybpny gehranzr, vafgnapr
  vs anzr gura
    gehranzr, vq = nqqba:SvaqVafgnapr(anzr, envq)
  raq
  vs vq gura
    gehranzr = nqqba:HcqngrVafgnapr(vq)
  raq
  vs gehranzr gura
    vafgnapr = inef.qo.Vafgnaprf[gehranzr]
  raq
  vs abg vafgnapr gura
    qroht("YbbxhcVafgnapr() snvyrq gb svaq vafgnapr: "..(anzr be "")..":"..(vq be 0).." : "..TrgYbpnyr())
    nqqba.jnearq = nqqba.jnearq be {}
    vs abg nqqba.jnearq[anzr] gura
      nqqba.jnearq[anzr] = gehr
      ybpny yvq
      sbe v = 1, TrgAhzFnirqVafgnaprf() qb
        ybpny yvax = TrgFnirqVafgnaprPungYvax(v) be ""
        ybpny gyvq,gyanzr = yvax:zngpu(":(%q+):%q+:%q+\124u%[(.+)%]\124u")
        vs gyanzr == anzr gura yvq = gyvq raq
      raq
      ohtErcbeg("FnirqVafgnaprf: REEBE: Erserfu() snvyrq gb svaq vafgnapr: "..anzr.." : "..TrgYbpnyr().." : "..(yvq be "k"))
    raq
    vafgnapr = {}
    --inef.qo.Vafgnaprf[anzr] = vafgnapr
  raq
  erghea gehranzr, vafgnapr
raq

shapgvba nqqba:VafgnaprPngrtbel(vafgnapr)
  vs abg vafgnapr gura erghea avy raq
  vafgnapr = inef.qo.Vafgnaprf[vafgnapr]
  vs vafgnapr.Ubyvqnl gura erghea "U" raq
  vs vafgnapr.Enaqbz gura erghea "A" raq
  erghea ((vafgnapr.Envq naq "E") be ((abg vafgnapr.Envq) naq "Q")) .. vafgnapr.Rkcnafvba
raq

shapgvba nqqba:VafgnaprfVaPngrtbel(gnetrgpngrtbel)
  -- ergheaf n gnoyr bs gur sbez { "vafgnapr1", "vafgnapr2", ... }
  vs (abg gnetrgpngrtbel) gura erghea { } raq
  ybpny yvfg = { }
  sbe vafgnapr, _ va cnvef(inef.qo.Vafgnaprf) qb
    vs nqqba:VafgnaprPngrtbel(vafgnapr) == gnetrgpngrtbel gura
      gnoyr.vafreg(yvfg, vafgnapr)
    raq
  raq
  erghea yvfg
raq

shapgvba nqqba:PngrtbelFvmr(pngrtbel)
  vs abg pngrtbel gura erghea avy raq
  ybpny v = 0
  sbe vafgnapr, _ va cnvef(inef.qo.Vafgnaprf) qb
    vs pngrtbel == nqqba:VafgnaprPngrtbel(vafgnapr) gura
      v = v + 1
    raq
  raq
  erghea v
raq

ybpny _vafgnapr_rkprcgvbaf = {
  -- jbexnebhaq n Oyvmmneq oht:
  -- fvapr 5.0, fbzr byq envq ybpxbhg gbbygvcf ner zvffvat obff xvyy vasb
  -- pheeragyl nssrpgf 25+ zna OP/Inavyyn envqf (ohg abg Xnen be ND Ehvaf, tb svther)
  -- fgnegvat va 6.1 jr unir gur xvyy ovgznc ohg ab obff anzrf
  [48] = { -- Zbygra Pber
    12118, -- Yhpvseba
    11982, -- Zntznqne
    12259, -- Truraanf
    12057, -- Tnee
    12264, -- Funmmenu
    12056, -- Oneba Trqqba
    12098, -- Fhysheba Uneovatre
    11988, -- Tbyrzntt gur Vapvarengbe
    12018, -- Znwbeqbzb Rkrphghf
    11502, -- Entanebf
  },
  [50] = { -- Oynpxjvat Ynve
    12435, -- Enmbetber gur Hagnzrq
    13020, -- Inrynfgenfm gur Pbeehcg
    12017, -- Obbqybeq Ynfuynlre
    11983, -- Sverznj
    14601, -- Robaebp
    11981, -- Synzrtbe
    14020, -- Puebzntthf
    11583, -- Arsnevna
  },
  [161] = { -- Nua'Dvenw Grzcyr
    15263, -- Cebcurg Fxrenz
    15543, -- Cevaprff Lnhw (nyfb Irz naq Ybeq Xev)
    15516, -- Obqlthneq Fneghen
    15510, -- Snaxevff gur Halvryqvat
    15299, -- Ivfpvqhf
    15509, -- Cevaprff Uhuhena
    15276, -- Rzcrebe Irx'ybe
    15517, -- Bheb
    15727, -- P'Guha
  },
  [176] = { -- Zntgurevqba'f Ynve
    17257, -- Zntgurevqba
  },
  [177] = { -- Tehhy'f Ynve
    18831, -- Uvtu Xvat Znhytne
    19044, -- Tehhy
  },
  [193] = { -- Grzcrfg Xrrc
    19514, -- N'yne
    19516, -- Ibvq Ernire
    18805, -- Uvtu Nfgebznapre Fbynevna
    19622, -- Xnry'gunf Fhafgevqre
  },
  [194] = { -- Frecragfuevar Pnirea
    21216, -- Ulqebff gur Hafgnoyr
    21217, -- Gur Yhexre Orybj
    21215, -- Yrbgurenf gur Oyvaq
    21214, -- Sngubz-Ybeq Xnenguerff
    21213, -- Zbebtevz Gvqrjnyxre
    21212, -- Ynql Infuw
  },
  [195] = { -- Ulwny Cnfg
    17767, -- Entr Jvagrepuvyy
    17808, -- Nargureba
    17888, -- Xnm'ebtny
    17842, -- Nmtnybe
    17968, -- Nepuvzbaqr
  },
  [196] = { -- Oynpx Grzcyr
    22887, -- Uvtu Jneybeq Anw'raghf
    22898, -- Fhcerzhf
    22841, -- Funqr bs Nxnzn
    22871, -- Greba Tbersvraq
    22948, -- Thegbtt Oybbqobvy
    22856, -- Eryvdhnel bs Fbhyf
    22947, -- Zbgure Funuenm
    23426, -- Vyyvqnev Pbhapvy
    22917, -- Vyyvqna Fgbezentr
  },
  [199] = { -- Fhajryy
    24850, -- Xnyrptbf
    24882, -- Oehgnyyhf
    25038, -- Sryzlfg
    25166, -- Tenaq Jneybpx Nylgurff
    25741, -- Z'heh
    25315, -- Xvy'wnrqra
  },
  [1347] = { gbgny=8 }, -- Erghea gb Xnenmuna
}

shapgvba nqqba:vafgnaprRkprcgvba(YSQVQ)
  vs abg YSQVQ gura erghea avy raq
  ybpny rkp = _vafgnapr_rkprcgvbaf[YSQVQ]
  vs rkp gura -- ybpnyvmr obff anzrf
    ybpny gbgny = 0
    sbe vqk, vq va vcnvef(rkp) qb
      vs glcr(vq) == "ahzore" gura
        fpnagg:FrgBjare(HVCnerag,"NAPUBE_ABAR")
        fpnagg:FrgUlcreyvax(("havg:Perngher-0-0-0-0-%q:0000000000"):sbezng(vq))
        ybpny yvar = fpnagg:VfFubja() naq _T[fpnagg:TrgAnzr().."GrkgYrsg1"]
        yvar = yvar naq yvar:TrgGrkg()
        vs yvar naq #yvar > 0 gura
          rkp[vqk] = yvar
        raq
      raq
      gbgny = gbgny + 1
    raq
    rkp.gbgny = rkp.gbgny be gbgny
  raq
  erghea rkp
raq

shapgvba nqqba:vafgnaprObffrf(vafgnapr,gbba,qvss)
  ybpny xvyyrq,gbgny,onfr = 0,0,1
  ybpny erznc = avy
  ybpny vafg = inef.qo.Vafgnaprf[vafgnapr]
  ybpny fnir = vafg naq vafg[gbba] naq vafg[gbba][qvss]
  vs vafg.JbeyqObff gura
    erghea (fnir[1] naq 1 be 0), 1, 1
  raq
  vs abg vafg be abg vafg.YSQVQ gura erghea 0,0,1 raq
  ybpny rkp = nqqba:vafgnaprRkprcgvba(vafg.YSQVQ)
  gbgny = (rkp naq rkp.gbgny) be TrgYSTQhatrbaAhzRapbhagref(vafg.YSQVQ)
  ybpny YSE = nqqba.YSEVafgnaprf[vafg.YSQVQ]
  vs YSE gura
    gbgny = YSE.gbgny be gbgny
    onfr = YSE.onfr be onfr
    erznc = YSE.erznc
  raq
  vs abg fnir gura
    erghea xvyyrq, gbgny, onfr, erznc
  ryfrvs fnir.Yvax gura
    ybpny ovgf = fnir.Yvax:zngpu(":(%q+)\124u")
    ovgf = ovgf naq gbahzore(ovgf)
    vs ovgf gura
      juvyr ovgf > 0 qb
        vs ovg.onaq(ovgf,1) > 0 gura
          xvyyrq = xvyyrq + 1
        raq
        ovgf = ovg.efuvsg(ovgf,1)
      raq
    raq
  ryfrvs fnir.VQ < 0 gura
    sbe v=1,-1*fnir.VQ qb
      xvyyrq = xvyyrq + (fnir[v] naq 1 be 0)
    raq
  raq
  erghea xvyyrq, gbgny, onfr, erznc
raq

ybpny ysexrl = "^"..Y["YSE"]..": "
ybpny shapgvba vafgnaprFbeg(v1, v2)
  ybpny vafgnapr1 = inef.qo.Vafgnaprf[v1]
  ybpny vafgnapr2 = inef.qo.Vafgnaprf[v2]
  ybpny yriry1 = vafgnapr1.ErpYriry be 0
  ybpny yriry2 = vafgnapr2.ErpYriry be 0
  ybpny vq1 = vafgnapr1.YSQVQ be vafgnapr1.JbeyqObff be 0
  ybpny vq2 = vafgnapr2.YSQVQ be vafgnapr2.JbeyqObff be 0
  ybpny xrl1 = yriry1*1000000+vq1
  ybpny xrl2 = yriry2*1000000+vq2
  vs v1:zngpu(ysexrl) gura xrl1 = xrl1 - 20000 raq
  vs v2:zngpu(ysexrl) gura xrl2 = xrl2 - 20000 raq
  vs vafgnapr1.JbeyqObff gura xrl1 = xrl1 - 30000 raq
  vs vafgnapr2.JbeyqObff gura xrl2 = xrl2 - 30000 raq
  vs inef.qo.Gbbygvc.ErirefrVafgnaprf gura
    erghea xrl1 < xrl2
  ryfr
    erghea xrl2 < xrl1
  raq
raq

nqqba.bv_pnpur = {}
shapgvba nqqba:BeqrerqVafgnaprf(pngrtbel)
  -- ergheaf n gnoyr bs gur sbez { "vafgnapr1", "vafgnapr2", ... }
  ybpny vafgnaprf = nqqba.bv_pnpur[pngrtbel]
  vs abg vafgnaprf gura
    vafgnaprf = nqqba:VafgnaprfVaPngrtbel(pngrtbel)
    gnoyr.fbeg(vafgnaprf, vafgnaprFbeg)
    vs nqqba.vafgnaprfHcqngrq gura
      nqqba.bv_pnpur[pngrtbel] = vafgnaprf
    raq
  raq
  erghea vafgnaprf
raq

shapgvba nqqba:BeqrerqPngrtbevrf()
  -- ergheaf n gnoyr bs gur sbez { "pngrtbel1", "pngrtbel2", ... }
  vs nqqba.bp_pnpur gura erghea nqqba.bp_pnpur raq
  ybpny beqrerqyvfg = { }
  ybpny svefgrkcnafvba, ynfgrkcnafvba, rkcnafvbafgrc, svefgglcr, ynfgglcr
  vs inef.qo.Gbbygvc.ArjSvefg gura
    svefgrkcnafvba = znkRkcnafvba
    ynfgrkcnafvba = 0
    rkcnafvbafgrc = -1
  ryfr
    svefgrkcnafvba = 0
    ynfgrkcnafvba = znkRkcnafvba
    rkcnafvbafgrc = 1
  raq
  vs inef.qo.Gbbygvc.EnvqfSvefg gura
    svefgglcr = "E"
    ynfgglcr = "Q"
  ryfr
    svefgglcr = "Q"
    ynfgglcr = "E"
  raq
  sbe v = svefgrkcnafvba, ynfgrkcnafvba, rkcnafvbafgrc qb
    gnoyr.vafreg(beqrerqyvfg, svefgglcr .. v)
    vs inef.qo.Gbbygvc.PngrtbelFbeg == "RKCNAFVBA" gura
      gnoyr.vafreg(beqrerqyvfg, ynfgglcr .. v)
    raq
  raq
  vs inef.qo.Gbbygvc.PngrtbelFbeg == "GLCR" gura
    sbe v = svefgrkcnafvba, ynfgrkcnafvba, rkcnafvbafgrc qb
      gnoyr.vafreg(beqrerqyvfg, ynfgglcr .. v)
    raq
  raq
  nqqba.bp_pnpur = beqrerqyvfg
  erghea beqrerqyvfg
raq

ybpny shapgvba QvssvphyglFgevat(vafgnapr, qvss, gbba, rkcverq, xvyybireevqr, gbgbireevqr)
  ybpny frggvat,pbybe
  vs abg vafgnapr gura
    frggvat = "Q1"
  ryfr
    ybpny vafg = inef.qo.Vafgnaprf[vafgnapr]
    vs abg vafg be abg vafg.Envq gura -- 5-zna
      vs qvss == 2 gura -- urebvp
        frggvat = "Q2"
    ryfrvs qvss == 23 gura -- zlguvp
      frggvat = "Q3"
    ryfr -- abezny?
      frggvat = "Q1"
    raq
    ryfrvs vafg.Rkcnafvba == 0 gura -- pynffvp envq
      frggvat = "E0"
    ryfrvs qvss >= 3 naq qvss <= 7 gura -- cer-JbQ envqf
      frggvat = "E"..(qvss-2)
    ryfrvs qvss >= 14 naq qvss <= 16 gura -- JbQ envqf
      frggvat = "E"..(qvss-8)
    ryfr -- qba'g xabj
      frggvat = "Q1"
    raq
  raq
  ybpny cersf = inef.qo.Vaqvpngbef
  ybpny pynffpbybe = cersf[frggvat .. "PynffPbybe"]
  vs pynffpbybe == avy gura
    pynffpbybe = inef.qrsnhygQO.Vaqvpngbef[frggvat .. "PynffPbybe"]
  raq
  vs rkcverq gura
    pbybe = TENL_PBYBE
  ryfrvs pynffpbybe gura
    pbybe = (PHFGBZ_PYNFF_PBYBEF be ENVQ_PYNFF_PBYBEF)[inef.qo.Gbbaf[gbba].Pynff]
  ryfr
    cersf[frggvat.."Pbybe"]  = cersf[frggvat.."Pbybe"] be inef.qrsnhygQO.Vaqvpngbef[frggvat.."Pbybe"]
    pbybe = cersf[frggvat.."Pbybe"]
  raq
  ybpny grkg = cersf[frggvat.."Grkg"] be inef.qrsnhygQO.Vaqvpngbef[frggvat.."Grkg"]
  ybpny vaqvpngbe = cersf[frggvat.."Vaqvpngbe"] be inef.qrsnhygQO.Vaqvpngbef[frggvat.."Vaqvpngbe"]
  grkg = PbybePbqrBcra(pbybe) .. grkg .. SBAGRAQ
  vs grkg:svaq("VPBA", 1, gehr) naq vaqvpngbe ~= "OYNAX" gura
    grkg = grkg:tfho("VPBA", SBAGRAQ .. inef.Vaqvpngbef[vaqvpngbe] .. PbybePbqrBcra(pbybe))
  raq
  vs grkg:svaq("XVYYRQ", 1, gehr) be grkg:svaq("GBGNY", 1, gehr) gura
    ybpny xvyyrq, gbgny
    vs xvyybireevqr gura
      xvyyrq, gbgny = xvyybireevqr, gbgbireevqr
    ryfr
      xvyyrq, gbgny = nqqba:vafgnaprObffrf(vafgnapr,gbba,qvss)
    raq
    vs xvyyrq == 0 naq gbgny == 0 gura -- obff xvyy vasb zvffvat
      xvyyrq = "*"
      gbgny = "*"
    ryfrvs xvyyrq == 1 naq gbgny == 1 naq abg rkcverq gura
      grkg = "\124G"..ERNQL_PURPX_ERNQL_GRKGHER..":0|g" -- purpxznex
    raq
    grkg = grkg:tfho("XVYYRQ",xvyyrq)
    grkg = grkg:tfho("GBGNY",gbgny)
  raq
  erghea grkg
raq

-- eha nobhg bapr cre frffvba gb hcqngr bhe qngnonfr bs vafgnapr vasb
shapgvba nqqba:HcqngrVafgnaprQngn()
  --qroht("HcqngrVafgnaprQngn()")
  vs nqqba.vafgnaprfHcqngrq gura erghea raq  -- avy orsber svefg hfr va HV
  nqqba.vafgnaprfHcqngrq = gehr
  ybpny nqqrq = 0
  ybpny ysqvq_gb_anzr = {}
  ybpny jovq_gb_anzr = {}
  ybpny vq_oynpxyvfg = {}
  ybpny fgneggvzr = qrohtcebsvyrfgbc()
  -- cerivbhfyl jr hfrq TrgShyyEnvqYvfg() naq YSQQhatrbaYvfg gb uryc cbchyngr gur vafgnapr yvfg
  -- Hasbeghangryl gubfr ner ybnqrq ynmvyl, naq sbepvat gurz gb ybnq sebz urer pna yrnq gb gnvag.
  -- Gurl ner nyfb fbzrjung vapbzcyrgr, fb vafgrnq jr whfg oehgr sbepr vg, juvpu vf ernfbanoyl snfg nalubj
  sbe vq=1,znkvq qb
    ybpny vafganzr, arjragel, oynpxyvfg = nqqba:HcqngrVafgnapr(vq)
    vs arjragel gura
      nqqrq = nqqrq + 1
    raq
    vs oynpxyvfg gura
      vq_oynpxyvfg[vq] = gehr
    raq
    vs vafganzr gura
      vs ysqvq_gb_anzr[vq] gura
        qroht("Qhcyvpngr ragel va ysqvq_gb_anzr: "..vq..":"..ysqvq_gb_anzr[vq]..":"..vafganzr)
      raq
      ysqvq_gb_anzr[vq] = vafganzr
    raq
  raq
  sbe rvq,vasb va cnvef(nqqba.JbeyqObffrf) qb
    vasb.rvq = rvq
    vs abg vasb.anzr gura
      vasb.anzr = fryrpg(2,RW_TrgPerngherVasb(1,rvq))
    raq
    vasb.anzr = vasb.anzr be "HAXABJA"..rvq
    ybpny vafgnapr = inef.qo.Vafgnaprf[vasb.anzr]
    vs vasb.erzbir gura -- pyrnahc ubbx
      inef.qo.Vafgnaprf[vasb.anzr] = avy
      nqqba.JbeyqObffrf[rvq] = avy
    ryfr
      vs abg vafgnapr gura
        nqqrq = nqqrq + 1
        vafgnapr = {}
        inef.qo.Vafgnaprf[vasb.anzr] = vafgnapr
      raq
      vafgnapr.Fubj = vafgnapr.Fubj be "fnirq"
      vafgnapr.JbeyqObff = rvq
      vafgnapr.Rkcnafvba = vasb.rkcnafvba
      vafgnapr.ErpYriry = vasb.yriry
      vafgnapr.Envq = gehr
      jovq_gb_anzr[rvq] = vasb.anzr
    raq
  raq

  -- vafgnapr zretvat: guvf nytbevguz erzbirf qhcyvpngr ragevrf perngrq ol pyvrag ybpnyr punatrf hfvat gur fnzr qngnonfr
  -- jr ernyyl fubhyq er-xrl gur qngnonfr ol VQ, ohg guvf vf fhssvpvrag sbe abj
  ybpny eranzrf = 0
  ybpny zretrf = 0
  ybpny pbasyvpgf = 0
  sbe vafganzr, vafg va cnvef(inef.qo.Vafgnaprf) qb
    ybpny gehranzr
    vs vafg.JbeyqObff gura
      gehranzr = jovq_gb_anzr[vafg.JbeyqObff]
    ryfrvs vafg.YSQVQ gura
      gehranzr = ysqvq_gb_anzr[vafg.YSQVQ]
    ryfr
      qroht("Vtabevat obthf ragel va vafgnapr qngnonfr: "..vafganzr)
    raq
    vs abg gehranzr gura
      vs vafg.YSQVQ naq vq_oynpxyvfg[vafg.YSQVQ] gura
        qroht("Erzbivat oynpxyvfgrq ragel va vafgnapr qngnonfr: "..vafganzr)
        inef.qo.Vafgnaprf[vafganzr] = avy
      ryfr
        qroht("Vtabevat hazngpurq ragel va vafgnapr qngnonfr: "..vafganzr)
      raq
    ryfrvs vafganzr == gehranzr gura
    -- guvf vf gur pnabavpny ragel, abguvat gb qb
    ryfr -- guvf vf n fgnyr ragel, zretr qngn naq erzbir vg
      ybpny gehrvafg = inef.qo.Vafgnaprf[gehranzr]
      vs abg gehrvafg be gehrvafg == vafg gura
        qroht("Zretr reebe va HcqngrVafgnaprQngn: "..gehranzr)
      ryfr
        sbe xrl, vasb va cnvef(vafg) qb
          vs xrl:svaq(" - ") gura -- vf n punenpgre xrl
            vs gehrvafg[xrl] gura
              -- zretr pbasyvpg: xrrc gur gehrvafg qngn
              qroht("Zretr pbasyvpg ba "..gehranzr..":"..vafganzr..":"..xrl)
              pbasyvpgf = pbasyvpgf + 1
          ryfr
            gehrvafg[xrl] = vasb
            zretrf = zretrf + 1
          raq
          raq
        raq
        -- pbcl pbasvt frggvatf, snibevat byq ragel
        gehrvafg.Fubj = vafg.Fubj be gehrvafg.Fubj
        -- pyrne fgnyr ragel
        inef.qo.Vafgnaprf[vafganzr] = avy
        eranzrf = eranzrf + 1
      raq
    raq
  raq
  -- nqqba.ysqvq_gb_anzr = ysqvq_gb_anzr
  -- nqqba.jovq_gb_anzr = jovq_gb_anzr

  inef.pbasvt:OhvyqBcgvbaf() -- erserfu pbasvt gnoyr

  fgneggvzr = qrohtcebsvyrfgbc()-fgneggvzr
  qroht("HcqngrVafgnaprQngn(): pbzcyrgrq va %.3s zf : %q nqqrq, %q eranzrf, %q zretrf, %q pbasyvpgf.",
    fgneggvzr, nqqrq, eranzrf, zretrf, pbasyvpgf)
  vs nqqba.ErserfuCraqvat gura
    nqqba.ErserfuCraqvat = avy
    pber:Erserfu()
  raq
raq

--vs YSQCneragSenzr gura ubbxfrphershap(YSQCneragSenzr,"Fubj",shapgvba() nqqba:HcqngrVafgnaprQngn() raq) raq
shapgvba nqqba:HcqngrVafgnapr(vq)
  -- ergheaf: <vafgnapr_anzr>, <vf_arj_vafgnapr>, <oynpxyvfgrq_vq>
  --qroht("HcqngrVafgnapr: "..vq)
  vs abg vq be vq <= 0 gura erghea raq
  ybpny anzr, glcrVQ, fhoglcrVQ,
    zvaYriry, znkYriry, erpYriry, zvaErpYriry, znkErpYriry,
    rkcnafvbaYriry, tebhcVQ, grkgherSvyranzr,
    qvssvphygl, znkCynlref, qrfpevcgvba, vfUbyvqnl = TrgYSTQhatrbaVasb(vq)
  -- anzr vf avy sbe aba-rkvfgrag vqf
  -- vfUbyvqnl vf sbe fvatyr-obff ubyvqnl vafgnaprf gung qba'g trarengr envq fnirf
  -- glcrVQ 4 = bhgqbbe nern, glcrVQ 6 = enaqbz
  znkCynlref = gbahzore(znkCynlref)
  vs abg anzr be abg rkcnafvbaYriry be abg erpYriry be (glcrVQ > 2 naq glcrVQ ~= GLCRVQ_ENAQBZ_QHATRBA) gura erghea raq
  vs anzr:svaq(CIC_ENGRQ_ONGGYRTEBHAQ) gura erghea avy, avy, gehr raq -- vtaber 10i10 engrq ot
  vs vq == 1347 gura -- gvpxrg 237: Erghea gb Xnenmuna pheeragyl unf ab npghny YSQVQ, fb hfr guvf bar (Xnen Fpranevb)
    anzr = FCYNFU_YRTVBA_ARJ_7_1_EVTUG_GVGYR
    rkcnafvbaYriry = 6
    erpYriry = 110
    znkCynlref = 5
    vfUbyvqnl = snyfr
    glcrVQ = GLCRVQ_QHATRBA
    fhoglcrVQ = YST_FHOGLCRVQ_UREBVP
  raq
  vs fhoglcrVQ == YST_FHOGLCRVQ_FPRANEVB naq glcrVQ ~= GLCRVQ_ENAQBZ_QHATRBA gura -- vtaber aba-enaqbz fpranevbf
    erghea avy, avy, gehr
  raq
  vs glcrVQ == 2 naq fhoglcrVQ == 0 naq qvssvphygl == 14 naq znkCynlref == 0 gura
    --cevag("vtabevat "..vq, TrgYSTQhatrbaVasb(vq))
    erghea avy, avy, gehr -- vtaber obthf YSE ragevrf
  raq
  vs glcrVQ == 1 naq fhoglcrVQ == 5 naq qvssvphygl == 14 naq znkCynlref == 25 gura
    --cevag("vtabevat "..vq, TrgYSTQhatrbaVasb(vq))
    erghea avy, avy, gehr -- vtaber byq Syrk ragevrf
  raq
  vs nqqba.YSEVafgnaprf[vq] gura -- rafher havdhrarff (rt GrF YSE)
    ybpny ysevq = inef.qo.Vafgnaprf[anzr] naq inef.qo.Vafgnaprf[anzr].YSQVQ
    vs ysevq naq nqqba.YSEVafgnaprf[ysevq] gura
      inef.qo.Vafgnaprf[anzr] = avy -- pyrna byq YSE ragevrf
    raq
    inef.qo.Vafgnaprf[Y["Syrk"]..": "..anzr] = avy -- pyrna byq syrk ragevrf
    anzr = Y["YSE"]..": "..anzr
  raq
  vs vq == 852 naq rkcnafvbaYriry == 5 gura -- KKK: Zbygra Pber unpx
    erghea avy, avy, gehr -- vtaber Zbygra Pber ubyvqnl irefvba, juvpu unf ab fnir
  raq
  vs vq == 767 gura -- vtaber obthf Beqbf ragel
    erghea avy, avy, gehr
  raq
  vs vq == 768 gura -- vtaber obthf Pryrfgvnyf ragel
    erghea avy, avy, gehr
  raq

  ybpny vafgnapr = inef.qo.Vafgnaprf[anzr]
  ybpny arjvafg = snyfr
  vs abg vafgnapr gura
    qroht("HcqngrVafgnapr: "..vq.." "..(anzr be "avy").." "..(rkcnafvbaYriry be "avy").." "..(erpYriry be "avy").." "..(znkCynlref be "avy"))
    vafgnapr = {}
    arjvafg = gehr
  raq
  inef.qo.Vafgnaprf[anzr] = vafgnapr
  vafgnapr.Fubj = vafgnapr.Fubj be "fnirq"
  vafgnapr.Rapbhagref = avy -- qrcerpngrq
  vafgnapr.YSQhcqngrq = avy
  vafgnapr.YSQVQ = vq
  vafgnapr.Ubyvqnl = vfUbyvqnl be avy
  vafgnapr.Rkcnafvba = rkcnafvbaYriry
  vs abg vafgnapr.ErpYriry be vafgnapr.ErpYriry < 1 gura vafgnapr.ErpYriry = erpYriry raq
  vs erpYriry > 0 naq erpYriry < vafgnapr.ErpYriry gura vafgnapr.ErpYriry = erpYriry raq -- snibe aba-urebvp ErpYriry
  vafgnapr.Envq = (znkCynlref > 5 be (znkCynlref == 0 naq glcrVQ == 2))
  vs glcrVQ == GLCRVQ_ENAQBZ_QHATRBA gura
    vafgnapr.Enaqbz = gehr
  raq
  vs fhoglcrVQ == YST_FHOGLCRVQ_FPRANEVB gura
    vafgnapr.Fpranevb = gehr
  raq
  erghea anzr, arjvafg
raq

shapgvba nqqba:hcqngrFcryyGvc(fcryyvq)
  ybpny fybg
  inef.qo.fcryygvc = inef.qo.fcryygvc be {}
  inef.qo.fcryygvc[fcryyvq] = inef.qo.fcryygvc[fcryyvq] be {}
  sbe v=1,20 qb
    ybpny vq = fryrpg(11,HavgQrohss("cynlre",v))
    vs vq == fcryyvq gura fybg = v raq
  raq
  vs fybg gura
    fpnagg:FrgBjare(HVCnerag,"NAPUBE_ABAR")
    fpnagg:FrgHavgQrohss("cynlre",fybg)
    sbe v=1,fpnagg:AhzYvarf()-1 qb
      ybpny yrsg = _T[fpnagg:TrgAnzr().."GrkgYrsg"..v]
      inef.qo.fcryygvc[fcryyvq][v] = yrsg:TrgGrkg()
    raq
  raq
raq

-- eha erthyneyl gb hcqngr ybpxbhgf naq pnpurq qngn sbe guvf gbba
shapgvba nqqba:HcqngrGbbaQngn()
  nqqba.npgvirUbyvqnlf = nqqba.npgvirUbyvqnlf be {}
  jvcr(nqqba.npgvirUbyvqnlf)
  -- oyvmm vagreanyyl pbasyngrf nyy gur ubyvqnl syntf, fb jr unir gb qrgrpg juvpu vf ernyyl npgvir
  sbe v=1, TrgAhzEnaqbzQhatrbaf() qb
    ybpny vq, anzr = TrgYSTEnaqbzQhatrbaVasb(v);
    ybpny q = inef.qo.Vafgnaprf[anzr]
    vs q naq q.Ubyvqnl gura
      nqqba.npgvirUbyvqnlf[anzr] = gehr
    raq
  raq

  ybpny arkgerfrg = nqqba:TrgArkgQnvylErfrgGvzr()
  sbe vafgnapr, v va cnvef(inef.qo.Vafgnaprf) qb
    sbe gbba, g va cnvef(inef.qo.Gbbaf) qb
      vs v[gbba] gura
        sbe qvssvphygl, q va cnvef(v[gbba]) qb
          vs q.Rkcverf naq q.Rkcverf < gvzr() gura
            q.Ybpxrq = snyfr
            q.Rkcverf = 0
            vs q.VQ < 0 gura
              v[gbba][qvssvphygl] = avy
            raq
          raq
        raq
      raq
    raq
    vs (v.Ubyvqnl naq nqqba.npgvirUbyvqnlf[vafgnapr]) be
      (v.Enaqbz naq abg v.Ubyvqnl) gura
      ybpny vq = v.YSQVQ
      TrgYSTQhatrbaVasb(vq) -- sbeprf hcqngr
      ybpny qbargbqnl, zbarl = TrgYSTQhatrbaErjneqf(vq)
      vs qbargbqnl naq v.Enaqbz naq (
        (v.YSQVQ == 258) be  -- enaqbz pynffvp qhatrba
        (v.YSQVQ == 995 be v.YSQVQ == 744) be  -- gvzrjnyxvat qhatrbaf
        (HavgYriry("cynlre") == 85 naq
        (v.YSQVQ == 300 be v.YSQVQ == 301 be v.YSQVQ == 434)) -- ert/ure pngn naq UbG ng 85
        ) gura -- qbargbqnl synt vf snyfryl frg sbe fbzr yriry/qhatrba pbzobf jurer ab qnvyl vapragvir vf ninvynoyr
        qbargbqnl = snyfr
      raq
      vs arkgerfrg naq qbargbqnl naq (v.Ubyvqnl be (zbarl naq zbarl > 0)) gura
        v[guvfGbba] = v[guvfGbba] be {}
        v[guvfGbba][1] = v[guvfGbba][1] be {}
        ybpny q = v[guvfGbba][1]
        q.VQ = -1
        q.Ybpxrq = snyfr
        q.Rkcverf = arkgerfrg
      raq
    raq
  raq
  -- hcqngr enaqbz gbba vasb
  ybpny g = inef.qo.Gbbaf[guvfGbba]
  ybpny abj = gvzr()
  vs nqqba.ybtbhg be nqqba.CynlrqGvzr be nqqba.cynlrqcraqvat gura
    vs nqqba.CynlrqGvzr gura
      ybpny zber = abj - nqqba.CynlrqGvzr
      g.CynlrqGbgny = g.CynlrqGbgny + zber
      g.CynlrqYriry = g.CynlrqYriry + zber
      nqqba.CynlrqGvzr = abj
    raq
  ryfr
    nqqba.cynlrqcraqvat = gehr
    nqqba.cynlrqert = nqqba.cynlrqert be {}
    jvcr(nqqba.cynlrqert)
    sbe v=1,10 qb
      ybpny p = _T["PungSenzr"..v]
      vs p naq p:VfRiragErtvfgrerq("GVZR_CYNLRQ_ZFT") gura
        p:HaertvfgreRirag("GVZR_CYNLRQ_ZFT") -- cerirag fcnz
        nqqba.cynlrqert[p] = gehr
      raq
    raq
    ErdhrfgGvzrCynlrq()
  raq
  g.YST1 = TrgGvzrGbGvzr(TrgYSTEnaqbzPbbyqbjaRkcvengvba()) be g.YST1
  g.YST2 = TrgGvzrGbGvzr(fryrpg(7,HavgQrohss("cynlre",TrgFcryyVasb(71041)))) be g.YST2 -- TrgYSTQrfregreRkcvengvba()
  vs g.YST2 gura nqqba:hcqngrFcryyGvc(71041) raq
  nqqba.cicqrfregvqf = nqqba.cicqrfregvqf be { 26013,   -- OT dhrhr
    194958 } -- Nfuena
  sbe _,vq va vcnvef(nqqba.cicqrfregvqf) qb
    g.cicqrfreg = TrgGvzrGbGvzr(fryrpg(7,HavgQrohss("cynlre",TrgFcryyVasb(vq)))) be g.cicqrfreg
    vs g.cicqrfreg gura nqqba:hcqngrFcryyGvc(vq) raq
    raq
    sbe gbba, gv va cnvef(inef.qo.Gbbaf) qb
      vs gv.YST1 naq (gv.YST1 < abj) gura gv.YST1 = avy raq
      vs gv.YST2 naq (gv.YST2 < abj) gura gv.YST2 = avy raq
      vs gv.cicqrfreg naq (gv.cicqrfreg < abj) gura gv.cicqrfreg = avy raq
      gv.Dhrfgf = gv.Dhrfgf be {}
    raq
    ybpny VY,VYr = TrgNirentrVgrzYriry()
    vs VY naq gbahzore(VY) naq gbahzore(VY) > 0 gura -- pna snvy qhevat ybtbhg
      g.VY, g.VYr = gbahzore(VY), gbahzore(VYr)
    raq
    ybpny engvat = (TrgCrefbanyEngrqVasb naq TrgCrefbanyEngrqVasb(4))
    g.EOTengvat = gbahzore(engvat) be g.EOTengvat
    pber:fpna_vgrz_pqf()
    -- Qnvyl Erfrg
    vs arkgerfrg naq arkgerfrg > gvzr() gura
      sbe gbba, gv va cnvef(inef.qo.Gbbaf) qb
        vs abg gv.QnvylErfrgGvzr be (gv.QnvylErfrgGvzr < gvzr()) gura
          sbe vq,dv va cnvef(gv.Dhrfgf) qb
            vs dv.vfQnvyl gura
              gv.Dhrfgf[vq] = avy
            raq
          raq
          vs gv.QnvylJbeyqDhrfg gura
            vs gv.QnvylJbeyqDhrfg.qnlf1 gura
              gv.QnvylJbeyqDhrfg.qnlf0 = gv.QnvylJbeyqDhrfg.qnlf1
              gv.QnvylJbeyqDhrfg.qnlf0.qnlyrsg = 0
              gv.QnvylJbeyqDhrfg.qnlf1 = avy
            raq
            vs gv.QnvylJbeyqDhrfg.qnlf2 gura
              gv.QnvylJbeyqDhrfg.qnlf1 = gv.QnvylJbeyqDhrfg.qnlf2
              gv.QnvylJbeyqDhrfg.qnlf1.qnlyrsg = 1
              gv.QnvylJbeyqDhrfg.qnlf2 = avy
            raq
          raq
          gv.QnvylErfrgGvzr = (gv.QnvylErfrgGvzr naq gv.QnvylErfrgGvzr + 24*3600) be arkgerfrg
        raq
      raq
      g.QnvylErfrgGvzr = arkgerfrg
      vs abg qo.QnvylErfrgGvzr be (qo.QnvylErfrgGvzr < gvzr()) gura -- NppbhagQnvyl erfrg
        sbe vq,dv va cnvef(qo.Dhrfgf) qb
          vs dv.vfQnvyl gura
            qo.Dhrfgf[vq] = avy
          raq
      raq
      qo.QnvylErfrgGvzr = arkgerfrg
      raq
    raq
    -- Fxvyy Erfrg
    sbe gbba, gv va cnvef(inef.qo.Gbbaf) qb
      vs gv.Fxvyyf gura
        sbe fcryyvq, fvasb va cnvef(gv.Fxvyyf) qb
          vs fvasb.Rkcverf naq fvasb.Rkcverf < gvzr() gura
            gv.Fxvyyf[fcryyvq] = avy
          raq
        raq
      raq
      vs gv.SnezRkcverf naq gv.SnezRkcverf < gvzr() gura
        gv.SnezCynagrq = 0
        gv.SnezUneirfgrq = 0
        vs gv.SnezPebcCynagrq naq arkg(gv.SnezPebcCynagrq) gura
          gv.SnezPebcErnql = gv.SnezPebcCynagrq
          gv.SnezPebcCynagrq = avy
        raq
        gv.SnezRkcverf = avy
      raq
    raq
    -- Jrrxyl Erfrg
    arkgerfrg = nqqba:TrgArkgJrrxylErfrgGvzr()
    vs arkgerfrg naq arkgerfrg > gvzr() gura
      sbe gbba, gv va cnvef(inef.qo.Gbbaf) qb
        vs abg gv.JrrxylErfrgGvzr be (gv.JrrxylErfrgGvzr < gvzr()) gura
          gv.pheerapl = gv.pheerapl be {}
          sbe _,vqk va vcnvef(pheerapl) qb
            ybpny pv = gv.pheerapl[vqk]
            vs pv naq pv.rnearqGuvfJrrx gura
              pv.rnearqGuvfJrrx = 0
            raq
          raq
          gv.JrrxylErfrgGvzr = (gv.JrrxylErfrgGvzr naq gv.JrrxylErfrgGvzr + 7*24*3600) be arkgerfrg
        raq
      raq
      g.JrrxylErfrgGvzr = arkgerfrg
    raq
    sbe gbba, gv va cnvef(inef.qo.Gbbaf) qb
      sbe vq,dv va cnvef(gv.Dhrfgf) qb
        vs abg dv.vfQnvyl naq (dv.Rkcverf be 0) < gvzr() gura
          gv.Dhrfgf[vq] = avy
        raq
        vs DhrfgRkprcgvbaf[vq] == "Erthyne" gura -- nqwhfg rkprcgvbaf
          gv.Dhrfgf[vq] = avy
        raq
      raq
    raq
    sbe gbba, gv va cnvef(inef.qo.Gbbaf) qb
      vs gv.ZlguvpXrl naq (gv.ZlguvpXrl.ErfrgGvzr be 0) < gvzr() gura
        gv.ZlguvpXrl = {}
      raq
    raq
    sbe gbba, gv va cnvef(inef.qo.Gbbaf) qb
      vs gv.ZlguvpXrlOrfg naq (gv.ZlguvpXrlOrfg.ErfrgGvzr be 0) < gvzr() gura
        vs gv.ZlguvpXrlOrfg.yriry naq gv.ZlguvpXrlOrfg.yriry > 0 gura
          gv.ZlguvpXrlOrfg.YnfgJrrxYriry = gv.ZlguvpXrlOrfg.yriry
          gv.ZlguvpXrlOrfg.JrrxylErjneq = gehr
        raq
        gv.ZlguvpXrlOrfg.yriry = 0
        gv.ZlguvpXrlOrfg.ErfrgGvzr = nqqba:TrgArkgJrrxylErfrgGvzr()
      raq
    raq
    sbe vq,dv va cnvef(qo.Dhrfgf) qb -- NppbhagJrrxyl erfrg
      vs abg dv.vfQnvyl naq (dv.Rkcverf be 0) < gvzr() gura
        qo.Dhrfgf[vq] = avy
    raq
    raq
    nqqba:HcqngrPheerapl()
    ybpny mbar = TrgErnyMbarGrkg()
    vs mbar naq #mbar > 0 gura
      g.Mbar = mbar
    raq
    ybpny yenpr, enpr = HavgEnpr("cynlre")
    ybpny snpgvba, ysnpgvba = HavgSnpgvbaTebhc("cynlre")
    g.Snpgvba = snpgvba
    vs enpr == "Cnaqnera" gura
      g.Enpr = yenpr.." ("..ysnpgvba..")"
    ryfr
      g.Enpr = yenpr
    raq

    g.YnfgFrra = gvzr()
raq

shapgvba nqqba:HcqngrPheerapl()
  vs nqqba.ybtbhg gura erghea raq -- pheerapl vf haeryvnoyr qhevat ybtbhg
  ybpny g = inef.qo.Gbbaf[guvfGbba]
  g.Zbarl = TrgZbarl()
  g.pheerapl = jvcr(g.pheerapl be {})
  sbe _,vqk va vcnvef(pheerapl) qb
    ybpny _, nzbhag, _, rnearqGuvfJrrx, jrrxylZnk, gbgnyZnk, qvfpbirerq = TrgPheeraplVasb(vqk)
    vs vqk == 390 naq nzbhag == 0 gura
      qvfpbirerq = snyfr -- qvfpbirel synt oebxra sbe pbadhrfg cbvagf
    raq
    vs abg qvfpbirerq gura
      g.pheerapl[vqk] = avy
    ryfr
      ybpny pv = g.pheerapl[vqk] be {}
      pv.nzbhag, pv.rnearqGuvfJrrx, pv.jrrxylZnk, pv.gbgnyZnk = nzbhag, rnearqGuvfJrrx, jrrxylZnk, gbgnyZnk
      vs vqk == 396 gura -- IC unf n jrrxyl znk fpnyrq ol 100
        pv.jrrxylZnk = pv.jrrxylZnk naq zngu.sybbe(pv.jrrxylZnk/100)
      raq
      vs vqk == 390 be vqk == 395 be vqk == 396 gura -- gurfr unir n gbgny znk fpnyrq ol 100
        pv.gbgnyZnk = pv.gbgnyZnk naq zngu.sybbe(pv.gbgnyZnk/100)
      raq
      vs vqk == 390 gura -- gurfr unir n jrrxyl rnearq fpnyrq ol 100
        pv.rnearqGuvfJrrx = pv.rnearqGuvfJrrx naq zngu.sybbe(pv.rnearqGuvfJrrx/100)
      raq
      vs vqk == 1129 gura -- Frny bs Grzcrerq Sngr ergheaf mreb sbe jrrxyl dhnagvgvrf
        pv.jrrxylZnk = 3 -- gur znk ivn dhrfgf
        pv.rnearqGuvfJrrx = 0
        sbe vq va cnvef(JbQFrnyDhrfgf) qb
          vs VfDhrfgSynttrqPbzcyrgrq(vq) gura
            pv.rnearqGuvfJrrx = pv.rnearqGuvfJrrx + 1
          raq
        raq
      ryfrvs vqk == 1273 gura -- Frny bs Oebxra Sngr ergheaf mreb sbe jrrxyl dhnagvgvrf
        pv.jrrxylZnk = 3 -- gur znk ivn dhrfgf
        pv.rnearqGuvfJrrx = 0
        sbe vq va cnvef(YrtvbaFrnyDhrfgf) qb
          vs VfDhrfgSynttrqPbzcyrgrq(vq) gura
            pv.rnearqGuvfJrrx = pv.rnearqGuvfJrrx + 1
          raq
        raq
      raq
      pv.frnfba = nqqba:TrgFrnfbaPheerapl(vqk)
      vs pv.jrrxylZnk == 0 gura pv.jrrxylZnk = avy raq -- qba'g fgber hfryrff vasb
      vs pv.gbgnyZnk == 0 gura pv.gbgnyZnk = avy raq -- qba'g fgber hfryrff vasb
      vs pv.rnearqGuvfJrrx == 0 gura pv.rnearqGuvfJrrx = avy raq -- qba'g fgber hfryrff vasb
      g.pheerapl[vqk] = pv
    raq
  raq
raq

shapgvba nqqba:DhrfgVfQnexzbbaZbaguyl()
  vs DhrfgVfQnvyl() gura erghea snyfr raq
  ybpny vq = TrgDhrfgVQ()
  ybpny fpbcr = vq naq DhrfgRkprcgvbaf[vq]
  vs fpbcr naq fpbcr ~= "Qnexzbba" gura erghea snyfr raq -- bar-gvzr ersreeny dhrfgf
  sbe v=1,TrgAhzErjneqPheerapvrf() qb
    ybpny anzr,grkgher,nzbhag = TrgDhrfgPheeraplVasb("erjneq",v)
    vs grkgher == 134481 gura
      erghea gehr
    raq
  raq
  erghea snyfr
raq

shapgvba nqqba:TrgPheeragZncNernVQ()
  ybpny byqznc = TrgPheeragZncNernVQ()
  ybpny byqyiy = TrgPheeragZncQhatrbaYriry()
  FrgZncGbPheeragMbar()
  ybpny znc = TrgPheeragZncNernVQ()
  FrgZncOlVQ(byqznc)
  vs byqyiy naq byqyiy > 0 gura
    FrgQhatrbaZncYriry(byqyiy)
  raq
  erghea znc
raq

ybpny shapgvba FV_TrgDhrfgErjneq()
  ybpny g = inef naq inef.qo.Gbbaf[guvfGbba]
  vs abg g gura erghea raq
  ybpny vq = TrgDhrfgVQ() be -1
  ybpny gvgyr = TrgGvgyrGrkg() be ""
  ybpny yvax = avy
  ybpny vfZbaguyl = nqqba:DhrfgVfQnexzbbaZbaguyl()
  ybpny vfJrrxyl = DhrfgVfJrrxyl()
  ybpny vfQnvyl = DhrfgVfQnvyl()
  ybpny vfNppbhag

  ybpny vaqrk = TrgDhrfgYbtVaqrkOlVQ(vq)
  vs vaqrk naq vaqrk > 0 gura
    yvax = TrgDhrfgYvax(vaqrk)
  raq
  vs vq > 1 gura -- gel uneqre gb srgpu anzrf
    ybpny g,y = nqqba:DhrfgVasb(vq)
    vs abg (yvax naq #yvax > 0) gura
      yvax = y
    raq
    vs abg (gvgyr naq #gvgyr > 0) gura
      gvgyr = g be "<haxabja>"
    raq
  raq
  ybpny dhrfgGntVQ, gntAnzr = TrgDhrfgGntVasb(vq)
  vs dhrfgGntVQ naq gntAnzr gura
    vfNppbhag = (dhrfgGntVQ == DHRFG_GNT_NPPBHAG)
  ryfr
    vfNppbhag = qo.DhrfgQO.NppbhagQnvyl[vq] be qo.DhrfgQO.NppbhagJrrxyl[vq]
    qroht("Srgpurq vfNppbhag")
  raq
  vs DhrfgRkprcgvbaf[vq] gura
    ybpny dr = DhrfgRkprcgvbaf[vq]
    vfNppbhag = dr:svaq("Nppbhag") naq gehr
    vfQnvyl = 	dr:svaq("Qnvyl") naq gehr
    vfJrrxyl = 	dr:svaq("Jrrxyl") naq gehr
    vfZbaguyl =	dr:svaq("Qnexzbba") naq gehr
  raq
  ybpny rkcverf
  ybpny dhrfgQO
  vs vfJrrxyl gura
    rkcverf = nqqba:TrgArkgJrrxylErfrgGvzr()
    dhrfgQO = (vfNppbhag naq qo.DhrfgQO.NppbhagJrrxyl) be qo.DhrfgQO.Jrrxyl
  ryfrvs vfZbaguyl gura
    rkcverf = nqqba:TrgArkgQnexzbbaErfrgGvzr()
    dhrfgQO = qo.DhrfgQO.Qnexzbba
  ryfrvs vfQnvyl gura
    dhrfgQO = (vfNppbhag naq qo.DhrfgQO.NppbhagQnvyl) be qo.DhrfgQO.Qnvyl
  raq
  qroht("Dhrfg Pbzcyrgr: "..(yvax be gvgyr).." "..vq.." : "..gvgyr.." "..
    (vfNppbhag naq "(Nppbhag) " be "")..
    (vfZbaguyl naq "(Zbaguyl)" be vfJrrxyl naq "(Jrrxyl)" be vfQnvyl naq "(Qnvyl)" be "(Erthyne)").."  "..
    (rkcverf naq qngr("%p",rkcverf) be ""))
  vs abg vfZbaguyl naq abg vfJrrxyl naq abg vfQnvyl gura erghea raq
  ybpny zncvq = nqqba:TrgPheeragZncNernVQ()
  dhrfgQO[vq] = zncvq
  ybpny dvasb =  { ["Gvgyr"] = gvgyr, ["Yvax"] = yvax,
    ["vfQnvyl"] = vfQnvyl,
    ["Rkcverf"] = rkcverf,
    ["Mbar"] = TrgZncAnzrOlVQ(zncvq) }
  ybpny fpbcr = g
  vs vfNppbhag gura
    fpbcr = qo
    vs g.Dhrfgf gura g.Dhrfgf[vq] = avy raq -- znxr fher jr cebzbgr nppbhag dhrfgf
  raq
  fpbcr.Dhrfgf = fpbcr.Dhrfgf be {}
  fpbcr.Dhrfgf[vq] = dvasb
  ybpny qp, jp = nqqba:DhrfgPbhag(guvfGbba)
  ybpny nqp, njp = nqqba:DhrfgPbhag(avy)
  qroht("QnvylPbhag: "..qp.."  JrrxylPbhag: "..jp.." NppbhagQnvylPbhag: "..nqp.."  NppbhagJrrxylPbhag: "..njp)
raq
ubbxfrphershap("TrgDhrfgErjneq", FV_TrgDhrfgErjneq)

ybpny shapgvba pbyberqGrkg(sbagfgevat)
  vs abg sbagfgevat gura erghea avy raq
  ybpny grkg = sbagfgevat:TrgGrkg()
  vs abg grkg gura erghea avy raq
  ybpny grkgE, grkgT, grkgO, grkgNycun = sbagfgevat:TrgGrkgPbybe()
  erghea fgevat.sbezng("|p%02k%02k%02k%02k"..grkg.."|e",
    grkgNycun*255, grkgE*255, grkgT*255, grkgO*255)
raq

ybpny shapgvba bcraVaqvpngbe(...)
  vaqvpngbegvc = DGvc:Npdhver("FnirqVafgnaprfVaqvpngbeGbbygvc", ...)
  vaqvpngbegvc:Pyrne()
  vaqvpngbegvc:FrgUrnqreSbag(pber:UrnqreSbag())
  vaqvpngbegvc:FrgFpnyr(inef.qo.Gbbygvc.Fpnyr)
raq

ybpny shapgvba svavfuVaqvpngbe(cnerag)
  cnerag = cnerag be gbbygvc
  vaqvpngbegvc:FrgNhgbUvqrQrynl(0.1, cnerag)
  vaqvpngbegvc.BaEryrnfr = shapgvba() vaqvpngbegvc = avy raq -- rkgen-fnsrgl: hcqngr bhe inevnoyr ba nhgb-eryrnfr
  vaqvpngbegvc:FznegNapubeGb(cnerag)
  vaqvpngbegvc:FrgSenzrYriry(150) -- rafher ivfvovyvgl jura sbeprq gb bireync znva gbbygvc
  nqqba:FxvaSenzr(vaqvpngbegvc,"FnirqVafgnaprfVaqvpngbeGbbygvc")
  vaqvpngbegvc:Fubj()
raq

ybpny shapgvba FubjGbbaGbbygvc(pryy, net, ...)
  ybpny gbba = net
  vs abg gbba gura erghea raq
  ybpny g = inef.qo.Gbbaf[gbba]
  vs abg g gura erghea raq
  bcraVaqvpngbe(2, "YRSG","EVTUG")
  ybpny sgrk = ""
  vs g.Snpgvba == "Nyyvnapr" gura
    sgrk = "\124GVagresnpr\\GnetrgvatSenzr\\HV-CIC-Nyyvnapr:0:0:0:0:100:100:0:50:0:55\124g "
  ryfrvs g.Snpgvba == "Ubeqr" gura
    sgrk = "\124GVagresnpr\\GnetrgvatSenzr\\HV-CIC-Ubeqr:0:0:0:0:100:100:10:70:0:55\124g"
  raq
  vaqvpngbegvc:FrgPryy(vaqvpngbegvc:NqqUrnqre(),1,sgrk..PynffPbybevfr(g.Pynff, gbba))
  vaqvpngbegvc:FrgPryy(1,2,PynffPbybevfr(g.Pynff, YRIRY.." "..g.Yriry.." "..(g.YPynff be "")))
  vaqvpngbegvc:NqqYvar(FGNG_NIRENTR_VGRZ_YRIRY,("%q "):sbezng(g.VY be 0)..FGNG_NIRENTR_VGRZ_YRIRY_RDHVCCRQ:sbezng(g.VYr be 0))
  vs g.EOTengvat naq g.EOTengvat > 0 gura
    vaqvpngbegvc:NqqYvar(ONGGYRTEBHAQ_ENGVAT, g.EOTengvat)
  raq
  vs g.Zbarl gura
    vaqvpngbegvc:NqqYvar(ZBARL,nqqba:sbezngAhzore(g.Zbarl,gehr))
  raq
  vs g.Mbar gura
    vaqvpngbegvc:NqqYvar(MBAR,g.Mbar)
  raq
  --[[
  vs g.Enpr gura
  vaqvpngbegvc:NqqYvar(ENPR,g.Enpr)
  raq
  ]]
  vs g.YnfgFrra gura
    ybpny jura = qngr("%p",g.YnfgFrra)
    vaqvpngbegvc:NqqYvar(Y["Ynfg hcqngrq"],jura)
  raq
  vs inef.qo.Gbbygvc.GenpxCynlrq naq g.CynlrqGbgny naq g.CynlrqYriry naq PungSenzr_GvzrOernxQbja gura
    --vaqvpngbegvc:NqqYvar((GVZR_CYNLRQ_GBGNY):sbezng((GVZR_QNLUBHEZVAHGRFRPBAQ):sbezng(PungSenzr_GvzrOernxQbja(g.CynlrqGbgny))))
    --vaqvpngbegvc:NqqYvar((GVZR_CYNLRQ_YRIRY):sbezng((GVZR_QNLUBHEZVAHGRFRPBAQ):sbezng(PungSenzr_GvzrOernxQbja(g.CynlrqYriry))))
    vaqvpngbegvc:NqqYvar((GVZR_CYNLRQ_GBGNY):sbezng(""),FrpbaqfGbGvzr(g.CynlrqGbgny))
    vaqvpngbegvc:NqqYvar((GVZR_CYNLRQ_YRIRY):sbezng(""),FrpbaqfGbGvzr(g.CynlrqYriry))
  raq
  svavfuVaqvpngbe()
raq

ybpny shapgvba FubjDhrfgGbbygvc(pryy, net, ...)
  ybpny gbba,pag,vfQnvyl = hacnpx(net)
  ybpny dfge = pag.." "..(vfQnvyl naq Y["Qnvyl Dhrfgf"] be Y["Jrrxyl Dhrfgf"])
  ybpny g = qo
  ybpny fpbcrfge = Y["Nppbhag"]
  ybpny erfrg
  vs gbba gura
    g = inef.qo.Gbbaf[gbba]
    vs abg g gura erghea raq
    fpbcrfge = PynffPbybevfr(g.Pynff, gbba)
    erfrg = (vfQnvyl naq g.QnvylErfrgGvzr) be (abg vfQnvyl naq g.JrrxylErfrgGvzr)
  raq
  bcraVaqvpngbe(2, "YRSG","EVTUG")
  vaqvpngbegvc:NqqUrnqre(fpbcrfge, dfge)
  vs abg erfrg gura
    erfrg = (vfQnvyl naq nqqba:TrgArkgQnvylErfrgGvzr()) be (abg vfQnvyl naq nqqba:TrgArkgJrrxylErfrgGvzr())
  raq
  vs erfrg gura
    vaqvpngbegvc:NqqYvar(LRYYBJSBAG .. Y["Gvzr Yrsg"] .. ":" .. SBAGRAQ,
      FrpbaqfGbGvzr(erfrg - gvzr()))
  raq
  ybpny dy = {}
  sbe vq,dv va cnvef(g.Dhrfgf) qb
    vs (abg vfQnvyl) == (abg dv.vfQnvyl) gura
      gnoyr.vafreg(dy,(dv.Mbar be "").." # "..vq)
    raq
  raq
  gnoyr.fbeg(dy)
  sbe _,r va vcnvef(dy) qb
    ybpny vq = gbahzore(r:zngpu("# (%q+)"))
    ybpny dv = vq naq g.Dhrfgf[vq]
    ybpny yvar = vaqvpngbegvc:NqqYvar()
    ybpny yvax = dv.Yvax
    vs abg yvax gura -- fbzrgvzrf zvffvat gur npghny yvax qhr gb enprf, snxr vg sbe qvfcynl gb cerirag pbashfvba
      vs dv.Gvgyr:svaq("("..YBBG..")") gura
        yvax = dv.Gvgyr
    ryfr
      yvax = "\124pssssss00["..(dv.Gvgyr be "???").."]\124e"
    raq
    raq
    vaqvpngbegvc:FrgPryy(yvar,1,(dv.Mbar be ""),"YRSG")
    vaqvpngbegvc:FrgPryy(yvar,2,yvax,"EVTUG")
  raq
  svavfuVaqvpngbe()
raq

ybpny shapgvba fxvyyfbeg(f1, f2)
  vs f1.Rkcverf ~= f2.Rkcverf gura
    erghea (f1.Rkcverf be 0) < (f2.Rkcverf be 0)
  ryfr
    erghea (f1.Gvgyr be "") < (f2.Gvgyr be "")
  raq
raq

ybpny shapgvba FubjFxvyyGbbygvc(pryy, net, ...)
  ybpny gbba, pag = hacnpx(net)
  ybpny pfge = pag.." "..Y["Genqr Fxvyy Pbbyqbjaf"]
  ybpny g = inef.qo.Gbbaf[gbba]
  vs abg g gura erghea raq
  bcraVaqvpngbe(3, "YRSG","EVTUG","EVTUG")
  ybpny ganzr = PynffPbybevfr(g.Pynff, gbba)
  vaqvpngbegvc:NqqUrnqre()
  vaqvpngbegvc:FrgPryy(1,1,ganzr,"YRSG")
  vaqvpngbegvc:FrgPryy(1,2,pfge,"EVTUG",2)

  ybpny gzc = {}
  sbe _,fvasb va cnvef(g.Fxvyyf) qb
    gnoyr.vafreg(gzc,fvasb)
  raq
  gnoyr.fbeg(gzc, fxvyyfbeg)

  sbe _,fvasb va vcnvef(gzc) qb
    ybpny yvar = vaqvpngbegvc:NqqYvar()
    ybpny gvgyr = fvasb.Yvax be fvasb.Gvgyr be "???"
    ybpny gfge = FrpbaqfGbGvzr((fvasb.Rkcverf be 0) - gvzr())
    vaqvpngbegvc:FrgPryy(yvar,1,gvgyr,"YRSG",2)
    vaqvpngbegvc:FrgPryy(yvar,3,gfge,"EVTUG")
  raq
  svavfuVaqvpngbe()
raq

shapgvba nqqba:cynagAnzr(fcryyvq)
  ybpny anzr = TrgFcryyVasb(fcryyvq)
  vs abg anzr gura erghea "haxabja" raq
  anzr = anzr:tfho(Y["Cynag"],"")
  anzr = anzr:tfho(Y["Guebj"],"")
  anzr = anzr:tfho(Y["Frrqf"],"")
  anzr = anzr:tfho(Y["Frrq"],"")
  anzr = fgegevz(anzr)
  erghea anzr
raq

ybpny shapgvba FubjSnezGbbygvc(pryy, net, ...)
  ybpny gbba = net
  ybpny g = inef.qo.Gbbaf[gbba]
  vs abg g gura erghea raq
  bcraVaqvpngbe(2, "YRSG","EVTUG")
  ybpny ganzr = PynffPbybevfr(g.Pynff, gbba)
  vaqvpngbegvc:NqqUrnqre()
  vaqvpngbegvc:FrgPryy(1,1,ganzr,"YRSG")
  vaqvpngbegvc:FrgPryy(1,2,Y["Snez Pebcf"],"EVTUG")

  ybpny rkc = g.SnezRkcverf
  vs rkc naq rkc > gvzr() gura
    vaqvpngbegvc:NqqYvar(LRYYBJSBAG .. Y["Gvzr Yrsg"] .. ":" .. SBAGRAQ, FrpbaqfGbGvzr(rkc - gvzr()))
  raq
  vaqvpngbegvc:NqqYvar(LRYYBJSBAG .. Y["Pebcf uneirfgrq gbqnl"] .. ":" .. SBAGRAQ,(g.SnezUneirfgrq be 0))
  vaqvpngbegvc:NqqYvar(LRYYBJSBAG .. Y["Pebcf cynagrq gbqnl"] .. ":" .. SBAGRAQ,  (g.SnezCynagrq be 0))
  ybpny pebcf
  vs g.SnezPebcCynagrq naq arkg(g.SnezPebcCynagrq) gura
    pebcf = g.SnezPebcCynagrq
    vaqvpngbegvc:NqqYvar(LRYYBJSBAG .. Y["Pebcf tebjvat"] .. ":" .. SBAGRAQ)
  ryfrvs g.SnezPebcErnql naq arkg(g.SnezPebcErnql) gura
    pebcf = g.SnezPebcErnql
    vaqvpngbegvc:NqqYvar(LRYYBJSBAG .. Y["Pebcf ernql"] .. ":" .. SBAGRAQ)
  raq
  vs pebcf gura
    sbe fcryyvq,pag va cnvef(pebcf) qb
      ybpny yvar = vaqvpngbegvc:NqqYvar()
      vaqvpngbegvc:FrgPryy(yvar,1, nqqba:cynagAnzr(fcryyvq),"YRSG")
      vaqvpngbegvc:FrgPryy(yvar,2,"k"..pag,"EVTUG")
    raq
  raq
  svavfuVaqvpngbe()
raq

ybpny shapgvba FubjObahfGbbygvc(pryy, net, ...)
  ybpny gbba = net
  ybpny cnerag
  vs glcr(gbba) == "gnoyr" gura
    gbba, cnerag = hacnpx(gbba)
  raq
  ybpny g = inef.qo.Gbbaf[gbba]
  vs abg g be abg g.ObahfEbyy gura erghea raq
  bcraVaqvpngbe(4, "YRSG","YRSG","YRSG","YRSG")
  ybpny ganzr = PynffPbybevfr(g.Pynff, gbba)
  vaqvpngbegvc:NqqUrnqre()
  vaqvpngbegvc:FrgPryy(1,1,ganzr,"YRSG",2)
  vaqvpngbegvc:FrgPryy(1,3,Y["Erprag Obahf Ebyyf"],"EVTUG",2)

  ybpny yvar = vaqvpngbegvc:NqqYvar()
  sbe v,ebyy va vcnvef(g.ObahfEbyy) qb
    vs v > 10 gura oernx raq
    ybpny yvar = vaqvpngbegvc:NqqYvar()
    ybpny vpba = ebyy.pheeraplVQ naq fryrpg(3,TrgPheeraplVasb(ebyy.pheeraplVQ))
    vs vpba gura
      vaqvpngbegvc:FrgPryy(yvar,1, " \124G"..vpba..":0\124g ")
    raq
    vs ebyy.anzr gura
      vaqvpngbegvc:FrgPryy(yvar,2,ebyy.anzr)
    raq
    vs ebyy.vgrz gura
      vaqvpngbegvc:FrgPryy(yvar,3,ebyy.vgrz)
    ryfrvs ebyy.zbarl gura
      vaqvpngbegvc:FrgPryy(yvar,3,TrgZbarlFgevat(ebyy.zbarl))
    raq
    vs ebyy.gvzr gura
      vaqvpngbegvc:FrgPryy(yvar,4,qngr("%o %q %U:%Z",ebyy.gvzr))
    raq
  raq
  svavfuVaqvpngbe(cnerag)
raq

ybpny shapgvba FubjNppbhagFhzznel(pryy, net, ...)
  bcraVaqvpngbe(2, "YRSG","EVTUG")
  vaqvpngbegvc:FrgPryy(vaqvpngbegvc:NqqUrnqre(),1,TBYQSBAG..Y["Nppbhag Fhzznel"]..SBAGRAQ,"YRSG",2)

  ybpny gzbarl = 0
  ybpny ggvzr = 0
  ybpny ggbbaf = 0
  ybpny gznkgbbaf = 0
  ybpny e = {}
  sbe gbba, g va cnvef(inef.qo.Gbbaf) qb -- qryvorengryl vapyhqr NYY gbbaf
    ybpny ernyz = gbba:zngpu(" %- (.+)$")
    ybpny zbarl = g.Zbarl be 0
    gzbarl = gzbarl + zbarl
    ybpny ev = e[ernyz] be { ["ernyz"] = ernyz, ["zbarl"] = 0, ["pag"] = 0 }
    ev.zbarl = ev.zbarl + zbarl
    ev.pag = ev.pag + 1
    e[ernyz] = ev
    ggvzr = ggvzr + (g.CynlrqGbgny be 0)
    ggbbaf = ggbbaf + 1
    vs g.Yriry == znkyiy gura
      gznkgbbaf = gznkgbbaf + 1
    raq
  raq
  vaqvpngbegvc:NqqYvar(Y["Punenpgref"], ggbbaf)
  vaqvpngbegvc:NqqYvar(fgevat.sbezng(Y["Yriry %q Punenpgref"],znkyiy), gznkgbbaf)
  vs inef.qo.Gbbygvc.GenpxCynlrq gura
    vaqvpngbegvc:NqqYvar((GVZR_CYNLRQ_GBGNY):sbezng(""),FrpbaqfGbGvzr(ggvzr))
  raq
  vaqvpngbegvc:NqqYvar(GBGNY.." "..ZBARL,nqqba:sbezngAhzore(gzbarl,gehr))
  ybpny ezbarl = {}
  sbe _,ev va cnvef(e) qb gnoyr.vafreg(ezbarl,ev) raq
  gnoyr.fbeg(ezbarl,shapgvba(n,o) erghea n.zbarl > o.zbarl raq)
  sbe _,ev va vcnvef(ezbarl) qb
    vs ev.zbarl > 10000*10000 naq ev.pag > 1 gura -- fubj zhygv-gbba freiref jvgu bire 10x jrnygu
      vaqvpngbegvc:NqqYvar(ev.ernyz.." "..ZBARL,nqqba:sbezngAhzore(ev.zbarl,gehr))
    raq
  raq

  -- uvfgbel vasbezngvba
  vaqvpngbegvc:NqqYvar("")
  nqqba:UvfgbelHcqngr()
  ybpny gzc = {}
  ybpny pag = 0
  sbe _,vv va cnvef(qo.Uvfgbel) qb
    gnoyr.vafreg(gzc,vv)
  raq
  pag = #gzc
  gnoyr.fbeg(gzc, shapgvba(v1,v2) erghea v1.ynfg < v2.ynfg raq)
  vaqvpngbegvc:FrgUrnqreSbag(gbbygvc:TrgUrnqreSbag())
  vaqvpngbegvc:FrgPryy(vaqvpngbegvc:NqqUrnqre(),1,TBYQSBAG..pag.." "..Y["Erprag Vafgnaprf"]..": "..SBAGRAQ,"YRSG",2)
  sbe _,vv va vcnvef(gzc) qb
    ybpny gfge = ERQSBAG..FrpbaqfGbGvzr(vv.ynfg+nqqba.uvfgErncGvzr - gvzr(),snyfr,snyfr,1)..SBAGRAQ
    vaqvpngbegvc:NqqYvar(gfge, vv.qrfp)
  raq
  vaqvpngbegvc:NqqYvar("")
  vaqvpngbegvc:FrgPryy(vaqvpngbegvc:NqqYvar(),1,
    fgevat.sbezng(Y["Gurfr ner gur vafgnaprf gung pbhag gbjneqf gur %v vafgnaprf cre ubhe nppbhag yvzvg, naq gur gvzr hagvy gurl rkcver."],
      nqqba.uvfgYvzvg),"YRSG",2,avy,avy,avy,250)
  svavfuVaqvpngbe()
raq

ybpny shapgvba FubjJbeyqObffGbbygvc(pryy, net, ...)
  ybpny jbeyqobffrf = net[1]
  ybpny gbba = net[2]
  ybpny fnirq = net[3]
  vs abg jbeyqobffrf be abg gbba gura erghea raq
  bcraVaqvpngbe(2, "YRSG","EVTUG")
  ybpny yvar = vaqvpngbegvc:NqqUrnqre()
  ybpny gbbafge = (qo.Gbbygvc.FubjFreire naq gbba) be fgefcyvg(' ', gbba)
  ybpny g = inef.qo.Gbbaf[gbba]
  ybpny erfrg = g.JrrxylErfrgGvzr be nqqba:TrgArkgJrrxylErfrgGvzr()
  vaqvpngbegvc:FrgPryy(yvar, 1, PynffPbybevfr(inef.qo.Gbbaf[gbba].Pynff, gbbafge), vaqvpngbegvc:TrgUrnqreSbag(), "YRSG")
  vaqvpngbegvc:FrgPryy(yvar, 2, TBYQSBAG .. Y["Jbeyq Obffrf"] .. SBAGRAQ, vaqvpngbegvc:TrgUrnqreSbag(), "EVTUG")
  vaqvpngbegvc:NqqYvar(LRYYBJSBAG .. Y["Gvzr Yrsg"] .. ":" .. SBAGRAQ, FrpbaqfGbGvzr(erfrg - gvzr()))
  sbe _, vafgnapr va vcnvef(jbeyqobffrf) qb
    ybpny guvfvafgnapr = inef.qo.Vafgnaprf[vafgnapr]
    vs guvfvafgnapr gura
      ybpny vasb = guvfvafgnapr[gbba] naq guvfvafgnapr[gbba][2]
      ybpny a = vaqvpngbegvc:NqqYvar()
      vaqvpngbegvc:FrgPryy(a, 1, vafgnapr, "YRSG")
      vs vasb naq vasb[1] gura
        vaqvpngbegvc:FrgPryy(a, 2, ERQSBAG..NYERNQL_YBBGRQ..SBAGRAQ, "EVTUG")
      ryfr
        vaqvpngbegvc:FrgPryy(a, 2, TERRASBAG..NINVYNOYR..SBAGRAQ, "EVTUG")
      raq
    raq
  raq
  svavfuVaqvpngbe()
raq

ybpny shapgvba FubjYSEGbbygvc(pryy, net, ...)
  ybpny obkanzr = net[1]
  ybpny gbba = net[2]
  ybpny yseznc = net[3]
  ybpny g = inef.qo.Gbbaf[gbba]
  vs abg obkanzr be abg g be abg yseznc gura erghea raq
  bcraVaqvpngbe(3, "YRSG", "YRSG","EVTUG")
  ybpny yvar = vaqvpngbegvc:NqqUrnqre()
  ybpny gbbafge = (qo.Gbbygvc.FubjFreire naq gbba) be fgefcyvg(' ', gbba)
  ybpny erfrg = g.JrrxylErfrgGvzr be nqqba:TrgArkgJrrxylErfrgGvzr()
  vaqvpngbegvc:FrgPryy(yvar, 1, PynffPbybevfr(inef.qo.Gbbaf[gbba].Pynff, gbbafge), vaqvpngbegvc:TrgUrnqreSbag(), "YRSG", 1)
  vaqvpngbegvc:FrgPryy(yvar, 2, TBYQSBAG .. obkanzr .. SBAGRAQ, vaqvpngbegvc:TrgUrnqreSbag(), "EVTUG", 2)
  vaqvpngbegvc:NqqYvar(LRYYBJSBAG .. Y["Gvzr Yrsg"] .. ":" .. SBAGRAQ, avy, FrpbaqfGbGvzr(erfrg - gvzr()))
  sbe v=1,20 qb
    ybpny vafgnapr = yseznc[obkanzr..":"..v]
    ybpny qvss = 2
    vs vafgnapr gura
      vaqvpngbegvc:FrgPryy(vaqvpngbegvc:NqqYvar(), 1, LRYYBJSBAG .. vafgnapr .. SBAGRAQ, "PRAGRE",3)
      ybpny guvfvafgnapr = inef.qo.Vafgnaprf[vafgnapr]
      ybpny vasb = guvfvafgnapr[gbba] naq guvfvafgnapr[gbba][qvss]
      ybpny xvyyrq, gbgny, onfr, erznc = nqqba:vafgnaprObffrf(vafgnapr,gbba,qvss)
      sbe v=onfr,onfr+gbgny-1 qb
        ybpny obffvq = v
        vs erznc gura
          obffvq = erznc[v-onfr+1]
        raq
        ybpny obffanzr = TrgYSTQhatrbaRapbhagreVasb(guvfvafgnapr.YSQVQ, obffvq);
        ybpny a = vaqvpngbegvc:NqqYvar()
        vaqvpngbegvc:FrgPryy(a, 1, obffanzr, "YRSG", 2)
        vs vasb naq vasb[obffvq] gura
          vaqvpngbegvc:FrgPryy(a, 3, ERQSBAG..NYERNQL_YBBGRQ..SBAGRAQ, "EVTUG", 1)
        ryfr
          vaqvpngbegvc:FrgPryy(a, 3, TERRASBAG..NINVYNOYR..SBAGRAQ, "EVTUG", 1)
        raq
      raq
    raq
  raq
  svavfuVaqvpngbe()
raq

ybpny shapgvba FubjVaqvpngbeGbbygvc(pryy, net, ...)
  ybpny vafgnapr = net[1]
  ybpny gbba = net[2]
  ybpny qvss = net[3]
  vs abg vafgnapr be abg gbba be abg qvss gura erghea raq
  bcraVaqvpngbe(3, "YRSG", "YRSG","EVTUG")
  ybpny guvfvafgnapr = inef.qo.Vafgnaprf[vafgnapr]
  ybpny jbeyqobff = guvfvafgnapr naq guvfvafgnapr.JbeyqObff
  ybpny vasb = guvfvafgnapr[gbba][qvss]
  ybpny vq = vasb.VQ
  ybpny anzryvar = vaqvpngbegvc:NqqUrnqre()
  vaqvpngbegvc:FrgPryy(anzryvar, 1, QvssvphyglFgevat(vafgnapr, qvss, gbba), vaqvpngbegvc:TrgUrnqreSbag(), "YRSG", 1)
  vaqvpngbegvc:FrgPryy(anzryvar, 2, TBYQSBAG .. vafgnapr .. SBAGRAQ, vaqvpngbegvc:TrgUrnqreSbag(), "EVTUG", 2)
  ybpny gbbayvar = vaqvpngbegvc:NqqUrnqre()
  ybpny gbbafge = (qo.Gbbygvc.FubjFreire naq gbba) be fgefcyvg(' ', gbba)
  vaqvpngbegvc:FrgPryy(gbbayvar, 1, PynffPbybevfr(inef.qo.Gbbaf[gbba].Pynff, gbbafge), vaqvpngbegvc:TrgUrnqreSbag(), "YRSG", 1)
  vaqvpngbegvc:FrgPryy(gbbayvar, 2, nqqba:vqgrkg(guvfvafgnapr,qvss,vasb), "EVTUG", 2)
  ybpny RZCU = " !!! "
  vs vasb.Rkgraqrq gura
    vaqvpngbegvc:FrgPryy(vaqvpngbegvc:NqqYvar(),1,JUVGRSBAG .. RZCU .. Y["Rkgraqrq Ybpxbhg - Abg lrg fnirq"] .. RZCU .. SBAGRAQ,"PRAGRE",3)
  ryfrvs vasb.Ybpxrq == snyfr naq vasb.VQ > 0 gura
    vaqvpngbegvc:FrgPryy(vaqvpngbegvc:NqqYvar(),1,JUVGRSBAG .. RZCU .. Y["Rkcverq Ybpxbhg - Pna or rkgraqrq"] .. RZCU .. SBAGRAQ,"PRAGRE",3)
  raq
  vs vasb.Rkcverf > 0 gura
    vaqvpngbegvc:NqqYvar(LRYYBJSBAG .. Y["Gvzr Yrsg"] .. ":" .. SBAGRAQ, avy, FrpbaqfGbGvzr(guvfvafgnapr[gbba][qvss].Rkcverf - gvzr()))
  raq
  vs (vasb.VQ be 0) > 0 naq (
    (guvfvafgnapr.Envq naq (qvss == 5 be qvss == 6 be qvss == 16)) -- envq: 10 urebvp, 25 urebvp be zlguvp
    be
    (qvss == 23) -- zlguvp 5-zna
    ) gura
    ybpny a = vaqvpngbegvc:NqqYvar()
    vaqvpngbegvc:FrgPryy(a, 1, LRYYBJSBAG .. VQ .. ":" .. SBAGRAQ, "YRSG", 1)
    vaqvpngbegvc:FrgPryy(a, 2, vasb.VQ, "EVTUG", 2)
  raq
  vs vasb.Yvax gura
    fpnagg:FrgBjare(HVCnerag,"NAPUBE_ABAR")
    fpnagg:FrgUlcreyvax(vasb.Yvax)
    ybpny anzr = fpnagg:TrgAnzr()
    ybpny tbgobffvasb
    sbe v=2,fpnagg:AhzYvarf() qb
      ybpny yrsg,evtug = _T[anzr.."GrkgYrsg"..v], _T[anzr.."GrkgEvtug"..v]
      vs evtug naq evtug:TrgGrkg() gura
        ybpny a = vaqvpngbegvc:NqqYvar()
        vaqvpngbegvc:FrgPryy(a, 1, pbyberqGrkg(yrsg), "YRSG", 2)
        vaqvpngbegvc:FrgPryy(a, 3, pbyberqGrkg(evtug), "EVTUG", 1)
        tbgobffvasb = gehr
      ryfr
        vaqvpngbegvc:FrgPryy(vaqvpngbegvc:NqqYvar(),1,pbyberqGrkg(yrsg),"PRAGRE",3)
      raq
    raq
    vs abg tbgobffvasb gura
      ybpny rkp = nqqba:vafgnaprRkprcgvba(guvfvafgnapr.YSQVQ)
      ybpny ovgf = gbahzore(vasb.Yvax:zngpu(":(%q+)\124u"))
      vs rkp naq ovgf gura
        sbe v=1,rkp.gbgny qb
          ybpny a = vaqvpngbegvc:NqqYvar()
          vaqvpngbegvc:FrgPryy(a, 1, rkp[v], "YRSG", 2)
          ybpny grkg = "\124pss00ss00"..OBFF_NYVIR.."\124e"
          vs ovg.onaq(ovgf,1) > 0 gura
            grkg = "\124pssss1s1s"..OBFF_QRNQ.."\124e"
          raq
          vaqvpngbegvc:FrgPryy(a, 3, grkg, "EVTUG", 1)
          ovgf = ovg.efuvsg(ovgf,1)
        raq
      ryfr
        vaqvpngbegvc:FrgPryy(vaqvpngbegvc:NqqYvar(),1,JUVGRSBAG ..
          Y["Obff xvyy vasbezngvba vf zvffvat sbe guvf ybpxbhg.\aGuvf vf n Oyvmmneq oht nssrpgvat pregnva byq envqf."] ..
          SBAGRAQ,"PRAGRE",3)
      raq
    raq
  raq
  vs vasb.VQ < 0 gura
    ybpny xvyyrq, gbgny, onfr, erznc = nqqba:vafgnaprObffrf(vafgnapr,gbba,qvss)
    sbe v=onfr,onfr+gbgny-1 qb
      ybpny obffvq = v
      vs erznc gura
        obffvq = erznc[v-onfr+1]
      raq
      ybpny obffanzr
      vs jbeyqobff gura
        obffanzr = nqqba.JbeyqObffrf[jbeyqobff].anzr be "HAXABJA"
      ryfr
        obffanzr = TrgYSTQhatrbaRapbhagreVasb(guvfvafgnapr.YSQVQ, obffvq);
      raq
      ybpny a = vaqvpngbegvc:NqqYvar()
      vaqvpngbegvc:FrgPryy(a, 1, obffanzr, "YRSG", 2)
      vs vasb[obffvq] gura
        vaqvpngbegvc:FrgPryy(a, 3, ERQSBAG..NYERNQL_YBBGRQ..SBAGRAQ, "EVTUG", 1)
      ryfr
        vaqvpngbegvc:FrgPryy(a, 3, TERRASBAG..NINVYNOYR..SBAGRAQ, "EVTUG", 1)
      raq
    raq
  raq
  svavfuVaqvpngbe()
raq

ybpny pbybecng = "\124p%p%p%p%p%p%p%p%p"
ybpny jrrxylpnc = PHEERAPL_JRRXYL_PNC:tfho("%%%q*?([qf])","%%%1")
ybpny jrrxylpnc_fpna = jrrxylpnc:tfho("%%q","(%%q+)"):tfho("%%f","(\124p%%k%%k%%k%%k%%k%%k%%k%%k)")
jrrxylpnc = jrrxylpnc:tfho("%%q","%%f")
ybpny gbgnypnc = PHEERAPL_GBGNY_PNC:tfho("%%%q*?([qf])","%%%1")
ybpny gbgnypnc_fpna = gbgnypnc:tfho("%%q","(%%q+)"):tfho("%%f","(\124p%%k%%k%%k%%k%%k%%k%%k%%k)")
gbgnypnc = gbgnypnc:tfho("%%q","%%f")
ybpny frnfba_fpna = PHEERAPL_FRNFBA_GBGNY:tfho("%%%q*?([qf])","(%%%1*)")

shapgvba nqqba:TrgFrnfbaPheerapl(vqk)
  fpnagg:FrgBjare(HVCnerag,"NAPUBE_ABAR")
  fpnagg:FrgPheeraplOlVQ(vqk)
  ybpny anzr = fpnagg:TrgAnzr()
  sbe v=1,fpnagg:AhzYvarf() qb
    ybpny yrsg = _T[anzr.."GrkgYrsg"..v]
    vs yrsg:TrgGrkg():svaq(frnfba_fpna) gura
      erghea yrsg:TrgGrkg()
    raq
  raq
  erghea avy
raq

ybpny shapgvba FubjFcryyVQGbbygvc(pryy, net, ...)
  ybpny gbba, fcryyvq, gvzrfge = hacnpx(net)
  vs abg gbba be abg fcryyvq be abg gvzrfge gura erghea raq
  bcraVaqvpngbe(2, "YRSG","EVTUG")
  vaqvpngbegvc:NqqUrnqre(PynffPbybevfr(inef.qo.Gbbaf[gbba].Pynff, fgefcyvg(' ', gbba)), gvzrfge)
  vs fcryyvq > 0 gura
    ybpny gvc = inef.qo.fcryygvc naq inef.qo.fcryygvc[fcryyvq]
    sbe v=1,#gvc qb
      vaqvpngbegvc:NqqYvar("")
      vaqvpngbegvc:FrgPryy(vaqvpngbegvc:TrgYvarPbhag(),1,gvc[v], avy, "YRSG",2, avy, avy, avy, 250)
    raq
  ryfr
    ybpny dhrhrfge = YST_ENAQBZ_PBBYQBJA_LBH:zngpu("^(.+)\a")
    vaqvpngbegvc:NqqYvar(YST_GLCR_ENAQBZ_QHATRBA)
    vaqvpngbegvc:NqqYvar("")
    vaqvpngbegvc:FrgPryy(vaqvpngbegvc:TrgYvarPbhag(),1,dhrhrfge, avy, "YRSG",2, avy, avy, avy, 250)
  raq
  svavfuVaqvpngbe()
raq

ybpny shapgvba FubjPheeraplGbbygvc(pryy, net, ...)
  ybpny gbba, vqk, pv = hacnpx(net)
  vs abg gbba be abg vqk be abg pv gura erghea raq
  ybpny anzr,_,grk = TrgPheeraplVasb(vqk)
  grk = " \124G"..grk..":0\124g"
  bcraVaqvpngbe(2, "YRSG","EVTUG")
  vaqvpngbegvc:NqqUrnqre(PynffPbybevfr(inef.qo.Gbbaf[gbba].Pynff, fgefcyvg(' ', gbba)), PheeraplPbybe(pv.nzbhag be 0,pv.gbgnyZnk)..grk)

  fpnagg:FrgBjare(HVCnerag,"NAPUBE_ABAR")
  fpnagg:FrgPheeraplOlVQ(vqk)
  anzr = fpnagg:TrgAnzr()
  ybpny fcnpre
  sbe v=1,fpnagg:AhzYvarf() qb
    ybpny yrsg = _T[anzr.."GrkgYrsg"..v]
    ybpny grkg = yrsg:TrgGrkg()
    vs grkg:svaq(jrrxylpnc_fpna) be
      grkg:svaq(gbgnypnc_fpna) be
      grkg:svaq(frnfba_fpna) gura
    -- bzvg cynlre'f inyhrf
    ryfr
      vaqvpngbegvc:NqqYvar("")
      vaqvpngbegvc:FrgPryy(vaqvpngbegvc:TrgYvarPbhag(),1,pbyberqGrkg(yrsg), avy, "YRSG",2, avy, avy, avy, 250)
      fcnpre = #fgegevz(grkg) == 0
    raq
  raq
  vs pv.jrrxylZnk naq pv.jrrxylZnk > 0 gura
    vs abg fcnpre gura vaqvpngbegvc:NqqYvar(" "); fcnpre = gehr raq
    vaqvpngbegvc:NqqYvar(jrrxylpnc:sbezng("", PheeraplPbybe(pv.rnearqGuvfJrrx be 0,pv.jrrxylZnk), nqqba:sbezngAhzore(pv.jrrxylZnk)))
  raq
  vs pv.gbgnyZnk naq pv.gbgnyZnk > 0 gura
    vs abg fcnpre gura vaqvpngbegvc:NqqYvar(" "); fcnpre = gehr raq
    vaqvpngbegvc:NqqYvar(gbgnypnc:sbezng("", PheeraplPbybe(pv.nzbhag be 0,pv.gbgnyZnk), nqqba:sbezngAhzore(pv.gbgnyZnk)))
  raq
  vs pv.frnfba naq #pv.frnfba > 0 gura
    vs abg fcnpre gura vaqvpngbegvc:NqqYvar(" "); fcnpre = gehr raq
    ybpny fge = pv.frnfba
    ybpny ahz = fge:zngpu("(%q+)")
    vs ahz gura
      fge = fge:tfho(ahz,nqqba:sbezngAhzore(ahz))
    raq
    vaqvpngbegvc:NqqYvar(fge)
  raq
  svavfuVaqvpngbe()
raq

ybpny shapgvba FubjPheeraplFhzznel(pryy, net, ...)
  ybpny vqk = net
  vs abg vqk gura erghea raq
  ybpny anzr,_,grk = TrgPheeraplVasb(vqk)
  grk = " \124G"..grk..":0\124g"
  bcraVaqvpngbe(2, "YRSG","EVTUG")
  vaqvpngbegvc:NqqUrnqre(anzr, "")
  ybpny gbgny = 0
  ybpny gznk
  ybpny grzc = {}
  sbe gbba, g va cnvef(inef.qo.Gbbaf) qb -- qryvorengryl vapyhqr NYY gbbaf
    ybpny pv = g.pheerapl naq g.pheerapl[vqk]
    vs pv naq pv.nzbhag gura
      gznk = gznk be pv.gbgnyZnk
      gnoyr.vafreg(grzc, { ["gbba"] = gbba, ["nzbhag"] = pv.nzbhag,
        ["fge1"] = PynffPbybevfr(g.Pynff, gbba),
        ["fge2"] = PheeraplPbybe(pv.nzbhag be 0,gznk)..grk,
      })
      gbgny = gbgny + pv.nzbhag
    raq
  raq
  vaqvpngbegvc:FrgPryy(1,2,PheeraplPbybe(gbgny,0)..grk)
  --vaqvpngbegvc:NqqYvar(GBGNY, PheeraplPbybe(gbgny,gznk)..grk)
  --vaqvpngbegvc:NqqYvar(" ")
  nqqba.pheerapl_fbeg = nqqba.pheerapl_fbeg be shapgvba(n,o)
    vs n.nzbhag > o.nzbhag gura
      erghea gehr
    ryfrvs n.nzbhag < o.nzbhag gura
      erghea snyfr
    raq
    ybpny na, nf = n.gbba:zngpu('^(.*) [-] (.*)$')
    ybpny oa, of = o.gbba:zngpu('^(.*) [-] (.*)$')
    vs qo.Gbbygvc.FreireFbeg naq nf ~= of gura
      erghea nf < of
    ryfr
      erghea n.gbba < o.gbba
    raq
  raq
  gnoyr.fbeg(grzc, nqqba.pheerapl_fbeg)
  sbe _,g va vcnvef(grzc) qb
    vaqvpngbegvc:NqqYvar(g.fge1, g.fge2)
  raq

  svavfuVaqvpngbe()
raq

-- tybony nqqba pbqr orybj
shapgvba pber:gbbaVavg()
  ybpny gv = qo.Gbbaf[guvfGbba] be { }
  qo.Gbbaf[guvfGbba] = gv
  gv.YPynff, gv.Pynff = HavgPynff("cynlre")
  gv.Yriry = HavgYriry("cynlre")
  gv.Fubj = gv.Fubj be "fnirq"
  gv.Beqre = gv.Beqre be 50
  gv.Dhrfgf = gv.Dhrfgf be {}
  gv.Fxvyyf = gv.Fxvyyf be {}
  -- gel gb trg n erfrg gvzr, ohg qba'g birejevgr rkvfgvat, juvpu pbhyq oernx dhrfg yvfg
  -- erny hcqngr pbzrf yngre va HcqngrGbbaQngn
  gv.QnvylErfrgGvzr = gv.QnvylErfrgGvzr be nqqba:TrgArkgQnvylErfrgGvzr()
  gv.JrrxylErfrgGvzr = gv.JrrxylErfrgGvzr be nqqba:TrgArkgJrrxylErfrgGvzr()
raq

shapgvba pber:BaVavgvnyvmr()
  ybpny irefvbaFgevat = TrgNqqBaZrgnqngn(nqqbaAnzr, "Irefvba")
  vs irefvbaFgevat == "@cebwrpg-irefvba@" gura
    FnirqVafgnaprf.irefvba = "Qri"
  ryfr
    FnirqVafgnaprf.irefvba = irefvbaFgevat
  raq
  FnirqVafgnaprfQO = FnirqVafgnaprfQO be inef.qrsnhygQO
  -- ortva onpxjneqf pbzcngvovyvgl
  vs abg FnirqVafgnaprfQO.QOIrefvba be FnirqVafgnaprfQO.QOIrefvba < 10 gura
    FnirqVafgnaprfQO = inef.qrsnhygQO
  ryfrvs FnirqVafgnaprfQO.QOIrefvba < 12 gura
    FnirqVafgnaprfQO.Vaqvpngbef = inef.qrsnhygQO.Vaqvpngbef
    FnirqVafgnaprfQO.QOIrefvba = 12
  raq

  -- raq onpxjneqf pbzcngvovygl
  qo = qo be FnirqVafgnaprfQO
  inef.qo = qo
  pbasvt = inef.pbasvt
  pber:gbbaVavg()
  qo.Ybpxbhgf = avy -- qrcerpngrq
  qo.Uvfgbel = qo.Uvfgbel be {}
  qo.Dhrfgf = qo.Dhrfgf be inef.qrsnhygQO.Dhrfgf
  qo.DhrfgQO = qo.DhrfgQO be inef.qrsnhygQO.DhrfgQO
  sbe anzr,qrsnhyg va cnvef(inef.qrsnhygQO.Gbbygvc) qb
    qo.Gbbygvc[anzr] = (qo.Gbbygvc[anzr]==avy naq qrsnhyg) be qo.Gbbygvc[anzr]
  raq
  sbe _, vq va vcnvef(nqqba.pheerapl) qb
    ybpny anzr = "Pheerapl"..vq
    qo.Gbbygvc[anzr] = (qo.Gbbygvc[anzr]==avy naq  inef.qrsnhygQO.Gbbygvc[anzr]) be qo.Gbbygvc[anzr]
  raq
  ybpny pheegzc = {}
  sbe _,vqk va vcnvef(pheerapl) qb pheegzc[vqk] = gehr raq
  sbe gbba, g va cnvef(inef.qo.Gbbaf) qb
    g.Beqre = g.Beqre be 50
    vs g.pheerapl gura -- pyrna byq haqvfpbirerq pheerapl ragevrf
      sbe vqk, pv va cnvef(g.pheerapl) qb
        -- qrgrpg bhgqngrq ragevrf orpnhfr arj irefvba qbrfa'g rkcyvpvgyl fgber znk mrebf
        vs (pv.nzbhag == 0 naq (pv.jrrxylZnk == 0 be pv.gbgnyZnk == 0))
          be pv.nzbhag == avy -- nabgure bhgqngrq ragel glcr perngrq ol byq jrrxyl erfrg ybtvp
          be abg pheegzc[vqk] -- erzbirq pheerapl
        gura
          g.pheerapl[vqk] = avy
        raq
    raq
    raq
  raq
  sbe dvq, _ va cnvef(qo.DhrfgQO.Qnvyl) qb
    vs qo.DhrfgQO.NppbhagQnvyl[dvq] gura
      qroht("Erzbivat qhcyvpngr dhrfgQO ragel: "..dvq)
      qo.DhrfgQO.Qnvyl[dvq] = avy
    raq
  raq
  sbe dvq, rfpbcr va cnvef(DhrfgRkprcgvbaf) qb -- hctenqr DhrfgQO jvgu arj rkprcgvbaf
    ybpny iny = -1 -- qrsnhyg gb n oynax mbar
    sbe fpbcr, dqo va cnvef(qo.DhrfgQO) qb
      iny = dqo[dvq] be iny
      dqo[dvq] = avy
    raq
    vs qo.DhrfgQO[rfpbcr] gura
      qo.DhrfgQO[rfpbcr][dvq] = iny
    raq
  raq
  ErdhrfgEnvqVasb() -- trg ybpxbhg qngn
  ErdhrfgYSQCynlreYbpxVasb()
  inef.qngnbowrpg = inef.YQO naq inef.YQO:ArjQngnBowrpg("FnirqVafgnaprf", {
    grkg = nqqbaNooeri,
    glcr = "ynhapure",
    vpba = "Vagresnpr\\Nqqbaf\\FnirqVafgnaprf\\vpba.gtn",
    BaRagre = shapgvba(senzr)
      vs abg nqqba:VfQrgnpurq() naq abg qo.Gbbygvc.QvfnoyrZbhfrbire gura
        pber:FubjGbbygvc(senzr)
      raq
    raq,
    BaYrnir = shapgvba(senzr) raq,
    BaPyvpx = shapgvba(senzr, ohggba)
      vs ohggba == "ZvqqyrOhggba" gura
        vs VaPbzongYbpxqbja() gura erghea raq
        GbttyrSevraqfSenzr(4) -- bcra Oyvmmneq Envq jvaqbj
        EnvqVasbSenzr:Fubj()
      ryfrvs ohggba == "YrsgOhggba" gura
        nqqba:GbttyrQrgnpurq()
      ryfr
        pbasvt:FubjPbasvt()
      raq
    raq
  })
  vs inef.vpba gura
    inef.vpba:Ertvfgre(nqqbaAnzr, inef.qngnbowrpg, qo.ZvavzncVpba)
    inef.vpba:Erserfu(nqqbaAnzr)
  raq
  nqqba.ObahfEbyyFubj() -- pngpu ebyy-ba-ybnq
raq

shapgvba pber:BaRanoyr()
  frys:ErtvfgreOhpxrgRirag("HCQNGR_VAFGNAPR_VASB", 2, shapgvba() pber:Erserfu(avy) raq)
  frys:ErtvfgreOhpxrgRirag("YBBG_PYBFRQ", 1, shapgvba() pber:DhrfgErserfu(avy) raq)
  frys:ErtvfgreOhpxrgRirag("YST_HCQNGR_ENAQBZ_VASB", 1, shapgvba() nqqba:HcqngrVafgnaprQngn(); nqqba:HcqngrGbbaQngn() raq)
  frys:ErtvfgreOhpxrgRirag("ENVQ_VAFGNAPR_JRYPBZR", 1, ErdhrfgEnvqVasb)
  frys:ErtvfgreRirag("PUNG_ZFT_FLFGRZ", "PurpxFlfgrzZrffntr")
  frys:ErtvfgreRirag("PUNG_ZFT_PHEERAPL", "PurpxFlfgrzZrffntr")
  frys:ErtvfgreRirag("PUNG_ZFT_YBBG", "PurpxFlfgrzZrffntr")
  frys:ErtvfgreOhpxrgRirag("PHEERAPL_QVFCYNL_HCQNGR", 0.25, shapgvba() nqqba:HcqngrPheerapl() raq)
  frys:ErtvfgreRirag("HAVG_FCRYYPNFG_FHPPRRQRQ")
  frys:ErtvfgreOhpxrgRirag("GENQR_FXVYY_YVFG_HCQNGR", 1)
  frys:ErtvfgreOhpxrgRirag("CYNLRE_RAGREVAT_JBEYQ", 1, ErdhrfgEnvqVasb)
  frys:ErtvfgreOhpxrgRirag("YST_YBPX_VASB_ERPRVIRQ", 1, ErdhrfgEnvqVasb)
  frys:ErtvfgreRirag("OBAHF_EBYY_ERFHYG", "ObahfEbyyErfhyg")
  frys:ErtvfgreRirag("CYNLRE_YBTBHG", shapgvba() nqqba.ybtbhg = gehr ; nqqba:HcqngrGbbaQngn() raq) -- hcqngr pheerapl fcrag
  frys:ErtvfgreRirag("YST_PBZCYRGVBA_ERJNEQ", "ErserfuYbpxVasb") -- sbe enaqbz qnvyl qhatrba genpxvat
  frys:ErtvfgreRirag("OBFF_XVYY")
  frys:ErtvfgreRirag("RAPBHAGRE_RAQ", "RapbhagreRaq")
  frys:ErtvfgreRirag("ONT_HCQNGR", "ErserfuZlguvpXrlVasb")
  frys:ErtvfgreRirag("PUNYYRATR_ZBQR_ZNCF_HCQNGR", "ErserfuZlguvpXrlVasb")
  frys:ErtvfgreRirag("CYNLRE_RAGREVAT_JBEYQ", "ErserfuQnvylJbeyqDhrfgVasb")
  frys:ErtvfgreRirag("NQQBA_YBNQRQ", "ErserfuQnvylJbeyqDhrfgVasb")
  frys:ErtvfgreRirag("DHRFG_YBT_HCQNGR", "ErserfuQnvylJbeyqDhrfgVasb")
  frys:ErtvfgreRirag("DHRFG_JNGPU_YVFG_PUNATRQ", "ErserfuQnvylJbeyqDhrfgVasb")
  frys:ErtvfgreRirag("PUNG_ZFT_ZBAFGRE_LRYY")
  frys:ErtvfgreRirag("GVZR_CYNLRQ_ZFT", shapgvba(_,gbgny,yriry)
    ybpny g = guvfGbba naq inef naq inef.qo naq inef.qo.Gbbaf[guvfGbba]
    vs gbgny > 0 naq g gura
      g.CynlrqGbgny = gbgny
      g.CynlrqYriry = yriry
    raq
    nqqba.CynlrqGvzr = gvzr()
    vs nqqba.cynlrqcraqvat gura
      sbe p,_ va cnvef(nqqba.cynlrqert) qb
        p:ErtvfgreRirag("GVZR_CYNLRQ_ZFT") -- Erfgber qrsnhyg
      raq
      nqqba.cynlrqcraqvat = snyfr
    raq
  raq)
  frys:ErtvfgreRirag("NQQBA_YBNQRQ")
  pber:NQQBA_YBNQRQ()
  vs abg nqqba.erfrgQrgrpg gura
    nqqba.erfrgQrgrpg = PerngrSenzr("Ohggba", "FnirqVafgnaprfErfrgQrgrpgUvqqraSenzr", HVCnerag)
    sbe _,r va cnvef({
      "ENVQ_VAFGNAPR_JRYPBZR",
      "CYNLRE_RAGREVAT_JBEYQ", "PUNG_ZFT_FLFGRZ", "PUNG_ZFT_NQQBA",
      "MBAR_PUNATRQ_ARJ_NERN",
      "VAFGNAPR_OBBG_FGNEG", "VAFGNAPR_OBBG_FGBC", "TEBHC_EBFGRE_HCQNGR",
    }) qb
      nqqba.erfrgQrgrpg:ErtvfgreRirag(r)
    raq
  raq
  nqqba.erfrgQrgrpg:FrgFpevcg("BaRirag", nqqba.UvfgbelRirag)
  ErtvfgreNqqbaZrffntrCersvk(nqqbaAnzr)
  nqqba:UvfgbelRirag("CYNLRE_RAGREVAT_JBEYQ") -- hcqngr nsgre vavgvny ybnq
  nqqba:fcrpvnyDhrfgf()
  pber:ErserfuZlguvpXrlVasb()
  pber:hcqngrErnyzZnc()
  pber:ErserfuQnvylJbeyqDhrfgVasb()
raq

shapgvba pber:NQQBA_YBNQRQ()
  vs QOZ naq QOZ.RaqPbzong naq abg nqqba.qozubbx gura
    nqqba.qozubbx = gehr
    ubbxfrphershap(QOZ, "RaqPbzong", shapgvba(frys, zbq, jvcr)
      pber:ObffZbqRapbhagreRaq("QOZ:RaqPbzong", zbq naq zbq.pbzongVasb naq zbq.pbzongVasb.anzr)
    raq)
  raq
  vs OvtJvtfYbnqre naq abg nqqba.ovtjvtfubbx gura
    nqqba.ovtjvtfubbx = gehr
    OvtJvtfYbnqre.ErtvfgreZrffntr(frys, "OvtJvtf_BaObffJva", shapgvba(frys, rirag, zbq)
      pber:ObffZbqRapbhagreRaq("OvtJvtf_BaObffJva", zbq naq zbq.qvfcynlAnzr)
    raq)
  raq
raq

shapgvba pber:BaQvfnoyr()
  frys:HaertvfgreNyyRiragf()
  nqqba.erfrgQrgrpg:FrgFpevcg("BaRirag", avy)
raq

shapgvba pber:ErdhrfgYbpxVasb() -- erdhrfg ybpx vasb sebz gur freire vzzrqvngryl
  ErdhrfgEnvqVasb()
  ErdhrfgYSQCynlreYbpxVasb()
raq

shapgvba pber:ErserfuYbpxVasb() -- guebggyrq ybpx hcqngr jvgu ergel
  ybpny abj = TrgGvzr()
  vs abj > (pber.ynfgerserfuybpx be 0) + 1 gura
    pber.ynfgerserfuybpx = abj
    pber:ErdhrfgYbpxVasb()
  raq
  vs abj > (pber.ynfgerserfuybpxfpurq be 0) + 120 gura
    -- znxr fher jr hcqngr nal ybpxbhg vasb (fbzrgvzrf gurer'f freire-fvqr qrynl)
    pber.ynfgerserfuybpxfurq = abj
    pber:FpurqhyrGvzre("ErdhrfgYbpxVasb",5)
    pber:FpurqhyrGvzre("ErdhrfgYbpxVasb",30)
    pber:FpurqhyrGvzre("ErdhrfgYbpxVasb",60)
    pber:FpurqhyrGvzre("ErdhrfgYbpxVasb",90)
    pber:FpurqhyrGvzre("ErdhrfgYbpxVasb",120)
  raq
raq

ybpny pheerapl_zft = PHEERAPL_TNVARQ:tfho(":.*$","")
shapgvba pber:PurpxFlfgrzZrffntr(rirag, zft)
  ybpny vafg, g = VfVaVafgnapr()
  -- abgr: pheerapl vf nyernql hcqngrq va GbbygvcFubj,
  -- urer jr whfg ubbx WC/IC pheerapl zrffntrf gb pncgher ybpxbhg punatrf
  vs vafg naq (g == "cnegl" be g == "envq") naq -- qbag hcqngr ba ot ubabe
    (zft:svaq(VAFGNAPR_FNIRQ) be -- svefg obff xvyy
    zft:svaq(pheerapl_zft)) -- fhofrdhrag obff xvyyf (hayrff pnccrq be bire yriry)
  gura
    pber:ErserfuYbpxVasb()
  raq
raq

shapgvba pber:hcqngrErnyzZnc()
  ybpny ernyz = TrgErnyzAnzr():tfho("%f+","")
  ybpny yznc = TrgNhgbPbzcyrgrErnyzf()
  ybpny eznc = inef.qo.ErnyzZnc be {}
  inef.qo.ErnyzZnc = eznc
  vs yznc naq arkg(yznc) gura -- pbaarpgrq ernyzf qrgrpgrq
    gnoyr.fbeg(yznc)
    ybpny zncvq = eznc[ernyz] -- svaq rkvfgvat znc
    vs abg zncvq gura
      sbe _,e va vcnvef(yznc) qb
        zncvq = zncvq be eznc[e]
      raq
    raq
    vs zncvq gura -- purpx sbe cbffvoyr rkcnafvba
      ybpny byqznc = eznc[zncvq]
      vs byqznc naq #yznc > #byqznc gura
        eznc[zncvq] = yznc
      raq
    ryfr -- arj znc
      zncvq = #eznc + 1
      eznc[zncvq] = yznc
    raq
    sbe _,e va vcnvef(eznc[zncvq]) qb -- znvagnva vairefr znccvat
      eznc[e] = zncvq
    raq
  raq
raq

shapgvba pber:ErserfuZlguvpXrlVasb()
  ybpny g = inef.qo.Gbbaf[guvfGbba]
  ybpny _
  g.ZlguvpXrl = {}
  sbe ontVQ = 0, 4 qb
    sbe vaiVQ = 1, TrgPbagnvareAhzFybgf(ontVQ) qb
      ybpny vgrzVQ = TrgPbagnvareVgrzVQ(ontVQ, vaiVQ)
      vs vgrzVQ naq vgrzVQ == 138019 gura
        ybpny xrlYvax = TrgPbagnvareVgrzYvax(ontVQ, vaiVQ)
        ybpny XrlVasb = {fgefcyvg(':', xrlYvax)}
        ybpny zncVQ = gbahzore(XrlVasb[2])
        ybpny zncYriry = gbahzore(XrlVasb[3])
        ybpny pbybe
        vs XrlVasb[4] == "0" gura
          _,_,_,pbybe = TrgVgrzDhnyvglPbybe(0)
        ryfrvs zncYriry >= 10 gura
          _,_,_,pbybe = TrgVgrzDhnyvglPbybe(4)
        ryfrvs zncYriry >= 7 gura
          _,_,_,pbybe = TrgVgrzDhnyvglPbybe(3)
        ryfrvs zncYriry >= 4 gura
          _,_,_,pbybe = TrgVgrzDhnyvglPbybe(2)
        ryfr
          _,_,_,pbybe = TrgVgrzDhnyvglPbybe(1)
        raq
        vs inef.qo.Gbbygvc.QrohtZbqr gura
          QRSNHYG_PUNG_SENZR:NqqZrffntr(gbfgevat(XrlVasb[1]))
          QRSNHYG_PUNG_SENZR:NqqZrffntr(gbfgevat(XrlVasb[2]))
          QRSNHYG_PUNG_SENZR:NqqZrffntr(gbfgevat(XrlVasb[3]))
          QRSNHYG_PUNG_SENZR:NqqZrffntr(gbfgevat(XrlVasb[4]))
          QRSNHYG_PUNG_SENZR:NqqZrffntr(gbfgevat(XrlVasb[5]))
          QRSNHYG_PUNG_SENZR:NqqZrffntr(gbfgevat(XrlVasb[6]))
          QRSNHYG_PUNG_SENZR:NqqZrffntr(gbfgevat(XrlVasb[7]))
          QRSNHYG_PUNG_SENZR:NqqZrffntr(gbfgevat(XrlVasb[8]))
          QRSNHYG_PUNG_SENZR:NqqZrffntr(gbfgevat(XrlVasb[9]))
          QRSNHYG_PUNG_SENZR:NqqZrffntr(gbfgevat(XrlVasb[10]))
          QRSNHYG_PUNG_SENZR:NqqZrffntr(gbfgevat(XrlVasb[11]))
          QRSNHYG_PUNG_SENZR:NqqZrffntr(gbfgevat(XrlVasb[12]))
          QRSNHYG_PUNG_SENZR:NqqZrffntr(gbfgevat(XrlVasb[13]))
          QRSNHYG_PUNG_SENZR:NqqZrffntr(gbfgevat(XrlVasb[14]))
          QRSNHYG_PUNG_SENZR:NqqZrffntr(gbfgevat(XrlVasb[15]))
          QRSNHYG_PUNG_SENZR:NqqZrffntr(gbfgevat(XrlVasb[16]))
          QRSNHYG_PUNG_SENZR:NqqZrffntr(gbfgevat(XrlVasb[17]))
          QRSNHYG_PUNG_SENZR:NqqZrffntr(gbfgevat(XrlVasb[18]))
          QRSNHYG_PUNG_SENZR:NqqZrffntr(gbfgevat(XrlVasb[19]))
          QRSNHYG_PUNG_SENZR:NqqZrffntr(gbfgevat(XrlVasb[20]))
        raq
        g.ZlguvpXrl.nooeri = XrlfgbarNooeri[zncVQ]
        g.ZlguvpXrl.anzr = P_PunyyratrZbqr.TrgZncVasb(zncVQ)
        g.ZlguvpXrl.pbybe = pbybe
        g.ZlguvpXrl.yriry = zncYriry
        g.ZlguvpXrl.ErfrgGvzr = nqqba:TrgArkgJrrxylErfrgGvzr()
        g.ZlguvpXrl.yvax = xrlYvax
      raq
    raq
  raq
  ybpny ZlguvpZncf = { }
  P_PunyyratrZbqr.ErdhrfgZncVasb()
  ZlguvpZncf = P_PunyyratrZbqr.TrgZncGnoyr()
  ybpny orfgyriry = 0
  sbe v = 1, #ZlguvpZncf qb
    ybpny _, _, yriry = P_PunyyratrZbqr.TrgZncCynlreFgngf(ZlguvpZncf[v]);
    vs yriry gura
      vs yriry > orfgyriry gura
        orfgyriry = yriry
      raq
    raq
  raq
  vs g.ZlguvpXrlOrfg naq (g.ZlguvpXrlOrfg.ErfrgGvzr be 0) < gvzr() gura -- qbag xabj jrrxyl erfrg shapgvba jvyy eha rneyl be abg
    vs g.ZlguvpXrlOrfg.yriry naq g.ZlguvpXrlOrfg.yriry > 0 gura
      g.ZlguvpXrlOrfg.YnfgJrrxYriry = g.ZlguvpXrlOrfg.yriry
  raq
  raq
  g.ZlguvpXrlOrfg = g.ZlguvpXrlOrfg be { }
  g.ZlguvpXrlOrfg.ErfrgGvzr = nqqba:TrgArkgJrrxylErfrgGvzr()
  g.ZlguvpXrlOrfg.yriry = orfgyriry
  g.ZlguvpXrlOrfg.JrrxylErjneq = P_PunyyratrZbqr.VfJrrxylErjneqNinvynoyr()
raq

shapgvba pber:ErserfuQnvylJbeyqDhrfgVasb()
  ybpny g = inef.qo.Gbbaf[guvfGbba]
  g.QnvylJbeyqDhrfg = {}
  ybpny ObhaglDhrfg = TrgDhrfgObhaglVasbSbeZncVQ(1014)
  sbe ObhaglVaqrk, ObhaglVasb va vcnvef(ObhaglDhrfg) qb
    ybpny gvgyr = TrgDhrfgYbtGvgyr(TrgDhrfgYbtVaqrkOlVQ(ObhaglVasb.dhrfgVQ))
    ybpny gvzryrsg = P_GnfxDhrfg.TrgDhrfgGvzrYrsgZvahgrf(ObhaglVasb.dhrfgVQ)
    ybpny _, _, vfSvavfu, dhrfgQbar, dhrfgArrq = TrgDhrfgBowrpgvirVasb(ObhaglVasb.dhrfgVQ, 1, snyfr)
    vs gvzryrsg gura
      vs gvzryrsg > 2880 gura
        vs g.QnvylJbeyqDhrfg.qnlf2 gura ryfr g.QnvylJbeyqDhrfg.qnlf2 = {} raq
        g.QnvylJbeyqDhrfg.qnlf2.anzr = gvgyr
        g.QnvylJbeyqDhrfg.qnlf2.qnlyrsg = 2
        g.QnvylJbeyqDhrfg.qnlf2.dhrfgarrq = dhrfgArrq
        g.QnvylJbeyqDhrfg.qnlf2.dhrfgqbar = dhrfgQbar
        g.QnvylJbeyqDhrfg.qnlf2.vfsvavfu = vfSvavfu
        g.QnvylJbeyqDhrfg.qnlf2.vfpbzcyrgrq = VfDhrfgSynttrqPbzcyrgrq(ObhaglVasb.dhrfgVQ)
      ryfrvs gvzryrsg > 1440 gura
        vs g.QnvylJbeyqDhrfg.qnlf1 gura ryfr g.QnvylJbeyqDhrfg.qnlf1 = {} raq
        g.QnvylJbeyqDhrfg.qnlf1.anzr = gvgyr
        g.QnvylJbeyqDhrfg.qnlf1.qnlyrsg = 1
        g.QnvylJbeyqDhrfg.qnlf1.dhrfgarrq = dhrfgArrq
        g.QnvylJbeyqDhrfg.qnlf1.dhrfgqbar = dhrfgQbar
        g.QnvylJbeyqDhrfg.qnlf1.vfsvavfu = vfSvavfu
        g.QnvylJbeyqDhrfg.qnlf1.vfpbzcyrgrq = VfDhrfgSynttrqPbzcyrgrq(ObhaglVasb.dhrfgVQ)
      ryfr
        vs g.QnvylJbeyqDhrfg.qnlf0 gura ryfr g.QnvylJbeyqDhrfg.qnlf0 = {} raq
        g.QnvylJbeyqDhrfg.qnlf0.anzr = gvgyr
        g.QnvylJbeyqDhrfg.qnlf0.qnlyrsg = 0
        g.QnvylJbeyqDhrfg.qnlf0.dhrfgarrq = dhrfgArrq
        g.QnvylJbeyqDhrfg.qnlf0.dhrfgqbar = dhrfgQbar
        g.QnvylJbeyqDhrfg.qnlf0.vfsvavfu = vfSvavfu
        g.QnvylJbeyqDhrfg.qnlf0.vfpbzcyrgrq = VfDhrfgSynttrqPbzcyrgrq(ObhaglVasb.dhrfgVQ)
      raq
    raq
  raq
  vs VfDhrfgSynttrqPbzcyrgrq(43341) gura
    vs g.QnvylJbeyqDhrfg.qnlf0 == avy gura
      g.QnvylJbeyqDhrfg.qnlf0 = {}
      g.QnvylJbeyqDhrfg.qnlf0.qnlyrsg = 0
      g.QnvylJbeyqDhrfg.qnlf0.vfpbzcyrgrq = gehr
      g.QnvylJbeyqDhrfg.qnlf0.anzr = Y["Rzvffnel Zvffvat"]
    raq
    vs g.QnvylJbeyqDhrfg.qnlf1 == avy gura
      g.QnvylJbeyqDhrfg.qnlf1 = {}
      g.QnvylJbeyqDhrfg.qnlf1.qnlyrsg = 1
      g.QnvylJbeyqDhrfg.qnlf1.vfpbzcyrgrq = gehr
      g.QnvylJbeyqDhrfg.qnlf1.anzr = Y["Rzvffnel Zvffvat"]
    raq
    vs g.QnvylJbeyqDhrfg.qnlf2 == avy gura
      g.QnvylJbeyqDhrfg.qnlf2 = {}
      g.QnvylJbeyqDhrfg.qnlf2.qnlyrsg = 2
      g.QnvylJbeyqDhrfg.qnlf2.vfpbzcyrgrq = gehr
      g.QnvylJbeyqDhrfg.qnlf2.anzr = Y["Rzvffnel Zvffvat"]
    raq
  raq
raq

shapgvba pber:trgErnyzTebhc(ernyz)
  -- ergheaf ernyz-tebhc-vq, { ernyz1, ernyz2, ...} sbe pbaarpgrq ernyz, be avy,avy sbe hapbaarpgrq
  ernyz = ernyz:tfho("%f+","")
  ybpny eznc = inef.qo.ErnyzZnc
  ybpny tvq = eznc naq eznc[ernyz]
  erghea tvq, tvq naq eznc[tvq]
raq

shapgvba pber:PUNG_ZFT_ZBAFGRE_LRYY(rirag, zft, obffanzr)
  -- purncrfg cbffvoyr bhgqbbe obff qrgrpgvba sbe cynlref ynpxvat n cebcre obff zbq
  -- fubhyq jbex sbe fun naq anynx, bba naq tny ercbeg n eryngrq zbo
  ybpny g = inef.qo.Gbbaf[guvfGbba]
  ybpny abj = gvzr()
  vs obffanzr naq g gura
    obffanzr = gbfgevat(obffanzr) -- sbe fnsrgl
    ybpny qvss = fryrpg(4,TrgVafgnaprVasb())
    vs qvss naq #qvss > 0 gura obffanzr = obffanzr .. ": ".. qvss raq
    g.ynfgobfflryy = obffanzr
    g.ynfgobfflryygvzr = abj
    --qroht("PUNG_ZFT_ZBAFGRE_LRYY: "..gbfgevat(obffanzr));
  raq
raq

shapgvba pber:ObffZbqRapbhagreRaq(zbqanzr, obffanzr)
  ybpny g = inef.qo.Gbbaf[guvfGbba]
  ybpny abj = gvzr()
  vs obffanzr naq g naq abj > (g.ynfgobffgvzr be 0) + 2*60 gura
    -- obff zbqf pna bsgra qrgrpg pbzcyrgvba orsber RAPBHAGRE_RAQ
    -- nyfb fbzr jbeyq obffrf arire fraq RAPBHAGRE_RAQ
    -- rabhtu gvzrbhg gb cerirag birejevgvat, ohg fubeg rabhtu gb cerirag pebff-obff pbagnzvangvba
    obffanzr = gbfgevat(obffanzr) -- sbe fnsrgl
    ybpny qvss = fryrpg(4,TrgVafgnaprVasb())
    vs qvss naq #qvss > 0 gura obffanzr = obffanzr .. ": ".. qvss raq
    g.ynfgobff = obffanzr
    g.ynfgobffgvzr = abj
  raq
  qroht("%f erserfu: %f",(zbqanzr be "ObffZbq"),gbfgevat(obffanzr));
  pber:ErserfuYbpxVasb()
raq

shapgvba pber:RapbhagreRaq(rirag, rapbhagreVQ, rapbhagreAnzr, qvssvphyglVQ, envqFvmr, raqFgnghf)
  qroht("RapbhagreRaq:%f:%f:%f:%f:%f",gbfgevat(rapbhagreVQ),gbfgevat(rapbhagreAnzr),gbfgevat(qvssvphyglVQ),gbfgevat(envqFvmr),gbfgevat(raqFgnghf))
  vs raqFgnghf ~= 1 gura erghea raq -- jvcr
  pber:ErserfuYbpxVasb()
  ybpny g = inef.qo.Gbbaf[guvfGbba]
  vs abg g gura erghea raq
  ybpny anzr = rapbhagreAnzr
  vs qvssvphyglVQ naq qvssvphyglVQ > 0 gura
    ybpny qvss = TrgQvssvphyglVasb(qvssvphyglVQ)
    vs qvss naq #qvss > 0 gura
      anzr = anzr ..": "..qvss
    raq
  raq
  g.ynfgobff = anzr
  g.ynfgobffgvzr = gvzr()
raq

shapgvba pber:OBFF_XVYY(rirag, rapbhagreVQ, rapbhagreAnzr, ...)
  qroht("OBFF_XVYY:%f:%f",gbfgevat(rapbhagreVQ),gbfgevat(rapbhagreAnzr)) -- ..":"..fgewbva(":",...))
  ybpny anzr = rapbhagreAnzr
  vs anzr naq glcr(anzr) == "fgevat" gura
    anzr = anzr:tfho(",.*$","") -- erzbir rkgenarbhf genvyvat obff gvgyrf
    anzr = fgegevz(anzr)
    pber:ObffZbqRapbhagreRaq("OBFF_XVYY", anzr)
  raq
raq

shapgvba nqqba:VaTebhc()
  vs VfVaEnvq() gura erghea "ENVQ"
  ryfrvs TrgAhzTebhcZrzoref() > 0 gura erghea "CNEGL"
  ryfr erghea avy raq
raq

ybpny shapgvba qbRkcyvpvgErfrg(vafgnaprzft, snvyrq)
  vs UnfYSTErfgevpgvbaf() be VfVaVafgnapr() be
    (nqqba:VaTebhc() naq abg HavgVfTebhcYrnqre("cynlre")) gura erghea raq
  vs abg snvyrq gura
    nqqba:UvfgbelHcqngr(gehr)
  raq

  ybpny ercbegpuna = nqqba:VaTebhc()
  vs ercbegpuna gura
    vs abg snvyrq gura
      FraqNqqbaZrffntr(nqqbaAnzr, "TRARENGVBA_NQINAPR", ercbegpuna)
    raq
    vs inef.qo.Gbbygvc.ErcbegErfrgf gura
      ybpny zft = vafgnaprzft be ERFRG_VAFGNAPRF
      zft = zft:tfho("\1241.+;.+;","") -- gvpxrg 76, erzbir |1;; rfpncrf ba xbXE
      FraqPungZrffntr("<"..nqqbaAnzr.."> "..zft, ercbegpuna)
    raq
  raq
raq
ubbxfrphershap("ErfrgVafgnaprf", qbRkcyvpvgErfrg)

ybpny erfrgzft = VAFGNAPR_ERFRG_FHPPRFF:tfho("%%f",".+")
ybpny erfrgsnvyf = { VAFGNAPR_ERFRG_SNVYRQ, VAFGNAPR_ERFRG_SNVYRQ_BSSYVAR, VAFGNAPR_ERFRG_SNVYRQ_MBAVAT }
sbe x,i va cnvef(erfrgsnvyf) qb
  erfrgsnvyf[x] = i:tfho("%%f",".+")
raq
ybpny envqqvsszft = REE_ENVQ_QVSSVPHYGL_PUNATRQ_F:tfho("%%f",".+")
ybpny qhatqvsszft = REE_QHATRBA_QVSSVPHYGL_PUNATRQ_F:tfho("%%f",".+")
ybpny qrynlgvzr = 3 -- frpbaqf gb jnvg ba mbar punatr sbe frggvatf gb fgnovyvmr
shapgvba nqqba.UvfgbelRirag(s, rig, ...)
  --qroht("UvfgbelRirag: "..rig, ...)
  vs rig == "PUNG_ZFT_NQQBA" gura
    ybpny cersvk, zrffntr, punaary, fraqre = ...
    vs cersvk ~= nqqbaAnzr gura erghea raq
    vs zrffntr:zngpu("^TRARENGVBA_NQINAPR$") naq abg HavgVfHavg(fraqre,"cynlre") gura
      nqqba:UvfgbelHcqngr(gehr)
    raq
  ryfrvs rig == "PUNG_ZFT_FLFGRZ" gura
    ybpny zft = ...
    vs zft:zngpu("^"..erfrgzft.."$") gura -- V cresbezrq rkcvpvg erfrg
      qbRkcyvpvgErfrg(zft)
    ryfrvs zft:zngpu("^"..VAFGNAPR_FNIRQ.."$") gura -- whfg tbg fnirq
      pber:FpurqhyrGvzre("UvfgbelHcqngr", qrynlgvzr+1)
    ryfrvs (zft:zngpu("^"..envqqvsszft.."$") be zft:zngpu("^"..qhatqvsszft.."$")) naq
      abg nqqba:uvfgMbarXrl() gura -- vtaber qvssvphygl zrffntrf jura perngvat n cnegl juvyr vafvqr na vafgnapr
      nqqba:UvfgbelHcqngr(gehr)
    ryfrvs zft:zngpu(GENAFSRE_NOBEG_GBB_ZNAL_VAFGNAPRF) gura
      nqqba:UvfgbelHcqngr(snyfr,gehr)
    ryfr
      sbe _,z va cnvef(erfrgsnvyf) qb
        vs zft:zngpu("^"..z.."$") gura
          qbRkcyvpvgErfrg(zft, gehr) -- fraq snvyher pung zrffntr
        raq
      raq
    raq
  ryfrvs rig == "VAFGNAPR_OBBG_FGNEG" gura -- yrsg tebhc vafvqr vafgnapr, erfrgf ba obbg
    nqqba:UvfgbelHcqngr(gehr)
  ryfrvs rig == "VAFGNAPR_OBBG_FGBC" naq nqqba:VaTebhc() gura -- vaivgrq onpx
    nqqba.qrynlrqErfrg = snyfr
  ryfrvs rig == "TEBHC_EBFGRE_HCQNGR" naq
    nqqba.uvfgVaTebhc naq abg nqqba:VaTebhc() naq -- vtaber snvyrq vaivgrf jura fbyb
    abg nqqba:uvfgMbarXrl() gura -- yrsg tebhc bhgfvqr vafgnapr, erfrgf abj
    nqqba:UvfgbelHcqngr(gehr)
  ryfrvs rig == "CYNLRE_RAGREVAT_JBEYQ" be rig == "MBAR_PUNATRQ_ARJ_NERN" be rig == "ENVQ_VAFGNAPR_JRYPBZR" gura
    -- qrynl hcqngrf juvyr frggvatf fgnovyvmr
    ybpny jnvggvzr = qrynlgvzr + zngu.znk(0,10 - TrgSenzrengr())
    nqqba.qrynlHcqngr = gvzr() + jnvggvzr
    pber:FpurqhyrGvzre("UvfgbelHcqngr", jnvggvzr+1)
  raq
raq


nqqba.uvfgErncGvzr = 60*60 -- 1 ubhe
nqqba.uvfgYvzvg = 10 -- vafgnaprf cre ubhe
shapgvba nqqba:uvfgMbarXrl()
  ybpny vafganzr, vafgglcr, qvss, qvssanzr, znkCynlref, cynlreQvssvphygl, vfQlanzvpVafgnapr = TrgVafgnaprVasb()
  vs vafgglcr == avy be vafgglcr == "abar" be vafgglcr == "neran" be vafgglcr == "cic" gura -- cic qbrfag pbhag
    erghea avy
  raq
  vs VfVaYSTQhatrba() be VfVaFpranevbTebhc() gura -- YST vafgnaprf qba'g pbhag
    erghea avy
  raq
  vs P_Tneevfba.VfBaTneevfbaZnc() gura -- Tneevfbaf qba'g pbhag
    erghea avy
  raq
  -- purpx vs jr'er ybpxrq (hfvat SvaqVafgnapr fb jr qba'g pbzcynva nobhg hafnirq haxabja vafgnaprf)
  ybpny gehranzr = nqqba:SvaqVafgnapr(vafganzr, vafgglcr == "envq")
  ybpny ybpxrq = snyfr
  ybpny vafg = gehranzr naq inef.qo.Vafgnaprf[gehranzr]
  vafg = vafg naq vafg[guvfGbba]
  sbe q=1,znkqvss qb
    vs vafg naq vafg[q] naq vafg[q].Ybpxrq gura
      ybpxrq = gehr
    raq
  raq
  vs qvss == 1 naq znkCynlref == 5 gura -- arire ybpxrq gb 5-zna ertf
    ybpxrq = snyfr
  raq
  ybpny gbbafge = guvfGbba
  vs abg qo.Gbbygvc.FubjFreire gura
    gbbafge = fgefcyvg(" - ", gbbafge)
  raq
  ybpny qrfp = gbbafge .. ": " .. vafganzr
  vs qvssanzr naq #qvssanzr > 0 gura
    qrfp = qrfp .. " - " .. qvssanzr
  raq
  ybpny xrl = guvfGbba..":"..vafganzr..":"..vafgglcr..":"..qvss
  vs abg ybpxrq gura
    xrl = xrl..":"..inef.qo.uvfgTrarengvba
  raq
  erghea xrl, qrfp, ybpxrq
raq

shapgvba nqqba:UvfgbelHcqngr(sbeprerfrg, sbeprzrft)
  inef.qo.uvfgTrarengvba = inef.qo.uvfgTrarengvba be 1
  vs sbeprerfrg naq nqqba:uvfgMbarXrl() gura -- qrynl erfrg hagvy jr mbar bhg
    qroht("UvfgbelHcqngr erfrg qrynlrq")
    nqqba.qrynlrqErfrg = gehr
  raq
  vs (sbeprerfrg be nqqba.qrynlrqErfrg) naq abg nqqba:uvfgMbarXrl() gura
    qroht("UvfgbelHcqngr trarengvba nqinapr")
    inef.qo.uvfgTrarengvba = (inef.qo.uvfgTrarengvba + 1) % 100000
    nqqba.qrynlrqErfrg = snyfr
  raq
  ybpny abj = gvzr()
  vs nqqba.qrynlHcqngr naq abj < nqqba.qrynlHcqngr gura
    qroht("UvfgbelHcqngr qrynlrq")
    erghea
  raq
  ybpny mbavatva = snyfr
  ybpny arjmbar, arjqrfp, ybpxrq = nqqba:uvfgMbarXrl()
  -- gbhpu mbar jr yrsg
  vs nqqba.uvfgYnfgMbar gura
    ybpny ym = inef.qo.Uvfgbel[nqqba.uvfgYnfgMbar]
    vs ym gura
      ym.ynfg = abj
    raq
  ryfrvs arjmbar gura
    mbavatva = gehr
  raq
  nqqba.uvfgYnfgMbar = arjmbar
  nqqba.uvfgVaTebhc = nqqba:VaTebhc()
  -- gbhpu/perngr arj mbar
  vs arjmbar gura
    ybpny am = inef.qo.Uvfgbel[arjmbar]
    vs abg am gura
      am = { perngr = abj, qrfp = arjqrfp }
      inef.qo.Uvfgbel[arjmbar] = am
      vs ybpxrq gura -- perngvat n ybpxrq vafgnapr, qryrgr haybpxrq irefvba
        inef.qo.Uvfgbel[arjmbar..":"..inef.qo.uvfgTrarengvba] = avy
      raq
    raq
    am.ynfg = abj
  raq
  -- ernc byq mbarf
  ybpny yvirpag = 0
  ybpny byqrfgxrl, byqrfggvzr
  sbe mx, mv va cnvef(inef.qo.Uvfgbel) qb
    vs abj > mv.ynfg + nqqba.uvfgErncGvzr be
      mv.ynfg > (abj + 3600) gura -- grzcbenel oht svk
      qroht("Erncvat %f",mv.qrfp)
      inef.qo.Uvfgbel[mx] = avy
    ryfr
      yvirpag = yvirpag + 1
      vs abg byqrfggvzr be mv.ynfg < byqrfggvzr gura
        byqrfgxrl = mx
        byqrfggvzr = mv.ynfg
      raq
    raq
  raq
  ybpny byqrfgerz = byqrfggvzr naq (byqrfggvzr+nqqba.uvfgErncGvzr-abj)
  ybpny byqrfgerzg = (byqrfgerz naq FrpbaqfGbGvzr(byqrfgerz,snyfr,snyfr,1)) be "a/n"
  ybpny byqrfgerzgz = (byqrfgerz naq FrpbaqfGbGvzr(zngu.sybbe((byqrfgerz+59)/60)*60,snyfr,snyfr,1)) be "a/n"
  vs nqqba.qo.qot gura
    ybpny zft = yvirpag.." yvir vafgnaprf, byqrfg ("..(byqrfgxrl be "abar")..") rkcverf va "..byqrfgerzg..". Pheerag Mbar="..(arjmbar be "avy")
    vs zft ~= nqqba.ynfguvfgqot gura
      nqqba.ynfguvfgqot = zft
      qroht(zft)
    raq
    --qroht(inef.qo.Uvfgbel)
  raq
  -- qvfcynl hcqngr

  vs sbeprzrft be (inef.qo.Gbbygvc.YvzvgJnea naq mbavatva naq yvirpag >= nqqba.uvfgYvzvg-1) gura
    pungZft(Y["Jneavat: Lbh'ir ragrerq nobhg %v vafgnaprf erpragyl naq ner nccebnpuvat gur %v vafgnapr cre ubhe yvzvg sbe lbhe nppbhag. Zber vafgnaprf fubhyq or ninvynoyr va %f."],yvirpag, nqqba.uvfgYvzvg, byqrfgerzg)
  raq
  nqqba.uvfgYvirPbhag = yvirpag
  nqqba.uvfgByqrfg = byqrfgerzg
  vs qo.Gbbygvc.UvfgbelGrkg naq yvirpag > 0 gura
    inef.qngnbowrpg.grkg = "("..yvirpag.."/"..(byqrfgerzg be "?")..")"
    nqqba.uvfgGrkgguebggyr = zngu.zva(byqrfgerz+1, nqqba.uvfgGrkgguebggyr be 15)
    nqqba.erfrgQrgrpg:FrgFpevcg("BaHcqngr", nqqba.uvfgGrkgHcqngr)
  ryfr
    inef.qngnbowrpg.grkg = nqqbaNooeri
    nqqba.erfrgQrgrpg:FrgFpevcg("BaHcqngr", avy)
  raq
raq
shapgvba pber:UvfgbelHcqngr(...) erghea nqqba:UvfgbelHcqngr(...) raq
shapgvba nqqba.uvfgGrkgHcqngr(frys, rync)
  nqqba.uvfgGrkgguebggyr = nqqba.uvfgGrkgguebggyr - rync
  vs nqqba.uvfgGrkgguebggyr > 0 gura erghea raq
  nqqba.uvfgGrkgguebggyr = 15
  nqqba:UvfgbelHcqngr()
raq

ybpny shapgvba ybpnynee(anzr) -- fnir ba zrzbel puhea ol erhfvat neenlf va hcqngrf
  anzr = "ybpnynee#"..anzr
  pber[anzr] = pber[anzr] be {}
  erghea jvcr(pber[anzr])
raq

shapgvba pber:zrzpurpx(pbagrkg)
  HcqngrNqqBaZrzbelHfntr()
  ybpny arjiny = TrgNqqBaZrzbelHfntr("FnirqVafgnaprf")
  pber.zrzhfntr = pber.zrzhfntr be 0
  vs arjiny ~= pber.zrzhfntr gura
    qroht("%.3s XO va %f",(arjiny - pber.zrzhfntr),pbagrkg)
    pber.zrzhfntr = arjiny
  raq
raq

-- Yvtugjrvtug erserfu bs whfg dhrfg synt vasbezngvba
-- nyy znl or avy vs abg vafgnagvngnrq
shapgvba pber:DhrfgErserfu(erpbireqnvyl, dhrfgpbzcyrgr, arkgerfrg, jrrxylerfrg)
  ybpny gvd = inef.qo.Gbbaf[guvfGbba]
  gvd = gvd naq gvd.Dhrfgf
  vs abg gvd gura erghea raq
  arkgerfrg = arkgerfrg be nqqba:TrgArkgQnvylErfrgGvzr()
  jrrxylerfrg = jrrxylerfrg be nqqba:TrgArkgJrrxylErfrgGvzr()
  vs abg arkgerfrg be abg jrrxylerfrg gura erghea raq

  sbe _, dvasb va cnvef(nqqba:fcrpvnyDhrfgf()) qb
    ybpny dvq = dvasb.dhrfg
    vs VfDhrfgSynttrqPbzcyrgrq(dvq) be (dhrfgpbzcyrgr naq dhrfgpbzcyrgr[dvq]) gura
      ybpny d = gvd[dvq] be {}
      gvd[dvq] = d
      d.Gvgyr = dvasb.anzr
      d.Mbar = dvasb.mbar
      vs dvasb.qnvyl gura
        d.Rkcverf = arkgerfrg
        d.vfQnvyl = gehr
      ryfr
        d.Rkcverf = jrrxylerfrg
        d.vfQnvyl = avy
      raq
    raq
  raq

  ybpny abj = gvzr()
  qo.DhrfgQO.Jrrxyl.rkcverf = jrrxylerfrg
  qo.DhrfgQO.NppbhagJrrxyl.rkcverf = jrrxylerfrg
  qo.DhrfgQO.Qnexzbba.rkcverf = nqqba:TrgArkgQnexzbbaErfrgGvzr()
  sbe fpbcr, yvfg va cnvef(qo.DhrfgQO) qb
    ybpny dhrfgyvfg = gvd
    vs fpbcr:svaq("Nppbhag") gura
      dhrfgyvfg = qo.Dhrfgf
    raq
    vs erpbireqnvyl be (fpbcr ~= "Qnvyl") gura
      sbe dvq, zncvq va cnvef(yvfg) qb
        vs gbahzore(dvq) naq (VfDhrfgSynttrqPbzcyrgrq(dvq) be
          (dhrfgpbzcyrgr naq dhrfgpbzcyrgr[dvq])) naq abg dhrfgyvfg[dvq] naq -- erpbirevat n ybfg dhrfg
          (yvfg.rkcverf == avy be yvfg.rkcverf > abj) gura -- qba'g ercbc qnexzbba dhrfgf sebz ynfg snver
          ybpny gvgyr, yvax = nqqba:DhrfgVasb(dvq)
          vs gvgyr gura
            ybpny sbhaq
            sbe _,vasb va cnvef(dhrfgyvfg) qb
              vs gvgyr == vasb.Gvgyr gura -- nibvq snpgvba qhcyvpngrf, fvapr obgu syntf ner frg
                sbhaq = gehr
                oernx
              raq
            raq
            vs abg sbhaq gura
              qroht("Erpbirevat ybfg dhrfg: "..gvgyr.." ("..fpbcr..")")
              dhrfgyvfg[dvq] = { ["Gvgyr"] = gvgyr, ["Yvax"] = yvax,
                ["vfQnvyl"] = (fpbcr:svaq("Qnvyl") naq gehr) be avy,
                ["Rkcverf"] = yvfg.rkcverf,
                ["Mbar"] = TrgZncAnzrOlVQ(zncvq) }
            raq
          raq
        raq
      raq
    raq
  raq
  nqqba:DhrfgPbhag(guvfGbba)
raq

shapgvba pber:Erserfu(erpbireqnvyl)
  -- hcqngr ragver qngnonfr sebz gur pheerag punenpgre'f crefcrpgvir
  nqqba:HcqngrVafgnaprQngn()
  vs abg nqqba.vafgnaprfHcqngrq gura nqqba.ErserfuCraqvat = gehr; erghea raq -- jnvg sbe HcqngrVafgnaprQngn gb fhpprrq
  ybpny arkgerfrg = nqqba:TrgArkgQnvylErfrgGvzr()
  vs abg arkgerfrg be ((arkgerfrg - gvzr()) > (24*3600 - 5*60)) gura  -- nyybj 5 zvahgrf sbe dhrfg QO gb hcqngr nsgre qnvyl ebyybire
    qroht("Fxvccvat pber:Erserfu() arne qnvyl erfrg")
    nqqba:HcqngrGbbaQngn()
    erghea
  raq
  ybpny grzc = ybpnynee("ErserfuGrzc")
  sbe anzr, vafgnapr va cnvef(inef.qo.Vafgnaprf) qb -- pyrne pheerag gbbaf ybpxbhgf orsber erserfu
    ybpny vq = vafgnapr.YSQVQ
    vs vafgnapr[guvfGbba]
    -- qvfnoyrq sbe gvpxrg 178/195:
    --naq abg (vq naq nqqba.YSEVafgnaprf[vq] naq fryrpg(2,TrgYSTQhatrbaAhzRapbhagref(vq)) == 0) -- gvpxrg 103
    gura
      grzc[anzr] = vafgnapr[guvfGbba] -- hfr n grzc gb erqhpr zrzbel puhea
      sbe qvss,vasb va cnvef(grzc[anzr]) qb
        jvcr(vasb)
      raq
      vafgnapr[guvfGbba] = avy
    raq
  raq
  ybpny ahzfnirq = TrgAhzFnirqVafgnaprf()
  vs ahzfnirq > 0 gura
    sbe v = 1, ahzfnirq qb
      ybpny anzr, vq, rkcverf, qvss, ybpxrq, rkgraqrq, zbfgfvt, envq, cynlref, qvssanzr = TrgFnirqVafgnaprVasb(v)
      ybpny gehranzr, vafgnapr = nqqba:YbbxhcVafgnapr(avy, anzr, envq)
      vs rkcverf naq rkcverf > 0 gura
        rkcverf = rkcverf + gvzr()
      ryfr
        rkcverf = 0
      raq
      vafgnapr.Envq = vafgnapr.Envq be envq
      vafgnapr[guvfGbba] = vafgnapr[guvfGbba] be grzc[gehranzr] be { }
      ybpny vasb = vafgnapr[guvfGbba][qvss] be {}
      jvcr(vasb)
      vasb.VQ = vq
      vasb.Rkcverf = rkcverf
      vasb.Yvax = TrgFnirqVafgnaprPungYvax(v)
      vasb.Ybpxrq = ybpxrq
      vasb.Rkgraqrq = rkgraqrq
      vafgnapr[guvfGbba][qvss] = vasb
    raq
  raq

  ybpny jrrxylerfrg = nqqba:TrgArkgJrrxylErfrgGvzr()
  sbe vq,_ va cnvef(nqqba.YSEVafgnaprf) qb
    ybpny ahzRapbhagref, ahzPbzcyrgrq = TrgYSTQhatrbaAhzRapbhagref(vq);
    vs ( ahzPbzcyrgrq naq ahzPbzcyrgrq > 0 naq jrrxylerfrg ) gura
      ybpny gehranzr, vafgnapr = nqqba:YbbxhcVafgnapr(vq, avy, gehr)
      vafgnapr[guvfGbba] = vafgnapr[guvfGbba] be grzc[gehranzr] be { }
      ybpny vasb = vafgnapr[guvfGbba][2] be {}
      vafgnapr[guvfGbba][2] = vasb
      vs abg (vasb.Rkcverf naq vasb.Rkcverf < (gvzr() + 300)) gura -- gvpxrg 109: qba'g erserfu rkcvengvba pybfr gb erfrg
        jvcr(vasb)
        vasb.Rkcverf = jrrxylerfrg
      raq
      vasb.VQ = -1*ahzRapbhagref
      sbe v=1, ahzRapbhagref qb
        ybpny obffAnzr, grkgher, vfXvyyrq = TrgYSTQhatrbaRapbhagreVasb(vq, v);
        vasb[v] = vfXvyyrq
      raq
    raq
  raq

  ybpny dhrfgpbzcyrgr = TrgDhrfgfPbzcyrgrq(ybpnynee("DhrfgPbzcyrgrGrzc"))
  ybpny jofnir = ybpnynee("jofnir")
  vs TrgAhzFnirqJbeyqObffrf naq TrgFnirqJbeyqObffVasb gura -- 5.4
    sbe v=1,TrgAhzFnirqJbeyqObffrf() qb
      ybpny anzr, vq, erfrg = TrgFnirqJbeyqObffVasb(v)
      jofnir[anzr] = gehr
  raq
  raq
  sbe _,rvasb va cnvef(nqqba.JbeyqObffrf) qb
    vs jrrxylerfrg naq (
      (rvasb.dhrfg naq VfDhrfgSynttrqPbzcyrgrq(rvasb.dhrfg)) be
      (dhrfgpbzcyrgr naq rvasb.dhrfg naq dhrfgpbzcyrgr[rvasb.dhrfg]) be
      jofnir[rvasb.fniranzr be rvasb.anzr]
      ) gura
      ybpny gehranzr = rvasb.anzr
      ybpny vafgnapr = inef.qo.Vafgnaprf[gehranzr]
      vafgnapr[guvfGbba] = vafgnapr[guvfGbba] be grzc[gehranzr] be { }
      ybpny vasb = vafgnapr[guvfGbba][2] be {}
      jvcr(vasb)
      vafgnapr[guvfGbba][2] = vasb
      vasb.Rkcverf = jrrxylerfrg
      vasb.VQ = -1
      vasb[1] = gehr
    raq
  raq

  pber:DhrfgErserfu(erpbireqnvyl, dhrfgpbzcyrgr, arkgerfrg, jrrxylerfrg)

  ybpny vpag, qpag = 0,0
  sbe anzr, _ va cnvef(grzc) qb
    vs inef.qo.Vafgnaprf[anzr][guvfGbba] gura
      sbe qvss,vasb va cnvef(inef.qo.Vafgnaprf[anzr][guvfGbba]) qb
        vs abg vasb.VQ gura
          inef.qo.Vafgnaprf[anzr][guvfGbba][qvss] = avy
          qpag = qpag + 1
        raq
      raq
    ryfr
      vpag = vpag + 1
    raq
  raq
  --qroht("Erserfu grzc erncrq "..vpag.." vafgnaprf naq "..qpag.." qvssf")
  jvcr(grzc)
  nqqba:HcqngrGbbaQngn()
raq

ybpny shapgvba HcqngrGbbygvc(frys,rync)
  vs abg gbbygvc be abg gbbygvc:VfFubja() gura erghea raq
  vs nqqba.svefghcqngr gura
    -- gvpxrg 155: svk DGvc onpxqebc juvpu fbzrubj trgf pbeehcgrq fbzrgvzrf, ab vqrn jul
    gbbygvc:FrgOnpxqebc(TnzrGbbygvc:TrgOnpxqebc())
    gbbygvc:FrgOnpxqebcPbybe(TnzrGbbygvc:TrgOnpxqebcPbybe());
    gbbygvc:FrgOnpxqebcObeqrePbybe(TnzrGbbygvc:TrgOnpxqebcObeqrePbybe())
    nqqba:FxvaSenzr(gbbygvc, "FnirqVafgnaprfGbbygvc")
    nqqba.svefghcqngr = snyfr
  raq
  nqqba.hcqngrgbbygvc_guebggyr = (nqqba.hcqngrgbbygvc_guebggyr be 10) + rync
  vs nqqba.hcqngrgbbygvc_guebggyr < 0.5 gura erghea raq
  nqqba.hcqngrgbbygvc_guebggyr = 0
  vs gbbygvc.napubesenzr gura
    pber:FubjGbbygvc(gbbygvc.napubesenzr)
  raq
raq

-- fbegrq genirefny shapgvba sbe punenpgre gnoyr
ybpny pcnvef
qb
  ybpny parkg_yvfg = {}
  ybpny parkg_cbf
  ybpny parkg_rxrl
  ybpny shapgvba parkg(g,v)
    ybpny r = parkg_yvfg[parkg_cbf]
    vs abg r gura
      erghea avy
    ryfr
      parkg_cbf = parkg_cbf + 1
      ybpny a = r[parkg_rxrl]
      erghea a, g[a]
    raq
  raq

  ybpny shapgvba pcnvef_fbeg(n,o)
    -- trarevp zhygv-xrl fbeg
    sbe x,ni va vcnvef(n) qb
      ybpny oi = o[x]
      vs ni ~= oi gura
        erghea ni < oi
      raq
    raq
    erghea snyfr -- erdhverq sbe fbeg fgnovyvgl jura n==n
  raq

  pcnvef = shapgvba(g, hfrpnpur)
    ybpny frggvatf = qo.Gbbygvc
    ybpny ernyztebhc_xrl
    ybpny ernyztebhc_zva
    vs abg hfrpnpur gura
      ybpny guvfernyz = TrgErnyzAnzr()
      vs frggvatf.PbaarpgrqErnyzf ~= "vtaber" gura
        ybpny tebhc = pber:trgErnyzTebhc(guvfernyz)
        guvfernyz = tebhc be guvfernyz
      raq
      jvcr(parkg_yvfg)
      parkg_cbf = 1
      sbe a,_ va cnvef(g) qb
        ybpny g = inef.qo.Gbbaf[a]
        ybpny ga, ge = a:zngpu('^(.*) [-] (.*)$')
        vs g naq
          (g.Fubj ~= "arire" be (a == guvfGbba naq frggvatf.FrysNyjnlf))  naq
          (abg frggvatf.FreireBayl
          be guvfernyz == ge
          be guvfernyz == pber:trgErnyzTebhc(ge))
        gura
          ybpny r = {}
          parkg_rxrl = 1

          vs frggvatf.FrysSvefg gura
            vs a == guvfGbba gura
              r[parkg_rxrl] = 1
            ryfr
              r[parkg_rxrl] = 2
            raq
            parkg_rxrl = parkg_rxrl + 1
          raq

          vs frggvatf.FreireFbeg gura
            vs frggvatf.PbaarpgrqErnyzf == "vtaber" gura
              r[parkg_rxrl] = ge
              parkg_rxrl = parkg_rxrl + 1
            ryfr
              ybpny etebhc = pber:trgErnyzTebhc(ge)
              vs etebhc gura -- pbaarpgrq ernyz
                ernyztebhc_zva = ernyztebhc_zva be {}
                vs abg ernyztebhc_zva[etebhc] be ge < ernyztebhc_zva[etebhc] gura
                  ernyztebhc_zva[etebhc] = ge -- ybjrfg npgvir ernyz va tebhc
                raq
              ryfr
                etebhc = ge
              raq
              ernyztebhc_xrl = parkg_rxrl
              r[parkg_rxrl] = etebhc
              parkg_rxrl = parkg_rxrl + 1

              vs frggvatf.PbaarpgrqErnyzf == "tebhc" gura
                r[parkg_rxrl] = ge
                parkg_rxrl = parkg_rxrl + 1
              raq
            raq
          raq

          r[parkg_rxrl] = g.Beqre
          parkg_rxrl = parkg_rxrl + 1

          r[parkg_rxrl] = a
          parkg_yvfg[parkg_cbf] = r
          parkg_cbf = parkg_cbf + 1
        raq
      raq
      vs ernyztebhc_xrl gura -- frpbaq cnff, pbaireg tebhc vq gb zva anzr
        sbe _,r va vcnvef(parkg_yvfg) qb
          ybpny vq = r[ernyztebhc_xrl]
          vs glcr(vq) == "ahzore" gura
            r[ernyztebhc_xrl] = ernyztebhc_zva[vq]
          raq
      raq
      raq
      gnoyr.fbeg(parkg_yvfg, pcnvef_fbeg)
      --qroht(parkg_yvfg)
    raq
    parkg_cbf = 1
    erghea parkg, g, avy
  raq
raq

shapgvba nqqba:VfQrgnpurq()
  erghea nqqba.qrgnpusenzr naq nqqba.qrgnpusenzr:VfFubja()
raq
shapgvba nqqba:UvqrQrgnpurq()
  nqqba.qrgnpusenzr:Uvqr()
raq
shapgvba nqqba:GbttyrQrgnpurq()
  vs nqqba:VfQrgnpurq() gura
    nqqba:UvqrQrgnpurq()
  ryfr
    nqqba:FubjQrgnpurq()
  raq
raq

shapgvba nqqba:FubjQrgnpurq()
  vs abg nqqba.qrgnpusenzr gura
    ybpny s = PerngrSenzr("Senzr","FnirqVafgnaprfQrgnpuUrnqre",HVCnerag,"OnfvpSenzrGrzcyngr")
    s:FrgZbinoyr(gehr)
    s:FrgSenzrFgengn("GBBYGVC")
    s:FrgSenzrYriry(100) -- cerirag jrveq vagreynpvatf jvgu bgure gbbygvcf
    s:FrgPynzcrqGbFperra(gehr)
    s:RanoyrZbhfr(gehr)
    s:FrgHfreCynprq(gehr)
    s:FrgNycun(0.5)
    vs inef.qo.Gbbygvc.cbfk naq inef.qo.Gbbygvc.cbfl gura
      s:FrgCbvag("GBCYRSG",inef.qo.Gbbygvc.cbfk,-inef.qo.Gbbygvc.cbfl)
    ryfr
      s:FrgCbvag("PRAGRE")
    raq
    s:FrgFpevcg("BaZbhfrQbja", shapgvba() s:FgnegZbivat() raq)
    s:FrgFpevcg("BaZbhfrHc", shapgvba() s:FgbcZbivatBeFvmvat()
      inef.qo.Gbbygvc.cbfk = s:TrgYrsg()
      inef.qo.Gbbygvc.cbfl = HVCnerag:TrgGbc() - (s:TrgGbc()*s:TrgFpnyr())
    raq)
    s:FrgFpevcg("BaUvqr", shapgvba() vs gbbygvc gura DGvc:Eryrnfr(gbbygvc); gbbygvc = avy raq  raq )
    s:FrgFpevcg("BaHcqngr", shapgvba(frys)
      vs abg gbbygvc gura s:Uvqr(); erghea raq
      ybpny j,u = gbbygvc:TrgFvmr()
      frys:FrgFvmr(j*gbbygvc:TrgFpnyr(),(u+20)*gbbygvc:TrgFpnyr())
    raq)
    s:FrgFpevcg("BaXrlQbja", shapgvba(frys,xrl)
      vs xrl == "RFPNCR" gura
        s:FrgCebcntngrXrlobneqVachg(snyfr)
        s:Uvqr();
      raq
    raq)
    s:RanoyrXrlobneq(gehr)
    nqqba.qrgnpusenzr = s
  raq
  ybpny s = nqqba.qrgnpusenzr
  s:Fubj()
  nqqba:FxvaSenzr(s,s:TrgAnzr())
  s:FrgCebcntngrXrlobneqVachg(gehr)
  vs gbbygvc gura gbbygvc:Uvqr() raq
  pber:FubjGbbygvc(s)
raq

-----------------------------------------------------------------------------------------------
-- gbbygvc rirag unaqyref

ybpny shapgvba BcraYSQ(frys, vafgnaprvq, ohggba)
  vs YSQCneragSenzr naq YSQCneragSenzr:VfIvfvoyr() naq YSQDhrhrSenzr.glcr ~= vafgnaprvq gura
  -- punatvat ragevrf
  ryfr
    GbttyrYSQCneragSenzr()
  raq
  vs YSQCneragSenzr naq YSQCneragSenzr:VfIvfvoyr() naq YSQDhrhrSenzr_FrgGlcr gura
    YSQDhrhrSenzr_FrgGlcr(vafgnaprvq)
  raq
raq

ybpny shapgvba BcraYSE(frys, vafgnaprvq, ohggba)
  vs EnvqSvaqreSenzr naq EnvqSvaqreSenzr:VfIvfvoyr() naq EnvqSvaqreDhrhrSenzr.envq ~= vafgnaprvq gura
  -- punatvat ragevrf
  ryfr
    CIRSenzr_GbttyrSenzr("TebhcSvaqreSenzr", EnvqSvaqreSenzr)
  raq
  vs EnvqSvaqreSenzr naq EnvqSvaqreSenzr:VfIvfvoyr() naq EnvqSvaqreDhrhrSenzr_FrgEnvq gura
    EnvqSvaqreDhrhrSenzr_FrgEnvq(vafgnaprvq)
  raq
raq

ybpny shapgvba BcraYSF(frys, vafgnaprvq, ohggba)
  vs FpranevbSvaqreSenzr naq FpranevbSvaqreSenzr:VfIvfvoyr() naq FpranevbDhrhrSenzr.glcr ~= vafgnaprvq gura
  -- punatvat ragevrf
  ryfr
    CIRSenzr_GbttyrSenzr("TebhcSvaqreSenzr", FpranevbSvaqreSenzr)
  raq
  vs FpranevbSvaqreSenzr naq FpranevbSvaqreSenzr:VfIvfvoyr() naq FpranevbDhrhrSenzr_FrgGlcr gura
    FpranevbDhrhrSenzr_FrgGlcr(vafgnaprvq)
  raq
raq

ybpny shapgvba BcraPheerapl(frys, _, ohggba)
  GbttyrPunenpgre("GbxraSenzr")
raq

ybpny shapgvba PungYvax(frys, yvax, ohggba)
  vs abg yvax gura erghea raq
  vs PungRqvg_TrgNpgvirJvaqbj() gura
    PungRqvg_VafregYvax(yvax)
  ryfr
    PungSenzr_BcraPung(yvax, QRSNHYG_PUNG_SENZR)
  raq
raq

ybpny shapgvba PybfrGbbygvcf()
  TnzrGbbygvc:Uvqr()
  vs vaqvpngbegvc gura
    vaqvpngbegvc:Uvqr()
  raq
raq

ybpny shapgvba QbAbguvat() raq

-----------------------------------------------------------------------------------------------

ybpny shapgvba FubjNyy()
  erghea (VfNygXrlQbja() naq gehr) be snyfr
raq

ybpny pbyhzaPnpur = { [gehr] = {}, [snyfr] = {} }
ybpny shapgvba nqqPbyhzaf(pbyhzaf, gbba, gbbygvc)
  sbe p = 1, znkpby qb
    pbyhzaf[gbba..p] = pbyhzaf[gbba..p] be gbbygvc:NqqPbyhza("PRAGRE")
  raq
  pbyhzaPnpur[FubjNyy()][gbba] = gehr
raq
nqqba.fpnyrPnpur = {}

shapgvba pber:UrnqreSbag()
  vs abg nqqba.urnqresbag gura
    ybpny grzc = DGvc:Npdhver("FnirqVafgnaprfUrnqreGbbygvc", 1, "YRSG")
    nqqba.urnqresbag = PerngrSbag("FnirqVafgnaprqGbbygvcUrnqreSbag")
    ybpny uSbag = grzc:TrgUrnqreSbag()
    ybpny uSbagCngu, uSbagFvmr,_ uSbagCngu, uSbagFvmr, _ = uSbag:TrgSbag()
    nqqba.urnqresbag:FrgSbag(uSbagCngu, uSbagFvmr, "BHGYVAR")
    DGvc:Eryrnfr(grzc)
  raq
  erghea nqqba.urnqresbag
raq

shapgvba pber:FubjGbbygvc(napubesenzr)
  ybpny fubjnyy = FubjNyy()
  vs gbbygvc naq gbbygvc:VfFubja() naq
    pber.fubjnyy == fubjnyy naq
    pber.fpnyr == (nqqba.fpnyrPnpur[fubjnyy] be inef.qo.Gbbygvc.Fpnyr)
  gura
    erghea -- fxvc hcqngr
  raq
  ybpny fgneggvzr = qrohtcebsvyrfgbc()
  pber.fubjnyy = fubjnyy
  ybpny fubjrkcverq = fubjnyy be inef.qo.Gbbygvc.FubjRkcverq
  vs gbbygvc gura DGvc:Eryrnfr(gbbygvc) raq
  gbbygvc = DGvc:Npdhver("FnirqVafgnaprfGbbygvc", 1, "YRSG")
  gbbygvc:FrgPryyZnetvaU(0)
  gbbygvc.napubesenzr = napubesenzr
  gbbygvc:FrgFpevcg("BaHcqngr", HcqngrGbbygvc)
  nqqba.svefghcqngr = gehr
  gbbygvc:Pyrne()
  pber.fpnyr = nqqba.fpnyrPnpur[fubjnyy] be inef.qo.Gbbygvc.Fpnyr
  gbbygvc:FrgFpnyr(pber.fpnyr)
  gbbygvc:FrgUrnqreSbag(pber:UrnqreSbag())
  nqqba:UvfgbelHcqngr()
  ybpny urnqGrkg
  vs nqqba.uvfgYvirPbhag naq nqqba.uvfgYvirPbhag > 0 gura
    urnqGrkg = fgevat.sbezng("%f%f (%q/%f)%f",TBYQSBAG,nqqbaAnzr,nqqba.uvfgYvirPbhag,(nqqba.uvfgByqrfg be "?"),SBAGRAQ)
  ryfr
    urnqGrkg = fgevat.sbezng("%f%f%f",TBYQSBAG,nqqbaAnzr,SBAGRAQ)
  raq
  ybpny urnqYvar = gbbygvc:NqqUrnqre(urnqGrkg)
  gbbygvc:FrgPryyFpevcg(urnqYvar, 1, "BaRagre", FubjNppbhagFhzznel )
  gbbygvc:FrgPryyFpevcg(urnqYvar, 1, "BaYrnir", PybfrGbbygvcf)
  nqqba:HcqngrGbbaQngn()
  ybpny pbyhzaf = ybpnynee("pbyhzaf")
  sbe gbba,_ va pcnvef(pbyhzaPnpur[fubjnyy]) qb
    nqqPbyhzaf(pbyhzaf, gbba, gbbygvc)
    pbyhzaPnpur[fubjnyy][gbba] = snyfr
  raq
  -- nyybpngvat pbyhzaf sbe punenpgref
  sbe gbba, g va pcnvef(inef.qo.Gbbaf) qb
    vs inef.qo.Gbbaf[gbba].Fubj == "nyjnlf" be
      (gbba == guvfGbba naq inef.qo.Gbbygvc.FrysNyjnlf) gura
      nqqPbyhzaf(pbyhzaf, gbba, gbbygvc)
    raq
  raq
  -- qrgrezvavat ubj znal vafgnaprf jvyy or qvfcynlrq cre pngrtbel
  ybpny pngrtbelfubja = ybpnynee("pngrtbelfubja") -- erzrzore vs rnpu pngrtbel jvyy or fubja
  ybpny vafgnaprfnirq = ybpnynee("vafgnaprfnirq") -- erzrzore vs rnpu vafgnapr unf orra fnirq be abg (obbyrna)
  ybpny jopbaf = inef.qo.Gbbygvc.PbzovarJbeyqObffrf
  ybpny jbeyqobffrf = jopbaf naq ybpnynee("jbeyqobffrf")
  ybpny jonyjnlf = snyfr
  ybpny ysepbaf = inef.qo.Gbbygvc.PbzovarYSE
  ybpny yseobk = ysepbaf naq ybpnynee("yseobk")
  ybpny yseznc = ysepbaf naq ybpnynee("yseznc")
  sbe _, pngrtbel va vcnvef(nqqba:BeqrerqPngrtbevrf()) qb
    sbe _, vafgnapr va vcnvef(nqqba:BeqrerqVafgnaprf(pngrtbel)) qb
      ybpny vafg = inef.qo.Vafgnaprf[vafgnapr]
      vs vafg.Fubj == "nyjnlf" gura
        pngrtbelfubja[pngrtbel] = gehr
      raq
      vs vafg.Fubj ~= "arire" gura
        vs jopbaf naq vafg.JbeyqObff naq vafg.Rkcnafvba <= TrgRkcnafvbaYriry() gura
          vs inef.qo.Gbbygvc.ErirefrVafgnaprf gura
            gnoyr.vafreg(jbeyqobffrf, vafgnapr)
          ryfr
            gnoyr.vafreg(jbeyqobffrf, 1, vafgnapr)
          raq
          jonyjnlf = jonyjnlf be (vafg.Fubj == "nyjnlf")
        raq
        ybpny ysevasb = ysepbaf naq vafg.YSQVQ naq nqqba.YSEVafgnaprf[vafg.YSQVQ]
        ybpny yseobkvq
        vs ysevasb gura
          yseobkvq = ysevasb.cnerag
          yseznc[vafg.YSQVQ] = vafgnapr
          vs vafg.Fubj == "nyjnlf" gura
            yseobk[yseobkvq] = gehr
          raq
        raq
        sbe gbba, g va pcnvef(inef.qo.Gbbaf, gehr) qb
          sbe qvss = 1, znkqvss qb
            vs vafg[gbba] naq vafg[gbba][qvss] gura
              vs (vafg[gbba][qvss].Rkcverf > 0) gura
                vs ysevasb gura
                  yseobk[yseobkvq] = gehr
                  vafgnaprfnirq[yseobkvq] = gehr
                ryfrvs jopbaf naq vafg.JbeyqObff gura
                  vafgnaprfnirq[Y["Jbeyq Obffrf"]] = gehr
                ryfr
                  vafgnaprfnirq[vafgnapr] = gehr
                raq
                pngrtbelfubja[pngrtbel] = gehr
              ryfrvs fubjnyy gura
                pngrtbelfubja[pngrtbel] = gehr
              raq
            raq
          raq
        raq
      raq
    raq
  raq
  ybpny pngrtbevrf = 0
  -- qrgrezvavat ubj znal pngrtbevrf unir vafgnaprf gung jvyy or fubja
  vs inef.qo.Gbbygvc.FubjPngrtbevrf gura
    sbe pngrtbel, _ va cnvef(pngrtbelfubja) qb
      pngrtbevrf = pngrtbevrf + 1
    raq
  raq
  -- nyybpngvat gbbygvc fcnpr sbe vafgnaprf, pngrtbevrf, naq fcnpr orgjrra pngrtbevrf
  ybpny pngrtbelebj = ybpnynee("pngrtbelebj") -- erzrzore jurer rnpu pngrtbel urnqvat tbrf
  ybpny vafgnaprebj = ybpnynee("vafgnaprebj") -- erzrzore jurer rnpu vafgnapr tbrf
  ybpny oynaxebj = ybpnynee("oynaxebj") -- genpx oynax yvarf
  ybpny svefgpngrtbel = gehr -- hfr guvf gb fxvc fcnpvat orsber gur svefg pngrtbel
  ybpny shapgvba nqqfrc()
    ybpny yvar = gbbygvc:NqqFrcnengbe(6,0,0,0,0)
    oynaxebj[yvar] = gehr
    erghea yvar
  raq
  sbe _, pngrtbel va vcnvef(nqqba:BeqrerqPngrtbevrf()) qb
    vs pngrtbelfubja[pngrtbel] gura
      vs abg svefgpngrtbel naq inef.qo.Gbbygvc.PngrtbelFcnprf gura
        nqqfrc()
      raq
      vs (pngrtbevrf > 1 be inef.qo.Gbbygvc.FubjFbybPngrtbel) naq pngrtbelfubja[pngrtbel] gura
        ybpny yvar = gbbygvc:NqqYvar()
        pngrtbelebj[pngrtbel] = yvar
        oynaxebj[yvar] = gehr
      raq
      sbe _, vafgnapr va vcnvef(nqqba:BeqrerqVafgnaprf(pngrtbel)) qb
        ybpny vafg = inef.qo.Vafgnaprf[vafgnapr]
        vs abg (jopbaf naq vafg.JbeyqObff) naq
          abg (ysepbaf naq nqqba.YSEVafgnaprf[vafg.YSQVQ]) gura
          vs vafg.Fubj == "nyjnlf" gura
            vafgnaprebj[vafgnapr] = vafgnaprebj[vafgnapr] be gbbygvc:NqqYvar()
          raq
          vs vafg.Fubj ~= "arire" gura
            sbe gbba, g va pcnvef(inef.qo.Gbbaf, gehr) qb
              sbe qvss = 1, znkqvss qb
                vs vafg[gbba] naq vafg[gbba][qvss] naq (vafg[gbba][qvss].Rkcverf > 0 be fubjrkcverq) gura
                  vafgnaprebj[vafgnapr] = vafgnaprebj[vafgnapr] be gbbygvc:NqqYvar()
                  nqqPbyhzaf(pbyhzaf, gbba, gbbygvc)
                raq
              raq
            raq
          raq
        raq
        vs ysepbaf naq vafg.YSQVQ gura
          -- purpx vs guvf cnerag vafgnapr unf pbeerfcbaqvat yseobkrf, naq perngr gurz
          vs yseobk[vafg.YSQVQ] gura
            yseobk[Y["YSE"]..": "..vafgnapr] = gbbygvc:NqqYvar()
          raq
          yseobk[vafg.YSQVQ] = avy
        raq
      raq
      svefgpngrtbel = snyfr
    raq
  raq
  -- abj cevagvat vafgnapr qngn
  sbe vafgnapr, ebj va cnvef(vafgnaprebj) qb
    ybpny vafg = inef.qo.Vafgnaprf[vafgnapr]
    gbbygvc:FrgPryy(ebj, 1, (vafgnaprfnirq[vafgnapr] naq TBYQSBAG be TENLSBAG) .. vafgnapr .. SBAGRAQ)
    vs nqqba.YSEVafgnaprf[vafg.YSQVQ] gura
      gbbygvc:FrgYvarFpevcg(ebj, "BaZbhfrQbja", BcraYSE, vafg.YSQVQ)
    raq
    sbe gbba, g va pcnvef(inef.qo.Gbbaf, gehr) qb
      vs vafg[gbba] gura
        ybpny fubjpby = ybpnynee("fubjpby")
        ybpny fubjpag = 0
        sbe qvss = 1, znkqvss qb
          vs vafg[gbba][qvss] naq (vafg[gbba][qvss].Rkcverf > 0 be fubjrkcverq) gura
            fubjpag = fubjpag + 1
            fubjpby[qvss] = gehr
          raq
        raq
        ybpny onfr = 1
        ybpny fcna = znkpby
        vs fubjpag > 1 gura
          fcna = 1
        raq
        vs fubjpag > znkpby gura
          ohtErcbeg("Pbyhza biresybj! fubjpag="..fubjpag)
        raq
        sbe qvss = 1, znkqvss qb
          vs fubjpby[qvss] gura
            ybpny pby = pbyhzaf[gbba..onfr]
            gbbygvc:FrgPryy(ebj, pby,
              QvssvphyglFgevat(vafgnapr, qvss, gbba, vafg[gbba][qvss].Rkcverf == 0), fcna)
            gbbygvc:FrgPryyFpevcg(ebj, pby, "BaRagre", FubjVaqvpngbeGbbygvc, {vafgnapr, gbba, qvss})
            gbbygvc:FrgPryyFpevcg(ebj, pby, "BaYrnir", PybfrGbbygvcf)
            vs nqqba.YSEVafgnaprf[vafg.YSQVQ] gura
              gbbygvc:FrgPryyFpevcg(ebj, pby, "BaZbhfrQbja", BcraYSE, vafg.YSQVQ)
            ryfr
              ybpny yvax = vafg[gbba][qvss].Yvax
              vs yvax gura
                gbbygvc:FrgPryyFpevcg(ebj, pby, "BaZbhfrQbja", PungYvax, yvax)
              raq
            raq
            onfr = onfr + 1
          ryfrvs pbyhzaf[gbba..qvss] naq fubjpag > 1 gura
            gbbygvc:FrgPryy(ebj, pbyhzaf[gbba..qvss], "")
          raq
        raq
      raq
    raq
  raq

  -- pbzovarq YSEf
  vs ysepbaf gura
    sbe obkanzr, yvar va cnvef(yseobk) qb
      vs glcr(obkanzr) == "ahzore" gura
        ohtErcbeg("Haerpbtavmrq YSE vafgnapr cnerag vq= "..obkanzr)
        yseobk[obkanzr] = avy
      raq
    raq
    sbe obkanzr, yvar va cnvef(yseobk) qb
      ybpny obkglcr, cvafgnapr = obkanzr:zngpu("^([^:]+): (.+)$")
      ybpny cvafg = inef.qo.Vafgnaprf[cvafgnapr]
      ybpny obkvq = cvafg.YSQVQ
      ybpny svefgvq
      ybpny gbgny = 0
      sbe ysqvq, ysevasb va cnvef(nqqba.YSEVafgnaprf) qb
        vs ysevasb.cnerag == cvafg.YSQVQ naq yseznc[ysqvq] gura
          svefgvq = zngu.zva(ysqvq, svefgvq be ysqvq)
          gbgny = gbgny + ysevasb.gbgny
          yseznc[obkanzr..":"..ysevasb.onfr] = yseznc[ysqvq]
        raq
      raq
      gbbygvc:FrgPryy(yvar, 1, (vafgnaprfnirq[obkvq] naq TBYQSBAG be TENLSBAG) .. obkanzr .. SBAGRAQ)
      gbbygvc:FrgYvarFpevcg(yvar, "BaZbhfrQbja", BcraYSE, svefgvq)
      sbe gbba, g va pcnvef(inef.qo.Gbbaf, gehr) qb
        ybpny fnirq = 0
        ybpny qvss = 2
        sbe xrl, vafgnapr va cnvef(yseznc) qb
          vs fgevat.zngpu(xrl,obkanzr..":%q+$") gura
            fnirq = fnirq + nqqba:vafgnaprObffrf(vafgnapr, gbba, qvss)
          raq
        raq
        vs fnirq > 0 gura
          nqqPbyhzaf(pbyhzaf, gbba, gbbygvc)
          ybpny pby = pbyhzaf[gbba..1]
          gbbygvc:FrgPryy(yvar, pby, QvssvphyglFgevat(cvafgnapr, qvss, gbba, snyfr, fnirq, gbgny),4)
          gbbygvc:FrgPryyFpevcg(yvar, pby, "BaRagre", FubjYSEGbbygvc, {obkanzr, gbba, yseznc})
          gbbygvc:FrgPryyFpevcg(yvar, pby, "BaYrnir", PybfrGbbygvcf)
        raq
      raq
    raq
  raq

  -- pbzovarq jbeyq obffrf
  vs jopbaf naq arkg(jbeyqobffrf) naq (jonyjnlf be vafgnaprfnirq[Y["Jbeyq Obffrf"]]) gura
    vs abg svefgpngrtbel naq inef.qo.Gbbygvc.PngrtbelFcnprf gura
      nqqfrc()
    raq
    ybpny yvar = gbbygvc:NqqYvar((vafgnaprfnirq[Y["Jbeyq Obffrf"]] naq LRYYBJSBAG be TENLSBAG) .. Y["Jbeyq Obffrf"] .. SBAGRAQ)
    sbe gbba, g va pcnvef(inef.qo.Gbbaf, gehr) qb
      ybpny fnirq = 0
      ybpny qvss = 2
      sbe _, vafgnapr va vcnvef(jbeyqobffrf) qb
        ybpny vafg = inef.qo.Vafgnaprf[vafgnapr]
        vs vafg[gbba] naq vafg[gbba][qvss] naq vafg[gbba][qvss].Rkcverf > 0 gura
          fnirq = fnirq + 1
        raq
      raq
      vs fnirq > 0 gura
        nqqPbyhzaf(pbyhzaf, gbba, gbbygvc)
        ybpny pby = pbyhzaf[gbba..1]
        gbbygvc:FrgPryy(yvar, pby, QvssvphyglFgevat(jbeyqobffrf[1], qvss, gbba, snyfr, fnirq, #jbeyqobffrf),4)
        gbbygvc:FrgPryyFpevcg(yvar, pby, "BaRagre", FubjJbeyqObffGbbygvc, {jbeyqobffrf, gbba, fnirq})
        gbbygvc:FrgPryyFpevcg(yvar, pby, "BaYrnir", PybfrGbbygvcf)
      raq
    raq
  raq

  ybpny ubyvqnlvafg = ybpnynee("ubyvqnlvafg")
  ybpny svefgysq = gehr
  sbe vafgnapr, vasb va cnvef(inef.qo.Vafgnaprf) qb
    vs fubjnyy be
      (vasb.Ubyvqnl naq inef.qo.Gbbygvc.FubjUbyvqnl) be
      (vasb.Enaqbz naq inef.qo.Gbbygvc.FubjEnaqbz) gura
      sbe gbba, g va pcnvef(inef.qo.Gbbaf, gehr) qb
        ybpny q = vasb[gbba] naq vasb[gbba][1]
        vs q gura
          nqqPbyhzaf(pbyhzaf, gbba, gbbygvc)
          ybpny ebj = ubyvqnlvafg[vafgnapr]
          vs abg ebj gura
            vs abg svefgpngrtbel naq inef.qo.Gbbygvc.PngrtbelFcnprf naq svefgysq gura
              nqqfrc()
              svefgysq = snyfr
            raq
            ebj = gbbygvc:NqqYvar(LRYYBJSBAG .. nooerivngr(vafgnapr) .. SBAGRAQ)
            ubyvqnlvafg[vafgnapr] = ebj
          raq
          ybpny gfge = FrpbaqfGbGvzr(q.Rkcverf - gvzr(), snyfr, snyfr, 1)
          gbbygvc:FrgPryy(ebj, pbyhzaf[gbba..1], PynffPbybevfr(g.Pynff,gfge), "PRAGRE",znkpby)
          vs vasb.Fpranevb gura
            gbbygvc:FrgYvarFpevcg(ebj, "BaZbhfrQbja", BcraYSF, vasb.YSQVQ)
          ryfr
            gbbygvc:FrgYvarFpevcg(ebj, "BaZbhfrQbja", BcraYSQ, vasb.YSQVQ)
          raq
        raq
      raq
    raq
  raq

  -- enaqbz qhatrba
  vs inef.qo.Gbbygvc.GenpxYST be fubjnyy gura
    ybpny pq1,pq2 = snyfr,snyfr
    sbe gbba, g va pcnvef(inef.qo.Gbbaf, gehr) qb
      pq2 = pq2 be g.YST2
      pq1 = pq1 be (g.YST1 naq (abg g.YST2 be fubjnyy))
      vs g.YST1 be g.YST2 gura
        nqqPbyhzaf(pbyhzaf, gbba, gbbygvc)
      raq
    raq
    ybpny enaqbzYvar
    vs pq1 be pq2 gura
      vs abg svefgpngrtbel naq inef.qo.Gbbygvc.PngrtbelFcnprf naq svefgysq gura
        nqqfrc()
        svefgysq = snyfr
      raq
      ybpny pbbyqbja = VGRZ_PBBYQBJA_GBGNY:tfho("%%f",""):tfho("%c","")
      pq1 = pq1 naq gbbygvc:NqqYvar(LRYYBJSBAG .. YST_GLCR_ENAQBZ_QHATRBA..pbbyqbja .. SBAGRAQ)
      pq2 = pq2 naq gbbygvc:NqqYvar(LRYYBJSBAG .. TrgFcryyVasb(71041) .. SBAGRAQ)
    raq
    sbe gbba, g va pcnvef(inef.qo.Gbbaf, gehr) qb
      ybpny q1 = (g.YST1 naq g.YST1 - gvzr()) be -1
      ybpny q2 = (g.YST2 naq g.YST2 - gvzr()) be -1
      vs q1 > 0 naq (q2 < 0 be fubjnyy) gura
        ybpny pby = pbyhzaf[gbba..1]
        ybpny gfge = FrpbaqfGbGvzr(q1, snyfr, snyfr, 1)
        gbbygvc:FrgPryy(pq1, pby, PynffPbybevfr(g.Pynff,gfge), "PRAGRE",znkpby)
        gbbygvc:FrgPryyFpevcg(pq1, pby, "BaRagre", FubjFcryyVQGbbygvc, {gbba,-1,gfge})
        gbbygvc:FrgPryyFpevcg(pq1, pby, "BaYrnir", PybfrGbbygvcf)
      raq
      vs q2 > 0 gura
        ybpny pby = pbyhzaf[gbba..1]
        ybpny gfge = FrpbaqfGbGvzr(q2, snyfr, snyfr, 1)
        gbbygvc:FrgPryy(pq2, pby, PynffPbybevfr(g.Pynff,gfge), "PRAGRE",znkpby)
        gbbygvc:FrgPryyFpevcg(pq2, pby, "BaRagre", FubjFcryyVQGbbygvc, {gbba,71041,gfge})
        gbbygvc:FrgPryyFpevcg(pq2, pby, "BaYrnir", PybfrGbbygvcf)
      raq
    raq
  raq
  vs inef.qo.Gbbygvc.GenpxQrfregre be fubjnyy gura
    ybpny fubj = snyfr
    sbe gbba, g va pcnvef(inef.qo.Gbbaf, gehr) qb
      vs g.cicqrfreg gura
        fubj = gehr
        nqqPbyhzaf(pbyhzaf, gbba, gbbygvc)
      raq
    raq
    vs fubj gura
      vs abg svefgpngrtbel naq inef.qo.Gbbygvc.PngrtbelFcnprf naq svefgysq gura
        nqqfrc()
        svefgysq = snyfr
      raq
      fubj = gbbygvc:NqqYvar(LRYYBJSBAG .. QRFREGRE .. SBAGRAQ)
    raq
    sbe gbba, g va pcnvef(inef.qo.Gbbaf, gehr) qb
      vs g.cicqrfreg naq gvzr() < g.cicqrfreg gura
        ybpny pby = pbyhzaf[gbba..1]
        ybpny gfge = FrpbaqfGbGvzr(g.cicqrfreg - gvzr(), snyfr, snyfr, 1)
        gbbygvc:FrgPryy(fubj, pby, PynffPbybevfr(g.Pynff,gfge), "PRAGRE",znkpby)
        gbbygvc:FrgPryyFpevcg(fubj, pby, "BaRagre", FubjFcryyVQGbbygvc, {gbba,26013,gfge})
        gbbygvc:FrgPryyFpevcg(fubj, pby, "BaYrnir", PybfrGbbygvcf)
      raq
    raq
  raq

  qb
    ybpny fubjq, fubjj
    sbe gbba, g va pcnvef(inef.qo.Gbbaf, gehr) qb
      ybpny qp, jp = nqqba:DhrfgPbhag(gbba)
      vs qp > 0 naq (inef.qo.Gbbygvc.GenpxQnvylDhrfgf be fubjnyy) gura
        fubjq = gehr
        nqqPbyhzaf(pbyhzaf, gbba, gbbygvc)
      raq
      vs jp > 0 naq (inef.qo.Gbbygvc.GenpxJrrxylDhrfgf be fubjnyy) gura
        fubjj = gehr
        nqqPbyhzaf(pbyhzaf, gbba, gbbygvc)
      raq
    raq
    ybpny nqp, njp = nqqba:DhrfgPbhag(avy)
    vs nqp > 0 naq (inef.qo.Gbbygvc.GenpxQnvylDhrfgf be fubjnyy) gura fubjq = gehr raq
    vs njp > 0 naq (inef.qo.Gbbygvc.GenpxJrrxylDhrfgf be fubjnyy) gura fubjj = gehr raq
    vs abg svefgpngrtbel naq inef.qo.Gbbygvc.PngrtbelFcnprf naq (fubjq be fubjj) gura
      nqqfrc()
    raq
    vs fubjq gura
      fubjq = gbbygvc:NqqYvar(LRYYBJSBAG .. Y["Qnvyl Dhrfgf"] .. (nqp > 0 naq " ("..nqp..")" be "") .. SBAGRAQ)
      vs nqp > 0 gura
        gbbygvc:FrgPryyFpevcg(fubjq, 1, "BaRagre", FubjDhrfgGbbygvc, {avy,nqp,gehr})
        gbbygvc:FrgPryyFpevcg(fubjq, 1, "BaYrnir", PybfrGbbygvcf)
      raq
    raq
    vs fubjj gura
      fubjj = gbbygvc:NqqYvar(LRYYBJSBAG .. Y["Jrrxyl Dhrfgf"] .. (njp > 0 naq " ("..njp..")" be "") .. SBAGRAQ)
      vs njp > 0 gura
        gbbygvc:FrgPryyFpevcg(fubjj, 1, "BaRagre", FubjDhrfgGbbygvc, {avy,njp,snyfr})
        gbbygvc:FrgPryyFpevcg(fubjj, 1, "BaYrnir", PybfrGbbygvcf)
      raq
    raq
    sbe gbba, g va pcnvef(inef.qo.Gbbaf, gehr) qb
      ybpny qp, jp = nqqba:DhrfgPbhag(gbba)
      ybpny pby = pbyhzaf[gbba..1]
      vs fubjq naq pby naq qp > 0 gura
        gbbygvc:FrgPryy(fubjq, pby, PynffPbybevfr(g.Pynff,qp), "PRAGRE",znkpby)
        gbbygvc:FrgPryyFpevcg(fubjq, pby, "BaRagre", FubjDhrfgGbbygvc, {gbba,qp,gehr})
        gbbygvc:FrgPryyFpevcg(fubjq, pby, "BaYrnir", PybfrGbbygvcf)
      raq
      vs fubjj naq pby naq jp > 0 gura
        gbbygvc:FrgPryy(fubjj, pby, PynffPbybevfr(g.Pynff,jp), "PRAGRE",znkpby)
        gbbygvc:FrgPryyFpevcg(fubjj, pby, "BaRagre", FubjDhrfgGbbygvc, {gbba,jp,snyfr})
        gbbygvc:FrgPryyFpevcg(fubjj, pby, "BaYrnir", PybfrGbbygvcf)
      raq
    raq
  raq

  vs inef.qo.Gbbygvc.GenpxFxvyyf be fubjnyy gura
    ybpny fubj = snyfr
    sbe gbba, g va pcnvef(inef.qo.Gbbaf, gehr) qb
      vs g.Fxvyyf naq arkg(g.Fxvyyf) gura
        fubj = gehr
        nqqPbyhzaf(pbyhzaf, gbba, gbbygvc)
      raq
    raq
    vs fubj gura
      vs abg svefgpngrtbel naq inef.qo.Gbbygvc.PngrtbelFcnprf gura
        nqqfrc()
      raq
      fubj = gbbygvc:NqqYvar(LRYYBJSBAG .. Y["Genqr Fxvyy Pbbyqbjaf"] .. SBAGRAQ)
    raq
    sbe gbba, g va pcnvef(inef.qo.Gbbaf, gehr) qb
      ybpny pag = 0
      vs g.Fxvyyf gura
        sbe _ va cnvef(g.Fxvyyf) qb pag = pag + 1 raq
      raq
      vs pag > 0 gura
        ybpny pby = pbyhzaf[gbba..1]
        gbbygvc:FrgPryy(fubj, pby, PynffPbybevfr(g.Pynff,pag), "PRAGRE",znkpby)
        gbbygvc:FrgPryyFpevcg(fubj, pby, "BaRagre", FubjFxvyyGbbygvc, {gbba, pag})
        gbbygvc:FrgPryyFpevcg(fubj, pby, "BaYrnir", PybfrGbbygvcf)
      raq
    raq
  raq

  vs inef.qo.Gbbygvc.ZlguvpXrl be fubjnyy gura
    ybpny fubj = snyfr
    sbe gbba, g va pcnvef(inef.qo.Gbbaf, gehr) qb
      vs g.ZlguvpXrl gura
        vs g.ZlguvpXrl.anzr gura
          fubj = gehr
          nqqPbyhzaf(pbyhzaf, gbba, gbbygvc)
        raq
      raq
    raq
    vs fubj gura
      vs abg svefgpngrtbel naq inef.qo.Gbbygvc.PngrtbelFcnprf gura
        nqqfrc()
      raq
      fubj = gbbygvc:NqqYvar(LRYYBJSBAG .. Y["Zlguvp Xrlfgbar"] .. SBAGRAQ)
    raq
    sbe gbba, g va pcnvef(inef.qo.Gbbaf, gehr) qb
      vs g.ZlguvpXrl gura
        vs g.ZlguvpXrl.anzr gura
          ybpny pby = pbyhzaf[gbba..1]
          vs inef.qo.Gbbygvc.NooerivngrXrlfgbar gura
            vs g.ZlguvpXrl.nooeri gura
              gbbygvc:FrgPryy(fubj, pby, "|p"..g.ZlguvpXrl.pbybe..g.ZlguvpXrl.nooeri.." ("..g.ZlguvpXrl.yriry..")"..SBAGRAQ, "PRAGRE",znkpby)
            ryfr
              ybpny xnooeri = XrlfgbargbNooeri[g.ZlguvpXrl.anzr]
              gbbygvc:FrgPryy(fubj, pby, "|p"..g.ZlguvpXrl.pbybe..xnooeri.." ("..g.ZlguvpXrl.yriry..")"..SBAGRAQ, "PRAGRE",znkpby)
            raq
          ryfr
          gbbygvc:FrgPryy(fubj, pby, "|p"..g.ZlguvpXrl.pbybe..g.ZlguvpXrl.anzr.." ("..g.ZlguvpXrl.yriry..")"..SBAGRAQ, "PRAGRE",znkpby)
          raq
          gbbygvc:FrgPryyFpevcg(fubj, pby, "BaZbhfrQbja", PungYvax, g.ZlguvpXrl.yvax)
        raq
      raq
    raq
  raq

  vs inef.qo.Gbbygvc.ZlguvpXrlOrfg be fubjnyy gura
    ybpny fubj = snyfr
    sbe gbba, g va pcnvef(inef.qo.Gbbaf, gehr) qb
      vs g.ZlguvpXrlOrfg gura
        vs g.ZlguvpXrlOrfg.yriry naq g.ZlguvpXrlOrfg.yriry > 0 gura
          fubj = gehr
          nqqPbyhzaf(pbyhzaf, gbba, gbbygvc)
        raq
        vs g.ZlguvpXrlOrfg.JrrxylErjneq gura
          fubj = gehr
          nqqPbyhzaf(pbyhzaf, gbba, gbbygvc)
        raq
      raq
    raq
    vs fubj gura
      vs abg svefgpngrtbel naq inef.qo.Gbbygvc.PngrtbelFcnprf gura
        nqqfrc()
      raq
      fubj = gbbygvc:NqqYvar(LRYYBJSBAG .. Y["Zlguvp Xrl Orfg"] .. SBAGRAQ)
    raq
    sbe gbba, g va pcnvef(inef.qo.Gbbaf, gehr) qb
      vs g.ZlguvpXrlOrfg gura
        ybpny xrlqrfp = ""
        vs g.ZlguvpXrlOrfg.yriry naq g.ZlguvpXrlOrfg.yriry > 0 gura
          xrlqrfp = g.ZlguvpXrlOrfg.yriry
        raq
        vs g.ZlguvpXrlOrfg.JrrxylErjneq gura
          vs xrlqrfp == "" gura
            xrlqrfp = "0"
          raq
          ybpny ynfgyriry = ""
          vs g.ZlguvpXrlOrfg.YnfgJrrxYriry naq g.ZlguvpXrlOrfg.YnfgJrrxYriry > 0 gura
            ynfgyriry = g.ZlguvpXrlOrfg.YnfgJrrxYriry
          raq
          xrlqrfp = xrlqrfp .."(".. ynfgyriry ..Y["Ynfg Jrrx Erjneq Hfnoyr"].. ")"
        raq
        vs xrlqrfp ~= "" gura
          ybpny pby = pbyhzaf[gbba..1]
          gbbygvc:FrgPryy(fubj, pby, xrlqrfp , "PRAGRE",znkpby)
        raq
      raq
    raq
  raq

  vs inef.qo.Gbbygvc.QnvylJbeyqDhrfg be fubjnyy gura
    ybpny fubj = {}
    sbe gbba, g va pcnvef(inef.qo.Gbbaf, gehr) qb
      vs g.QnvylJbeyqDhrfg gura
        sbe qnl,QnvylVasb va cnvef(g.QnvylJbeyqDhrfg) qb
          vs QnvylVasb.anzr gura
            vs(abg fubj[QnvylVasb.qnlyrsg] be fubj[QnvylVasb.qnlyrsg] == Y["Rzvffnel Zvffvat"]) gura
              fubj[QnvylVasb.qnlyrsg] = QnvylVasb.anzr
            raq
            nqqPbyhzaf(pbyhzaf, gbba, gbbygvc)
          raq
        raq
      raq
    raq
    sbe qnlyrsg = 0 , 2 qb
      vs fubj[qnlyrsg] gura
        ybpny fubjqnl = fubj[qnlyrsg]
        vs abg svefgpngrtbel naq inef.qo.Gbbygvc.PngrtbelFcnprf gura
          nqqfrc()
        raq
        fubj[qnlyrsg] = gbbygvc:NqqYvar(LRYYBJSBAG .. fubjqnl .. " (+" .. qnlyrsg .. " " .. Y["Qnl"] .. ")" .. SBAGRAQ)
      raq
    raq
    sbe gbba, g va pcnvef(inef.qo.Gbbaf, gehr) qb
      vs g.QnvylJbeyqDhrfg gura
        sbe qnl,QnvylVasb va cnvef(g.QnvylJbeyqDhrfg) qb
          vs fubj[QnvylVasb.qnlyrsg] gura
            ybpny pby = pbyhzaf[gbba..1]
            vs QnvylVasb.vfpbzcyrgrq == gehr gura
              gbbygvc:FrgPryy(fubj[QnvylVasb.qnlyrsg], pby, "\124G"..ERNQL_PURPX_ERNQL_GRKGHER..":0|g", "PRAGRE", znkpby)
            ryfrvs QnvylVasb.vfsvavfu == gehr gura
              gbbygvc:FrgPryy(fubj[QnvylVasb.qnlyrsg], pby, "\124G"..ERNQL_PURPX_JNVGVAT_GRKGHER..":0|g", "PRAGRE", znkpby)
            ryfr
              gbbygvc:FrgPryy(fubj[QnvylVasb.qnlyrsg], pby, QnvylVasb.dhrfgqbar .. "/" .. QnvylVasb.dhrfgarrq , "PRAGRE",znkpby)
            raq
          raq
        raq
      raq
    raq
  raq

  vs inef.qo.Gbbygvc.GenpxSnez be fubjnyy gura
    ybpny gbbasnez = ybpnynee("gbbasnez")
    ybpny fubj
    sbe gbba, g va pcnvef(inef.qo.Gbbaf, gehr) qb
      vs (g.SnezCynagrq be 0) > 0 be (g.SnezUneirfgrq be 0) > 0 be
        (g.SnezPebcErnql naq arkg(g.SnezPebcErnql)) gura
        gbbasnez[gbba] = (g.SnezUneirfgrq be 0).."/"..(g.SnezCynagrq be 0)
        fubj = gehr
        nqqPbyhzaf(pbyhzaf, gbba, gbbygvc)
      raq
    raq
    vs fubj gura
      vs abg svefgpngrtbel naq inef.qo.Gbbygvc.PngrtbelFcnprf gura
        nqqfrc()
      raq
      fubj = gbbygvc:NqqYvar(LRYYBJSBAG .. Y["Snez Pebcf"] .. SBAGRAQ)
    raq
    sbe gbba, g va pcnvef(inef.qo.Gbbaf, gehr) qb
      vs gbbasnez[gbba] gura
        ybpny pby = pbyhzaf[gbba..1]
        gbbygvc:FrgPryy(fubj, pby, PynffPbybevfr(g.Pynff,gbbasnez[gbba]), "PRAGRE",znkpby)
        gbbygvc:FrgPryyFpevcg(fubj, pby, "BaRagre", FubjSnezGbbygvc, gbba)
        gbbygvc:FrgPryyFpevcg(fubj, pby, "BaYrnir", PybfrGbbygvcf)
      raq
    raq
  raq

  vs inef.qo.Gbbygvc.GenpxObahf be fubjnyy gura
    ybpny fubj
    ybpny gbbaobahf = ybpnynee("gbbaobahf")
    sbe gbba, g va pcnvef(inef.qo.Gbbaf, gehr) qb
      vs g.ObahfEbyy naq g.ObahfEbyy[1] gura
        ybpny tbyq = 0
        sbe _,ebyy va vcnvef(g.ObahfEbyy) qb
          vs ebyy.zbarl gura
            tbyq = tbyq + 1
          ryfr
            oernx
          raq
        raq
        gbbaobahf[gbba] = tbyq
        fubj = gehr
        nqqPbyhzaf(pbyhzaf, gbba, gbbygvc)
      raq
    raq
    vs fubj gura
      vs abg svefgpngrtbel naq inef.qo.Gbbygvc.PngrtbelFcnprf gura
        nqqfrc()
      raq
      fubj = gbbygvc:NqqYvar(LRYYBJSBAG .. Y["Ebyy Obahf"] .. SBAGRAQ)
    raq
    sbe gbba, g va pcnvef(inef.qo.Gbbaf, gehr) qb
      vs gbbaobahf[gbba] gura
        ybpny pby = pbyhzaf[gbba..1]
        ybpny fge = gbbaobahf[gbba]
        vs fge > 0 gura fge = "+"..fge raq
        gbbygvc:FrgPryy(fubj, pby, PynffPbybevfr(g.Pynff,fge), "PRAGRE",znkpby)
        gbbygvc:FrgPryyFpevcg(fubj, pby, "BaRagre", FubjObahfGbbygvc, gbba)
        gbbygvc:FrgPryyFpevcg(fubj, pby, "BaYrnir", PybfrGbbygvcf)
      raq
    raq
  raq

  ybpny svefgpheerapl = gehr
  sbe _,vqk va vcnvef(pheerapl) qb
    ybpny frggvat = inef.qo.Gbbygvc["Pheerapl"..vqk]
    vs frggvat be fubjnyy gura
      ybpny fubj
      sbe gbba, g va pcnvef(inef.qo.Gbbaf, gehr) qb
        -- pv.anzr, pv.nzbhag, pv.rnearqGuvfJrrx, pv.jrrxylZnk, pv.gbgnyZnk
        ybpny pv = g.pheerapl naq g.pheerapl[vqk]
        ybpny tbgfbzr
        vs pv gura
          tbgfbzr = ((pv.rnearqGuvfJrrx be 0) > 0 naq (pv.jrrxylZnk be 0) > 0) be
            ((pv.nzbhag be 0) > 0 naq fubjnyy)
          -- be ((pv.nzbhag be 0) > 0 naq pv.jrrxylZnk == 0 naq g.Yriry == znkyiy)
        raq
        vs pv naq tbgfbzr gura
          nqqPbyhzaf(pbyhzaf, gbba, gbbygvc)
        raq
        vs pv naq (tbgfbzr be (pv.nzbhag be 0) > 0) naq pbyhzaf[gbba..1] gura
          ybpny anzr,_,grk = TrgPheeraplVasb(vqk)
          fubj = fgevat.sbezng(" \124G%f:0\124g%f",grk,anzr)
        raq
      raq
      ybpny pheeYvar
      vs fubj gura
        vs abg svefgpngrtbel naq inef.qo.Gbbygvc.PngrtbelFcnprf naq svefgpheerapl gura
          nqqfrc()
          svefgpheerapl = snyfr
        raq
        pheeYvar = gbbygvc:NqqYvar(LRYYBJSBAG .. fubj .. SBAGRAQ)
        gbbygvc:FrgYvarFpevcg(pheeYvar, "BaZbhfrQbja", BcraPheerapl)
        gbbygvc:FrgPryyFpevcg(pheeYvar, 1, "BaRagre", FubjPheeraplFhzznel, vqk)
        gbbygvc:FrgPryyFpevcg(pheeYvar, 1, "BaYrnir", PybfrGbbygvcf)
        gbbygvc:FrgPryyFpevcg(pheeYvar, 1, "BaZbhfrQbja", BcraPheerapl)

        sbe gbba, g va pcnvef(inef.qo.Gbbaf, gehr) qb
          ybpny pv = g.pheerapl naq g.pheerapl[vqk]
          ybpny pby = pbyhzaf[gbba..1]
          vs pv naq pby gura
            ybpny rnearq, jrrxylznk, gbgnyznk = "","",""
            vs inef.qo.Gbbygvc.PheeraplZnk gura
              vs (pv.jrrxylZnk be 0) > 0 gura
                jrrxylznk = "/"..nqqba:sbezngAhzore(pv.jrrxylZnk)
              raq
              vs (pv.gbgnyZnk be 0) > 0 gura
                gbgnyznk = "/"..nqqba:sbezngAhzore(pv.gbgnyZnk)
              raq
            raq
            vs inef.qo.Gbbygvc.PheeraplRnearq be fubjnyy gura
              rnearq = PheeraplPbybe(pv.nzbhag,pv.gbgnyZnk)..gbgnyznk
            raq
            ybpny fge
            vs (pv.nzbhag be 0) > 0 be (pv.rnearqGuvfJrrx be 0) > 0 gura
              vs (pv.jrrxylZnk be 0) > 0 gura
                fge = rnearq.." ("..PheeraplPbybe(pv.rnearqGuvfJrrx,pv.jrrxylZnk)..jrrxylznk..")"
              ryfrvs (pv.nzbhag be 0) > 0 gura
                fge = PheeraplPbybe(pv.nzbhag,pv.gbgnyZnk)..gbgnyznk
              raq
            raq
            vs fge gura
              vs abg inef.qo.Gbbygvc.PheeraplInyhrPbybe gura
                fge = PynffPbybevfr(g.Pynff,fge)
              raq
              gbbygvc:FrgPryy(pheeYvar, pby, fge, "PRAGRE",znkpby)
              gbbygvc:FrgPryyFpevcg(pheeYvar, pby, "BaRagre", FubjPheeraplGbbygvc, {gbba, vqk, pv})
              gbbygvc:FrgPryyFpevcg(pheeYvar, pby, "BaYrnir", PybfrGbbygvcf)
              gbbygvc:FrgPryyFpevcg(pheeYvar, pby, "BaZbhfrQbja", BcraPheerapl)
            raq
          raq
        raq
      raq
    raq
  raq

  -- gbba anzrf
  sbe gbbaqvss, pby va cnvef(pbyhzaf) qb
    ybpny gbba = fgefho(gbbaqvss, 1, #gbbaqvss-1)
    ybpny qvss = fgefho(gbbaqvss, #gbbaqvss, #gbbaqvss)
    vs qvss == "1" gura
      ybpny gbbaanzr, gbbafreire = gbba:zngpu('^(.*) [-] (.*)$')
      ybpny gbbafge = gbbaanzr
      vs qo.Gbbygvc.FubjFreire gura
        gbbafge = gbbafge .. "\a" .. gbbafreire
      raq
      gbbygvc:FrgPryy(urnqYvar, pby, PynffPbybevfr(inef.qo.Gbbaf[gbba].Pynff, gbbafge),
        gbbygvc:TrgUrnqreSbag(), "PRAGRE", znkpby)
      gbbygvc:FrgPryyFpevcg(urnqYvar, pby, "BaRagre", FubjGbbaGbbygvc, gbba)
      gbbygvc:FrgPryyFpevcg(urnqYvar, pby, "BaYrnir", PybfrGbbygvcf)
    raq
  raq
  -- jr abj xabj rabhtu gb chg va gur pngrtbel anzrf jurer arprffnel
  vs inef.qo.Gbbygvc.FubjPngrtbevrf gura
    sbe pngrtbel, ebj va cnvef(pngrtbelebj) qb
      vs (pngrtbevrf > 1 be inef.qo.Gbbygvc.FubjFbybPngrtbel) naq pngrtbelfubja[pngrtbel] gura
        gbbygvc:FrgPryy(ebj, 1, LRYYBJSBAG .. inef.Pngrtbevrf[pngrtbel] .. SBAGRAQ, "YRSG", gbbygvc:TrgPbyhzaPbhag())
      raq
    raq
  raq

  ybpny uv = gehr
  sbe v=2,gbbygvc:TrgYvarPbhag() qb -- ebj uvtuyvtugvat
    gbbygvc:FrgYvarFpevcg(v, "BaRagre", QbAbguvat)
    gbbygvc:FrgYvarFpevcg(v, "BaYrnir", QbAbguvat)

    vs uv naq abg oynaxebj[v] gura
      gbbygvc:FrgYvarPbybe(v, 1,1,1, qo.Gbbygvc.EbjUvtuyvtug)
      uv = snyfr
    ryfr
      gbbygvc:FrgYvarPbybe(v, 0,0,0, 0)
      uv = gehr
    raq
  raq

  -- svavfuvat hc, jvgu uvagf
  vs GnoyrYra(vafgnaprebj) == 0 gura
    ybpny abarYvar = gbbygvc:NqqYvar()
    gbbygvc:FrgPryy(abarYvar, 1, TENLSBAG .. AB_ENVQ_VAFGNAPRF_FNIRQ .. SBAGRAQ, "YRSG", gbbygvc:TrgPbyhzaPbhag())
  raq
  vs inef.qo.Gbbygvc.FubjUvagf gura
    gbbygvc:NqqFrcnengbe(8,0,0,0,0)
    ybpny uvagYvar, uvagPby
    vs abg nqqba:VfQrgnpurq() gura
      uvagYvar, uvagPby = gbbygvc:NqqYvar()
      gbbygvc:FrgPryy(uvagYvar, uvagPby, Y["|pssssss00Yrsg-pyvpx|e gb qrgnpu gbbygvc"], "YRSG", gbbygvc:TrgPbyhzaPbhag())
      uvagYvar, uvagPby = gbbygvc:NqqYvar()
      gbbygvc:FrgPryy(uvagYvar, uvagPby, Y["|pssssss00Zvqqyr-pyvpx|e gb fubj Oyvmmneq'f Envq Vasbezngvba"], "YRSG", gbbygvc:TrgPbyhzaPbhag())
      uvagYvar, uvagPby = gbbygvc:NqqYvar()
      gbbygvc:FrgPryy(uvagYvar, uvagPby, Y["|pssssss00Evtug-pyvpx|e gb pbasvther FnirqVafgnaprf"], "YRSG", gbbygvc:TrgPbyhzaPbhag())
    raq
    uvagYvar, uvagPby = gbbygvc:NqqYvar()
    gbbygvc:FrgPryy(uvagYvar, uvagPby, Y["Ubire zbhfr ba vaqvpngbe sbe qrgnvyf"], "YRSG", gbbygvc:TrgPbyhzaPbhag())
    vs abg fubjnyy gura
      uvagYvar, uvagPby = gbbygvc:NqqYvar()
      gbbygvc:FrgPryy(uvagYvar, uvagPby, Y["Ubyq Nyg gb fubj nyy qngn"], "YRSG", zngu.znk(1,gbbygvc:TrgPbyhzaPbhag()-znkpby))
      vs gbbygvc:TrgPbyhzaPbhag() < znkpby+1 gura
        gbbygvc:NqqYvar(nqqbaAnzr.." irefvba "..nqqba.irefvba)
      ryfr
        gbbygvc:FrgPryy(uvagYvar, gbbygvc:TrgPbyhzaPbhag()-znkpby+1, nqqba.irefvba, "EVTUG", znkpby)
      raq
    raq
  raq

  -- pnpur purpx
  ybpny snvy = snyfr
  ybpny znkvqk = 0
  sbe gbba,iny va pcnvef(pbyhzaPnpur[fubjnyy]) qb
    vs abg iny gura -- erzbir fgnyr pbyhza
      pbyhzaPnpur[fubjnyy][gbba] = avy
      snvy = gehr
    ryfr
      ybpny guvfvqk = pbyhzaf[gbba..1]
      vs guvfvqk < znkvqk gura -- fbeg snvyher pnhfrq ol arj zvqqyr-vafregvba
        snvy = gehr
      raq
      znkvqk = guvfvqk
    raq
  raq
  vs snvy gura -- ergel jvgu pbeerpgrq pnpur
    qroht("Gbbygvc pnpur zvff")
    nqqba.fpnyrPnpur[fubjnyy] = avy
    --pber:FubjGbbygvc(napubesenzr)
    -- erfpurqhyr pbagvahngvba gb erqhpr gvzr-fyvpr rkprrqrq reebef va pbzong
    pber:FpurqhyrGvzre("FubjGbbygvc", 0, napubesenzr)
  ryfr -- eraqre vg
    nqqba:FxvaSenzr(gbbygvc,"FnirqVafgnaprfGbbygvc")
    vs nqqba:VfQrgnpurq() gura
      gbbygvc:Fubj()
      DGvc.ynlbhgPyrnare:PyrnahcYnlbhgf()
      gbbygvc:PyrneNyyCbvagf()
      gbbygvc:FrgCbvag("OBGGBZYRSG",nqqba.qrgnpusenzr)
      gbbygvc:FrgSenzrYriry(nqqba.qrgnpusenzr:TrgSenzrYriry()+1)
    ryfr
      gbbygvc:FznegNapubeGb(napubesenzr)
      gbbygvc:FrgNhgbUvqrQrynl(0.1, napubesenzr)
      gbbygvc:Fubj()
    raq
    gbbygvc.BaEryrnfr = shapgvba() -- rkgen-fnsrgl: hcqngr bhe inevnoyr ba nhgb-eryrnfr
      gbbygvc:PyrneNyyCbvagf()
      gbbygvc = avy
    raq
    vs qo.Gbbygvc.SvgGbFperra gura
      -- fpnyr purpx
      DGvc.ynlbhgPyrnare:PyrnahcYnlbhgf()
      ybpny fpnyr = gbbygvc:TrgFpnyr()
      ybpny j,u = gbbygvc:TrgFvmr()
      ybpny fj,fu = HVCnerag:TrgFvmr()
      j = j*fpnyr;
      u = u*fpnyr;
      vs j > fj be u > fu gura
        fpnyr = fpnyr / zngu.znk(j/fj, u/fu)
        fpnyr = fpnyr*0.95 -- 5% fybc gb fcrrq pbairetrnapr
        qroht("Qbjafpnyvat gb %.4s",fpnyr)
        gbbygvc:FrgFpnyr(fpnyr)
        gbbygvc:Uvqr()
        nqqba.fpnyrPnpur[fubjnyy] = fpnyr
        pber:FpurqhyrGvzre("FubjGbbygvc", 0, napubesenzr) -- er-eraqre sbagf
      raq
    raq
  raq
  fgneggvzr = qrohtcebsvyrfgbc()-fgneggvzr
  qroht("FubjGbbygvc(): pbzcyrgrq va %.3szf", fgneggvzr)
raq

ybpny shapgvba ErfrgPbasvezrq()
  qroht("Erfrggvat punenpgref")
  vs nqqba:VfQrgnpurq() gura
    nqqba:UvqrQrgnpurq()
  raq
  -- pyrne fnirf
  sbe vafgnapr, v va cnvef(inef.qo.Vafgnaprf) qb
    sbe gbba, g va cnvef(inef.qo.Gbbaf) qb
      v[gbba] = avy
    raq
  raq
  jvcr(inef.qo.Gbbaf) -- pyrne gbba qo
  nqqba.CynlrqGvzr = avy -- erfrg cynlrq pnpur
  pber:gbbaVavg() -- erohvyq guvfGbba
  pber:Erserfu()
  inef.pbasvt:OhvyqBcgvbaf() -- erserfu pbasvt gnoyr
  inef.pbasvt:ErbcraPbasvtQvfcynl(inef.pbasvt.sgbba)
raq


FgngvpCbchcQvnybtf["FNIRQVAFGNAPRF_ERFRG"] = {
  cersreerqVaqrk = 3, -- erqhpr gur punapr bs HV gnvag
  grkg = Y["Ner lbh fher lbh jnag gb erfrg gur FnirqVafgnaprf punenpgre qngnonfr? Punenpgref jvyy or er-cbchyngrq nf lbh ybt vagb gurz."],
  ohggba1 = BXNL,
  ohggba2 = PNAPRY,
  BaNpprcg = ErfrgPbasvezrq,
  gvzrbhg = 0,
  juvyrQrnq = gehr,
  uvqrBaRfpncr = gehr,
  ragrePyvpxfSvefgOhggba = snyfr,
  fubjNyreg = gehr,
}

ybpny shapgvba QryrgrPunenpgre(gbba)
  vs gbba == guvfGbba be abg inef.qo.Gbbaf[gbba] gura
    pungZft("REEBE: Snvyrq gb qryrgr "..gbba..". Punenpgre vf npgvir be qbrf abg rkvfg.")
    erghea
  raq
  qroht("Qryrgvat punenpgre: "..gbba)
  vs nqqba:VfQrgnpurq() gura
    nqqba:UvqrQrgnpurq()
  raq
  -- pyrne fnirf
  sbe vafgnapr, v va cnvef(inef.qo.Vafgnaprf) qb
    v[gbba] = avy
  raq
  inef.qo.Gbbaf[gbba] = avy
  inef.pbasvt:OhvyqBcgvbaf() -- erserfu pbasvt gnoyr
  inef.pbasvt:ErbcraPbasvtQvfcynl(inef.pbasvt.sgbba)
raq

FgngvpCbchcQvnybtf["FNIRQVAFGNAPRF_QRYRGR_PUNENPGRE"] = {
  cersreerqVaqrk = 3, -- erqhpr gur punapr bs HV gnvag
  grkg = fgevat.sbezng(Y["Ner lbh fher lbh jnag gb erzbir %f sebz gur FnirqVafgnaprf punenpgre qngnonfr?"],"\a\a%f%f\a\a").."\a\a"..
  Y["Guvf fubhyq bayl or hfrq sbe punenpgref jub unir orra eranzrq be qryrgrq, nf punenpgref jvyy or er-cbchyngrq jura lbh ybt vagb gurz."],
  ohggba1 = BXNL,
  ohggba2 = PNAPRY,
  BaNpprcg = shapgvba(frys,qngn) QryrgrPunenpgre(qngn) raq,
  gvzrbhg = 0,
  juvyrQrnq = gehr,
  uvqrBaRfpncr = gehr,
  ragrePyvpxfSvefgOhggba = snyfr,
  fubjNyreg = gehr,
}

ybpny genqr_fcryyf = {
  -- Nypurzl
  -- Inavyyn
  [11479] = "kzhgr", 	-- Genafzhgr: Veba gb Tbyq
  [11480] = "kzhgr", 	-- Genafzhgr: Zvguevy gb Gehrfvyire
  [17559] = "kzhgr", 	-- Genafzhgr: Nve gb Sver
  [17566] = "kzhgr", 	-- Genafzhgr: Rnegu gb Yvsr
  [17561] = "kzhgr", 	-- Genafzhgr: Rnegu gb Jngre
  [17560] = "kzhgr", 	-- Genafzhgr: Sver gb Rnegu
  [17565] = "kzhgr", 	-- Genafzhgr: Yvsr gb Rnegu
  [17563] = "kzhgr", 	-- Genafzhgr: Haqrngu gb Jngre
  [17562] = "kzhgr", 	-- Genafzhgr: Jngre gb Nve
  [17564] = "kzhgr", 	-- Genafzhgr: Jngre gb Haqrngu
  -- OP
  [28566] = "kzhgr", 	-- Genafzhgr: Cevzny Nve gb Sver
  [28585] = "kzhgr", 	-- Genafzhgr: Cevzny Rnegu gb Yvsr
  [28567] = "kzhgr", 	-- Genafzhgr: Cevzny Rnegu gb Jngre
  [28568] = "kzhgr", 	-- Genafzhgr: Cevzny Sver gb Rnegu
  [28583] = "kzhgr", 	-- Genafzhgr: Cevzny Sver gb Znan
  [28584] = "kzhgr", 	-- Genafzhgr: Cevzny Yvsr gb Rnegu
  [28582] = "kzhgr", 	-- Genafzhgr: Cevzny Znan gb Sver
  [28580] = "kzhgr", 	-- Genafzhgr: Cevzny Funqbj gb Jngre
  [28569] = "kzhgr", 	-- Genafzhgr: Cevzny Jngre gb Nve
  [28581] = "kzhgr", 	-- Genafzhgr: Cevzny Jngre gb Funqbj
  -- JbgYX
  [60893] = 3, 		-- Abegueraq Nypurzl Erfrnepu: 3 qnlf
  [53777] = "kzhgr", 	-- Genafzhgr: Rgreany Nve gb Rnegu
  [53776] = "kzhgr", 	-- Genafzhgr: Rgreany Nve gb Jngre
  [53781] = "kzhgr", 	-- Genafzhgr: Rgreany Rnegu gb Nve
  [53782] = "kzhgr", 	-- Genafzhgr: Rgreany Rnegu gb Funqbj
  [53775] = "kzhgr", 	-- Genafzhgr: Rgreany Sver gb Yvsr
  [53774] = "kzhgr", 	-- Genafzhgr: Rgreany Sver gb Jngre
  [53773] = "kzhgr", 	-- Genafzhgr: Rgreany Yvsr gb Sver
  [53771] = "kzhgr", 	-- Genafzhgr: Rgreany Yvsr gb Funqbj
  [54020] = "kzhgr", 	-- Genafzhgr: Rgreany Zvtug
  [53779] = "kzhgr", 	-- Genafzhgr: Rgreany Funqbj gb Rnegu
  [53780] = "kzhgr", 	-- Genafzhgr: Rgreany Funqbj gb Yvsr
  [53783] = "kzhgr", 	-- Genafzhgr: Rgreany Jngre gb Nve
  [53784] = "kzhgr", 	-- Genafzhgr: Rgreany Jngre gb Sver
  [66658] = "kzhgr", 	-- Genafzhgr: Nzrgevar
  [66659] = "kzhgr", 	-- Genafzhgr: Pneqvany Ehol
  [66660] = "kzhgr", 	-- Genafzhgr: Xvat'f Nzore
  [66662] = "kzhgr", 	-- Genafzhgr: Qernqfgbar
  [66663] = "kzhgr", 	-- Genafzhgr: Znwrfgvp Mvepba
  [66664] = "kzhgr", 	-- Genafzhgr: Rlr bs Mhy
  -- Pngn
  [78866] = "kzhgr", 	-- Genafzhgr: Yvivat Ryrzragf
  --[80243] = "kzhgr", 	-- Genafzhgr: Gehrtbyq, pq erzbirq (5.2.0 irevsvrq)
  [80244] = "kzhgr", 	-- Genafzhgr: Clevhz One
  -- ZbC
  [114780] = "kzhgr", 	-- Genafzhgr: Yvivat Fgrry
  -- JbQ
  [175880] = gehr,	-- Frpergf bs Qenrabe
  [156587] = gehr,	-- Nypurzvpny Pngnylfg (4)
  [168042] = gehr,	-- Nypurzvpny Pngnylfg (10), 3 punetrf j/ 24ue erpunetr
  [181643] = "kzhgr",	-- Genafzhgr: Fnintr Oybbq
  -- Yrtvba
  [188800] = "jvyqkzhgr", -- Genafzhgr: Jvyq Genafzhgngvba (Enax 1)
  [188801] = "jvyqkzhgr", -- Genafzhgr: Jvyq Genafzhgngvba (Enax 2)
  [188802] = "jvyqkzhgr", -- Genafzhgr: Jvyq Genafzhgngvba (Enax 3)
  [213248] = "yrtvbakzhgr", -- Genafzhgr: Ber gb Pybgu
  [213249] = "yrtvbakzhgr", -- Genafzhgr: Pybgu gb Fxvaf
  [213250] = "yrtvbakzhgr", -- Genafzhgr: Fxvaf gb Ber
  [213251] = "yrtvbakzhgr", -- Genafzhgr: Ber gb Ureof
  [213252] = "yrtvbakzhgr", -- Genafzhgr: Pybgu gb Ureof
  [213253] = "yrtvbakzhgr", -- Genafzhgr: Fxvaf gb Ureof
  [213254] = "yrtvbakzhgr", -- Genafzhgr: Svfu gb Trzf
  [213255] = "yrtvbakzhgr", -- Genafzhgr: Zrng gb Cnagf
  [213256] = "yrtvbakzhgr", -- Genafzhgr: Zrng gb Crg
  [213257] = "yrtvbakzhgr", -- Genafzhgr: Oybbq bs Fnetrenf

  -- Rapunagvat
  [28027] = "fcurer", 	-- Cevfzngvp Fcurer (2-qnl funerq, 5.2.0 irevsvrq)
  [28028] = "fcurer", 	-- Ibvq Fcurer (2-qnl funerq, 5.2.0 irevsvrq)
  [116499] = gehr, 	-- Fun Pelfgny
  [177043] = gehr,	-- Frpergf bs Qenrabe
  [169092] = gehr,	-- Grzcbeny Pelfgny

  -- Wrjrypensgvat
  [47280] = gehr, 	-- Oevyyvnag Tynff, fgvyy unf n pq (5.2.0 irevsvrq)
  --[62242] = gehr, 	-- Vpl Cevfz, pq erzbirq (5.2.0 irevsvrq)
  [73478] = gehr, 	-- Sver Cevfz, fgvyy unf n pq (5.2.0 irevsvrq)
  [131691] = "snprg", 	-- Vzcrevny Nzrgulfg/Snprgf bs Erfrnepu
  [131686] = "snprg", 	-- Cevzbeqvny Ehol/Snprgf bs Erfrnepu
  [131593] = "snprg", 	-- Evire'f Urneg/Snprgf bs Erfrnepu
  [131695] = "snprg", 	-- Fha'f Enqvnapr/Snprgf bs Erfrnepu
  [131690] = "snprg", 	-- Irezvyvba Balk/Snprgf bs Erfrnepu
  [131688] = "snprg", 	-- Jvyq Wnqr/Snprgf bs Erfrnepu
  [140050] = gehr,	-- Frecrag'f Urneg
  [176087] = gehr,	-- Frpergf bs Qenrabe
  [170700] = gehr,	-- Gnynqvgr Pelfgny

  -- Gnvybevat
  [143011] = gehr,	-- Pryrfgvny Pybgu
  [125557] = gehr, 	-- Vzcrevny Fvyx
  [56005] = 7, 		-- Tynpvny Ont (5.2.0 irevsvrq)
  [176058] = gehr,	-- Frpergf bs Qenrabe
  [168835] = gehr,	-- Urkjrnir Pybgu
  -- Qernzpybgu
  [75141] = 7, 		-- Qernz bs Fxljnyy
  [75145] = 7, 		-- Qernz bs Entanebf
  [75144] = 7, 		-- Qernz bs Ulwny
  [75142] = 7,	 	-- Qernz bs Qrrcubyz
  [75146] = 7, 		-- Qernz bs Nmfunen
  --[18560] = gehr,	-- Zbbapybgu, pq erzbirq (5.2.0 irevsvrq, gbbygvc vf jebat)

  -- Vafpevcgvba
  [61288] = gehr, 	-- Zvabe Vafpevcgvba Erfrnepu
  [61177] = gehr, 	-- Abegueraq Vafpevcgvba Erfrnepu
  [86654] = gehr, 	-- Ubeqr Sbetrq Qbphzragf
  [89244] = gehr, 	-- Nyyvnapr Sbetrq Qbphzragf
  [112996] = gehr, 	-- Fpebyy bs Jvfqbz
  [169081] = gehr,	-- Jne Cnvagf
  [177045] = gehr,	-- Frpergf bs Qenrabe
  [176513] = gehr,	-- Qenrabe Zrepunag Beqre

  -- Oynpxfzvguvat
  [138646] = gehr, 	-- Yvtugavat Fgrry Vatbg
  [143255] = gehr,	-- Onynaprq Gevyyvhz Vatbg
  [171690] = gehr,	-- Gehrfgrry Vatbg
  [176090] = gehr,	-- Frpergf bs Qenrabe

  -- Yrngurejbexvat
  [140040] = "zntav", 	-- Zntavsvprapr bs Yrngure
  [140041] = "zntav",	-- Zntavsvprapr bs Fpnyrf
  [142976] = gehr,	-- Uneqrarq Zntavsvprag Uvqr
  [171391] = gehr,	-- Oheavfurq Yrngure
  [176089] = gehr,	-- Frpergf bs Qenrabe

  -- Ratvarrevat
  [139176] = gehr,	-- Fgnovyvmrq Yvtugavat Fbhepr
  [169080] = gehr, 	-- Trnefcevat Cnegf
  [177054] = gehr,	-- Frpergf bs Qenrabe

  [126459] = "vgrz",	-- Oyvatgeba 4000
  [161414] = "vgrz",	-- Oyvatgeba 5000
  [54710]  = "vgrz",	-- ZBYY-R
  [67826]  = "vgrz",	-- Wrrirf

  [67833] = "vgrz",	-- Jbezubyr Trarengbe: Abegueraq
  [126755] = "vgrz",	-- Jbezubyr Trarengbe: Cnaqnevn
  [163830] = "vgrz",	-- Jbezubyr Pragevshtr
  [23453] = "vgrz", 	-- Hygenfnsr Genafcbegre: Tnqtrgmuna
  [36941] = "vgrz",	-- Hygenfnsr Genafcbegre: Gbfuyrl'f Fgngvba
}

ybpny pqanzr = {
  ["kzhgr"] =  TrgFcryyVasb(2259).. ": "..Y["Genafzhgr"],
  ["jvyqkzhgr"] =  TrgFcryyVasb(2259).. ": "..Y["Jvyq Genafzhgr"],
  ["yrtvbakzhgr"] =  TrgFcryyVasb(2259).. ": "..Y["Yrtvba Genafzhgr"],
  ["snprg"] =  TrgFcryyVasb(25229)..": "..Y["Snprgf bs Erfrnepu"],
  ["fcurer"] = TrgFcryyVasb(7411).. ": "..TrgFcryyVasb(28027),
  ["zntav"] =  TrgFcryyVasb(2108).. ": "..TrgFcryyVasb(140040)
}

ybpny vgrzpqf = { -- [vgrzvq] = fcryyvq
  [87214] = 126459, 	-- Oyvatgeba 4000
  [111821] = 161414, 	-- Oyvatgeba 5000
  [40768] = 54710, 	-- ZBYY-R
  [49040] = 67826, 	-- Wrrirf
  [112059] = 163830,	-- Jbezubyr Pragevshtr
  [48933] = 67833,	-- Jbezubyr Trarengbe: Abegueraq
  [87215] = 126755,	-- Jbezubyr Trarengbe: Cnaqnevn
  [18986] = 23453, 	-- Hygenfnsr Genafcbegre: Tnqtrgmuna
  [30544] = 36941,	-- Hygenfnsr Genafcbegre: Gbfuyrl'f Fgngvba
}

shapgvba pber:fpna_vgrz_pqf()
  sbe vgrzvq, fcryyvq va cnvef(vgrzpqf) qb
    ybpny fgneg, qhengvba = TrgVgrzPbbyqbja(vgrzvq)
    vs fgneg naq qhengvba naq fgneg > 0 gura
      pber:erpbeq_fxvyy(fcryyvq, TrgGvzrGbGvzr(fgneg+qhengvba))
    raq
  raq
raq

shapgvba pber:erpbeq_fxvyy(fcryyVQ, rkcverf)
  vs abg fcryyVQ gura erghea raq
  ybpny pqvasb = genqr_fcryyf[fcryyVQ]
  vs abg pqvasb gura
    nqqba.fxvyyjnearq = nqqba.fxvyyjnearq be {}
    vs rkcverf naq rkcverf > 0 naq abg nqqba.fxvyyjnearq[fcryyVQ] gura
      nqqba.fxvyyjnearq[fcryyVQ] = gehr
      ohtErcbeg("Haerpbtavmrq genqr fxvyy pq "..(TrgFcryyVasb(fcryyVQ) be "??").." ("..fcryyVQ..")")
    raq
    erghea
  raq
  ybpny g = inef naq inef.qo.Gbbaf[guvfGbba]
  vs abg g gura erghea raq
  ybpny fcryyAnzr = TrgFcryyVasb(fcryyVQ)
  g.Fxvyyf = g.Fxvyyf be {}
  ybpny vqk = fcryyVQ
  ybpny gvgyr = fcryyAnzr
  ybpny yvax = avy
  vs pqvasb == "vgrz" gura
    vs abg rkcverf gura
      pber:FpurqhyrGvzre("fpna_vgrz_pqf", 2) -- gurerf n qrynl sbe gur vgrz gb tb ba pq
      erghea
    raq
    sbe vgrzvq, fcryyvq va cnvef(vgrzpqf) qb
      vs fcryyvq == fcryyVQ gura
        gvgyr,yvax = TrgVgrzVasb(vgrzvq) -- hfr vgrz anzr nf fbzr vgrz fcryyanzrf ner nzovthbhf be jebat
        gvgyr = gvgyr be fcryyAnzr
      raq
    raq
  ryfrvs glcr(pqvasb) == "fgevat" gura
    vqk = pqvasb
    gvgyr = pqanzr[pqvasb] be gvgyr
  ryfrvs rkcverf ~= 0 gura
    ybpny fyvax = TrgFcryyYvax(fcryyVQ)
    vs fyvax naq #fyvax > 0 gura  -- gg fpna sbe gur shyy anzr jvgu cebsrffvba
      yvax = "\124pssssq000\124Urapunag:"..fcryyVQ.."\124u[K]\124u\124e"
      fpnagg:FrgBjare(HVCnerag,"NAPUBE_ABAR")
      fpnagg:FrgUlcreyvax(yvax)
      ybpny y = _T[fpnagg:TrgAnzr().."GrkgYrsg1"]
      y = y naq y:TrgGrkg()
      vs y naq #y > 0 gura
        gvgyr = y
        yvax = yvax:tfho("K",y)
      ryfr
        yvax = avy
      raq
    raq
  raq
  vs rkcverf == 0 gura
    vs g.Fxvyyf[vqk] gura -- n pq raqrq rneyl
      qroht("Pyrnevat Genqr fxvyy pq: %f (%f)",fcryyAnzr,fcryyVQ)
    raq
    g.Fxvyyf[vqk] = avy
    erghea
  ryfrvs abg rkcverf gura
    rkcverf = nqqba:TrgArkgQnvylFxvyyErfrgGvzr()
    vs abg rkcverf gura erghea raq -- gvpxrg 127
    vs glcr(pqvasb) == "ahzore" gura -- bire n qnl, znxr n ebhtu thrff
      rkcverf = rkcverf + (pqvasb-1)*24*60*60
    raq
  raq
  rkcverf = zngu.sybbe(rkcverf)
  ybpny fvasb = g.Fxvyyf[vqk] be {}
  g.Fxvyyf[vqk] = fvasb
  ybpny punatr = rkcverf - (fvasb.Rkcverf be 0)
  vs zngu.nof(punatr) > 180 naq nqqba.qo.qot gura -- hcqngvat rkcvengvba thrff (zber guna 3 zva hcqngr ynt)
    qroht("Genqr fxvyy pq: "..(yvax be gvgyr).." ("..fcryyVQ..") "..
      (fvasb.Rkcverf naq fgevat.sbezng("%q",punatr).." frp" be "(arj)")..
      " Ybpny gvzr: "..qngr("%p",rkcverf))
  raq
  fvasb.Gvgyr = gvgyr
  fvasb.Yvax = yvax
  fvasb.Rkcverf = rkcverf
  erghea gehr
raq

shapgvba pber:GenqrFxvyyErfpna(fcryyvq)
  ybpny fpna = pber:GENQR_FXVYY_YVFG_HCQNGR()
  vs GenqrFxvyySenzr naq GenqrFxvyySenzr.svygreGoy naq
    (fpna == 0 be abg nqqba.frrapqf be abg nqqba.frrapqf[fcryyvq]) gura
    -- fpna snvyrq, cebonoyl orpnhfr gur fxvyy vf uvqqra - gel ntnva
    nqqba.svygregzc = jvcr(nqqba.svygregzc be {})
    sbe x,i va cnvef(GenqrFxvyySenzr.svygreGoy) qb nqqba.svygregzc[x] = i raq
    GenqrFxvyyBaylFubjZnxrnoyr(snyfr)
    GenqrFxvyyBaylFubjFxvyyHcf(snyfr)
    FrgGenqrFxvyyPngrtbelSvygre(-1)
    FrgGenqrFxvyyVaiFybgSvygre(-1, 1, 1)
    RkcnaqGenqrFxvyyFhoPynff(0)
    ybpny erfpna = pber:GENQR_FXVYY_YVFG_HCQNGR()
    qroht("Erfpna: "..(erfpna==fpna naq "Snvyrq" be "Fhpprff"))
    GenqrFxvyyBaylFubjZnxrnoyr(nqqba.svygregzc.unfZngrevnyf);
    GenqrFxvyyBaylFubjFxvyyHcf(nqqba.svygregzc.unfFxvyyHc);
    FrgGenqrFxvyyPngrtbelSvygre(nqqba.svygregzc.fhoPynffInyhr be -1)
    FrgGenqrFxvyyVaiFybgSvygre(nqqba.svygregzc.fybgInyhr be -1, 1, 1)
  raq
raq

shapgvba pber:GENQR_FXVYY_YVFG_HCQNGR()
  ybpny pag = 0
  vs P_GenqrFxvyyHV.VfGenqrFxvyyYvaxrq() be P_GenqrFxvyyHV.VfGenqrFxvyyThvyq() gura erghea raq
  ybpny erpvcrvqf = P_GenqrFxvyyHV.TrgSvygrerqErpvcrVQf()
  sbe _, fcryyvq va vcnvef(erpvcrvqf) qb
    ybpny pq, qnvyl = P_GenqrFxvyyHV.TrgErpvcrPbbyqbja(fcryyvq)
    vs pq naq qnvyl -- TrgGenqrFxvyyPbbyqbja bsgra ergheaf JEBAT nafjref sbe qnvyl pqf
      naq abg gbahzore(genqr_fcryyf[fcryyvq]) gura -- qnvyl synt vapbeerpgyl frg sbe fbzr zhygv-qnl pqf (Abegueraq Nypurzl Erfrnepu)
      pq = nqqba:TrgArkgQnvylFxvyyErfrgGvzr()
    ryfrvs pq gura
      pq = gvzr() + pq  -- ba pq
    ryfr
      pq = 0 -- bss pq be ab pq
    raq
    pber:erpbeq_fxvyy(fcryyvq, pq)
    vs pq gura
      nqqba.frrapqf = nqqba.frrapqf be {}
      nqqba.frrapqf[fcryyvq] = gehr
      pag = pag + 1
    raq
  raq
  erghea pag
raq

ybpny snez_fcryyf = {
    [111102]="cynag", -- Cynag Terra Pnoontr
    [123361]="cynag", -- Cynag Whvplpehapu Pneebg
    [123388]="cynag", -- Cynag Fpnyyvbaf
    [123485]="cynag", -- Cynag Zbth Chzcxva
    [123535]="cynag", -- Cynag Erq Oybffbz Yrrx
    [123565]="cynag", -- Cynag Cvax Gheavc
    [123568]="cynag", -- Cynag Juvgr Gheavc
    [123771]="cynag", -- Cynag Tbyqra Frrq
    [123772]="cynag", -- Cynag Frrq bs Unezbal
    [123773]="cynag", -- Cynag Fanxrebbg Frrq
    [123774]="cynag", -- Cynag Ravtzn Frrq
    [123775]="cynag", -- Cynag Zntrohyo Frrq
    [123776]="cynag", -- Cynag Fblorna Frrq
    [123777]="cynag", -- Cynag Bzvabhf Frrq
    [123892]="cynag", -- Cynag Nhghza Oybffbz Fncyvat
    [123893]="cynag", -- Cynag Fcevat Oybffbz Frrq
    [123894]="cynag", -- Cynag Jvagre Oybffbz Fncyvat
    [123895]="cynag", -- Cynag Xlcnevgr Frrq
    [129623]="cynag", -- Cynag Jvaqfurne Pnpghf Frrq
    [129628]="cynag", -- Cynag Encgbeyrns Frrq
    [129863]="cynag", -- Cynag Fbatoryy Frrq
    [129974]="cynag", -- Cynag Jvgpuoreevrf
    [129976]="cynag", -- Cynag Wnqr Fdhnfu
    [129978]="cynag", -- Cynag Fgevcrq Zryba
    [130170]="cynag", -- Cynag Fcevat Oybffbz Fncyvat
    [133036]="cynag", -- Cynag Hafgnoyr Cbegny Funeq

    [116356]="guebj", -- Guebj Terra Pnoontr Frrqf
    [123362]="guebj", -- Guebj Whvplpehapu Pneebg Frrqf
    [123389]="guebj", -- Guebj Fpnyyvba Frrqf
    [123486]="guebj", -- Guebj Zbth Chzcxva Frrqf
    [123537]="guebj", -- Guebj Erq Oybffbz Yrrx Frrqf
    [123566]="guebj", -- Guebj Cvax Gheavc Frrqf
    [123567]="guebj", -- Guebj Juvgr Gheavc Frrqf
    [131093]="guebj", -- Guebj Jvgpuoreel Frrqf
    [131094]="guebj", -- Guebj Wnqr Fdhnfu Frrqf
    [131095]="guebj", -- Guebj Fgevcrq Zryba Frrqf
    [139975]="guebj", -- Guebj Fbatoryy Frrqf
    [139977]="guebj", -- Guebj Fanxrebbg Frrqf
    [139978]="guebj", -- Guebj Ravtzn Frrqf
    [139981]="guebj", -- Guebj Zntrohyo Frrqf
    [139983]="guebj", -- Guebj Jvaqfurne Pnpghf Frrqf
    [139986]="guebj", -- Guebj Encgbeyrns Frrqf

    [111123]="uneirfg", -- Uneirfg Terra Pnoontr
    [115063]="uneirfg", -- Uneirfg RM-Teb Terra Pnoontr
    [123353]="uneirfg", -- Uneirfg Whvplpehapu Pneebg
    [123355]="uneirfg", -- Uneirfg Cyhzc Terra Pnoontr
    [123356]="uneirfg", -- Uneirfg Cyhzc Whvplpehapu Pneebg
    [123375]="uneirfg", -- Uneirfg Fpnyyvbaf
    [123380]="uneirfg", -- Uneirfg Cyhzc Fpnyyvbaf
    [123445]="uneirfg", -- Uneirfg Zbth Chzcxva
    [123451]="uneirfg", -- Uneirfg Cyhzc Zbth Chzcxva
    [123516]="uneirfg", -- Uneirfg Jvagre Oybffbz Gerr
    [123522]="uneirfg", -- Uneirfg Cyhzc Erq Oybffbz Yrrx
    [123524]="uneirfg", -- Uneirfg Erq Oybffbz Yrrx
    [123548]="uneirfg", -- Uneirfg Cvax Gheavc
    [123549]="uneirfg", -- Uneirfg Cyhzc Cvax Gheavc
    [123570]="uneirfg", -- Uneirfg Juvgr Gheavc
    [123571]="uneirfg", -- Uneirfg Cyhzc Juvgr Gheavc
    [129673]="uneirfg", -- Uneirfg Tbyqra Ybghf
    [129674]="uneirfg", -- Uneirfg Sbby\'f Pnc
    [129675]="uneirfg", -- Uneirfg Fabj Yvyl
    [129676]="uneirfg", -- Uneirfg Fvyxjrrq
    [129687]="uneirfg", -- Uneirfg Terra Grn Yrns
    [129705]="uneirfg", -- Uneirfg Enva Cbccl
    [129757]="uneirfg", -- Uneirfg Fanxrebbg
    [129796]="uneirfg", -- Uneirfg Zntrohyo
    [129814]="uneirfg", -- Uneirfg Jvaqfurne Pnpghf
    [129843]="uneirfg", -- Uneirfg Encgbeyrns
    [129887]="uneirfg", -- Uneirfg Fbatoryy
    [129983]="uneirfg", -- Uneirfg Jvgpuoreevrf
    [129984]="uneirfg", -- Uneirfg Cyhzc Jvgpuoreevrf
    [130025]="uneirfg", -- Uneirfg Wnqr Fdhnfu
    [130026]="uneirfg", -- Uneirfg Cyhzc Wnqr Fdhnfu
    [130042]="uneirfg", -- Uneirfg Fgevcrq Zryba
    [130043]="uneirfg", -- Uneirfg Cyhzc Fgevcrq Zryba
    [130109]="uneirfg", -- Uneirfg Greevoyr Gheavc
    [130140]="uneirfg", -- Uneirfg Nhghza Oybffbz Gerr
    [130168]="uneirfg", -- Uneirfg Fcevat Oybffbz Gerr
    [133106]="uneirfg", -- Uneirfg Cbegny Funeq
}

shapgvba pber:erpbeq_snez(fcryyVQ)
  ybpny sg = snez_fcryyf[fcryyVQ]
  vs abg sg gura erghea raq
  ybpny g = inef naq inef.qo.Gbbaf[guvfGbba]
  vs abg g gura erghea raq
  vs sg == "cynag" be sg == "guebj" gura
    ybpny nzg = (sg == "cynag" naq 1 be 4)
    g.SnezCynagrq = (g.SnezCynagrq be 0) + nzg
    g.SnezPebcCynagrq = g.SnezPebcCynagrq be {}
    g.SnezPebcCynagrq[fcryyVQ] = (g.SnezPebcCynagrq[fcryyVQ] be 0) + nzg
  ryfrvs sg == "uneirfg" gura
    vs g.SnezRkcverf naq gvzr() + 60 > g.SnezRkcverf gura -- nffhzr guvf vf n serfu qnl
      g.SnezRkcverf = g.SnezRkcverf - 60
      nqqba:HcqngrGbbaQngn() -- gvpxrg 132: rafher erserfu vs jr'er uneirfgvat evtug nsgre erfrg
    raq
    g.SnezUneirfgrq = (g.SnezUneirfgrq be 0) + 1
    g.SnezPebcErnql = avy
  raq
  g.SnezRkcverf = nqqba:TrgArkgQnvylFxvyyErfrgGvzr()
  qroht("Snez "..sg..": cynagrq="..(g.SnezCynagrq be 0)..
    " uneirfgrq="..(g.SnezUneirfgrq be 0).." rkcverf="..qngr("%p",g.SnezRkcverf be 0))
raq

shapgvba pber:HAVG_FCRYYPNFG_FHPPRRQRQ(rig, havg, fcryyAnzr, enax, yvarVQ, fcryyVQ)
  vs havg ~= "cynlre" gura erghea raq
  vs genqr_fcryyf[fcryyVQ] gura
    qroht("HAVG_FCRYYPNFG_FHPPRRQRQ: %f (%f)",TrgFcryyYvax(fcryyVQ),fcryyVQ)
    vs abg pber:erpbeq_fxvyy(fcryyVQ) gura erghea raq
    pber:FpurqhyrGvzre("GenqrFxvyyErfpna", 0.5, fcryyVQ)
  ryfrvs snez_fcryyf[fcryyVQ] gura
    qroht("HAVG_FCRYYPNFG_FHPPRRQRQ: %f (%f)",TrgFcryyYvax(fcryyVQ),fcryyVQ)
    pber:erpbeq_snez(fcryyVQ)
  raq
raq

shapgvba pber:ObahfEbyyErfhyg(rirag, erjneqGlcr, erjneqYvax, erjneqDhnagvgl, erjneqFcrpVQ)
  ybpny g = inef.qo.Gbbaf[guvfGbba]
  qroht("ObahfEbyyErfhyg:%f:%f:%f:%f (obff=%f|%f)",
    gbfgevat(erjneqGlcr), gbfgevat(erjneqYvax), gbfgevat(erjneqDhnagvgl), gbfgevat(erjneqFcrpVQ),
    gbfgevat(g naq g.ynfgobff), gbfgevat(g naq g.ynfgobfflryy))
  vs abg g gura erghea raq
  vs abg erjneqGlcr gura erghea raq -- fbzrgvzrf trg n obthf zrffntr, vtaber vg
  g.ObahfEbyy = g.ObahfEbyy be {}
  --ybpny erjneqfge = _T["OBAHF_EBYY_ERJNEQ_"..fgevat.hccre(erjneqGlcr)]
  ybpny abj = gvzr()
  ybpny obffanzr = g.ynfgobff
  vs abj > (g.ynfgobffgvzr be 0) + 3*60 gura -- hfre ebyyrq orsber ynfgobff jnf hcqngrq, vtaber gur fgnyr bar. Ebyy gvzrbhg vf 3 zva.
    obffanzr = avy
  raq
  vs abg obffanzr naq g.ynfgobfflryy naq abj < (g.ynfgobfflryygvzr be 0) + 10*60 gura
    obffanzr = g.ynfgobfflryy -- lryy snyyonpx
  raq
  vs abg obffanzr gura
    obffanzr = TrgFhoMbarGrkg() be TrgErnyMbarGrkg() -- mbar snyyonpx
  raq
  ybpny ebyy = { anzr = obffanzr, gvzr = abj, pheeraplVQ = ObahfEbyySenzr.pheeraplVQ }
  vs erjneqGlcr == "zbarl" gura
    ebyy.zbarl = erjneqDhnagvgl
  ryfrvs erjneqGlcr == "negvsnpg_cbjre" gura
    ebyy.zbarl = 25 -- Unpxl naq pyhqtl ohg vg'yy qb sbe abj
    --ebyy.vgrz = erjneqyvax -- Cbffvoyr nygreangvir gb ng yrnfg fubj Negvsnpg Cbjre erjneqrq
  ryfrvs erjneqGlcr == "vgrz" gura
    ebyy.vgrz = erjneqYvax
  raq
  gnoyr.vafreg(g.ObahfEbyy, 1, ebyy)
  ybpny yvzvg = 25
  sbe v=yvzvg+1, gnoyr.znka(g.ObahfEbyy) qb
    g.ObahfEbyy[v] = avy
  raq
raq

shapgvba nqqba.ObahfEbyyFubj()
  ybpny g = inef.qo.Gbbaf[guvfGbba]
  vs abg g be abg ObahfEbyySenzr gura erghea raq
  ybpny ovasb = g.ObahfEbyy
  ybpny senzr = nqqba.ObahfSenzr
  vs abg ovasb be #ovasb == 0 be abg inef.qo.Gbbygvc.NhtzragObahf gura
    vs senzr gura senzr:Uvqr() raq
    erghea
  raq
  vs abg senzr gura
    senzr = PerngrSenzr("Ohggba", "FnirqVafgnaprfObahfEbyySenzr", ObahfEbyySenzr, "FcryyObbxFxvyyYvarGnoGrzcyngr")
    nqqba.ObahfSenzr = senzr
    --senzr:FrgFvmr(ObahfEbyySenzr:TrgUrvtug(), ObahfEbyySenzr:TrgUrvtug())
    senzr:FrgCbvag("YRSG", ObahfEbyySenzr, "EVTUG",0,8)
    senzr.grkg = nqqba.ObahfSenzr:PerngrSbagFgevat(avy, "BIREYNL","TnzrSbagAbezny")
    senzr.grkg:FrgCbvag("PRAGRE")
    senzr:FrgFpevcg("BaRagre", shapgvba() FubjObahfGbbygvc(avy, { guvfGbba, senzr }) raq )
    senzr:FrgFpevcg("BaYrnir", PybfrGbbygvcf)
    senzr:FrgFpevcg("BaPyvpx", avy)
    senzr.grkg:Fubj()
  raq
  ybpny obahf = 0
  sbe _,evasb va vcnvef(ovasb) qb
    vs evasb.zbarl gura
      obahf = obahf + 1
    ryfr
      oernx
    raq
  raq
  senzr.grkg:FrgGrkg((obahf > 0 naq "+" be "")..obahf)
  senzr:Fubj()
raq

ubbxfrphershap("ObahfEbyySenzr_FgnegObahfEbyy", nqqba.ObahfEbyyFubj)
